
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIALHUB â€” Signal Protocol v18</title>

    <!-- 1. Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <!-- 2. Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
            authDomain: "socialhub-33014.firebaseapp.com",
            projectId: "socialhub-33014",
            storageBucket: "socialhub-33014.firebasestorage.app",
            messagingSenderId: "864088350104",
            appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
            measurementId: "G-B2C1K1LVGQ"
        };
        const app     = initializeApp(firebaseConfig);
        const db      = getFirestore(app);
        const storage = getStorage(app);
        window.db  = db;
        window.storage = storage;
        window.fs  = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc };
        window.fsStorage = { ref, uploadBytesResumable, getDownloadURL };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CSS VARIABLES & RESET
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --bg-outer:    #0d1117;
            --bg-app:      #161b27;
            --bg-panel:    #1c2333;
            --bg-card:     #222a3a;
            --bg-card2:    #1e2638;
            --bg-input:    #151c2c;
            --bg-hover:    #263046;
            --border:      rgba(255,255,255,0.07);
            --border-md:   rgba(255,255,255,0.11);
            --purple:      #7c5cbf;
            --purple-lt:   #9b7de0;
            --purple-dim:  rgba(124,92,191,0.18);
            --purple-glow: rgba(124,92,191,0.08);
            --teal:        #2dd4bf;
            --teal-dim:    rgba(45,212,191,0.12);
            --gold:        #f0b429;
            --green:       #3ecf8e;
            --red:         #f87171;
            --text-primary:   #e8ecf4;
            --text-secondary: #8892a4;
            --text-muted:     #4e5a6e;
            --text-white:     #ffffff;
            --glow-warm: rgba(160,60,40,0.18);
            --glow-teal: rgba(30,80,100,0.22);
            --radius-sm:  8px;
            --radius-md:  12px;
            --radius-lg:  16px;
            --font-body: 'Sora', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --bottom-nav-h: 62px;
            --sidebar-w:  210px;
            --rp-w:       250px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESKTOP LAYOUT â€” FULL BROWSER WIDTH (V11 FIX)
           Removed max-width. App fills 100% of viewport on desktop.
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        body {
            font-family: var(--font-body);
            background: var(--bg-outer);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background:
                radial-gradient(ellipse 55% 45% at 0% 0%,   var(--glow-warm) 0%, transparent 65%),
                radial-gradient(ellipse 45% 55% at 100% 100%, var(--glow-teal) 0%, transparent 65%),
                radial-gradient(ellipse 30% 30% at 50% 50%,  rgba(20,28,50,0.6) 0%, transparent 100%);
        }

        body::after {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            opacity: 0.18;
            background-image: radial-gradient(circle, rgba(100,120,180,0.4) 1px, transparent 1px);
            background-size: 28px 28px;
        }

        /* App shell: full width, full height, no border-radius on desktop */
        #app-shell {
            position: relative; z-index: 5;
            width: 100vw;
            height: 100vh;
            background: var(--bg-app);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â”€â”€ TOP NAV â”€â”€ */
        #topnav {
            height: 60px; flex-shrink: 0;
            display: flex; align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            gap: 16px;
            z-index: 10;
        }
        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.1rem; font-weight: 700;
            color: var(--text-white); letter-spacing: -0.3px;
        }
        .brand-icon {
            width: 30px; height: 30px; border-radius: 8px;
            background: var(--purple-dim);
            border: 1px solid rgba(124,92,191,0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .topnav-mid { flex-grow: 1; }
        .topnav-right { display: flex; align-items: center; gap: 12px; }
        .user-pill {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 14px 6px 6px;
            border-radius: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .user-pill img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .user-pill-name { font-size: 0.78rem; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .user-pill-sub  { font-size: 0.65rem; color: var(--text-secondary); }
        #wallet-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            background: transparent;
            border: 1px solid var(--border-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.78rem; font-weight: 600;
            cursor: pointer;
            transition: all 0.18s;
            white-space: nowrap;
        }
        #wallet-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); background: var(--purple-glow); }
        .wallet-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--teal); flex-shrink: 0; }

        /* â”€â”€ BODY LAYOUT â€” 3-column, feed stretches â”€â”€ */
        #body-layout {
            flex-grow: 1;
            display: grid;
            /* V11: feed column is 1fr â€” stretches between fixed sidebars */
            grid-template-columns: var(--sidebar-w) 1fr var(--rp-w);
            overflow: hidden;
            min-height: 0;
        }

        /* â”€â”€ LEFT SIDEBAR â”€â”€ */
        #sidebar {
            border-right: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex; flex-direction: column;
            padding: 16px 10px;
            overflow-y: auto;
            min-width: 0;
        }
        .nav-item {
            display: flex; align-items: center; gap: 11px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.82rem; font-weight: 500;
            transition: all 0.15s;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .nav-icon { font-size: 0.95rem; width: 18px; text-align: center; flex-shrink: 0; opacity: 0.85; }
        .nav-badge {
            margin-left: auto;
            font-family: var(--font-mono);
            font-size: 0.58rem; font-weight: 600;
            color: var(--purple-lt);
            background: var(--purple-dim);
            border-radius: 50px; padding: 2px 7px;
            white-space: nowrap;
        }
        .sidebar-section { margin-top: 16px; margin-bottom: 6px; }
        .sidebar-section-label {
            font-size: 0.6rem; font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 1.5px; text-transform: uppercase;
            padding: 0 12px; margin-bottom: 6px;
        }
        .sidebar-vault {
            padding: 14px;
            background: var(--bg-card2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-top: 12px;
        }
        .vault-label { font-size: 0.58rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 3px; }
        .vault-stars { font-family: var(--font-mono); font-size: 1.3rem; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
        .vault-aptm  { font-size: 0.72rem; color: var(--teal); font-weight: 600; margin-bottom: 2px; }
        .vault-rate  { font-family: var(--font-mono); font-size: 0.58rem; color: var(--text-muted); }

        /* â”€â”€ FEED COLUMN â€” stretches to fill all space â”€â”€ */
        #feed-col {
            overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 14px;
            min-width: 0; /* critical for proper flex/grid shrink */
        }
        #feed-col::-webkit-scrollbar { width: 3px; }
        #feed-col::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }
        .feed-heading { font-size: 1rem; font-weight: 700; color: var(--text-white); margin-bottom: 4px; }

        /* â”€â”€ CARDS â”€â”€ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            transition: border-color 0.15s;
        }
        .card:hover { border-color: var(--border-md); }

        .composer-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .av { width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border-md); object-fit: cover; flex-shrink: 0; }
        .composer-name { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .composer-sub  { font-size: 0.65rem; color: var(--text-secondary); }

        .field {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            padding: 10px 14px;
            outline: none;
            resize: none;
            transition: border-color 0.15s;
            margin-top: 8px;
        }
        .field:focus { border-color: rgba(124,92,191,0.4); }
        .field::placeholder { color: var(--text-muted); }

        /* Media tabs */
        .media-tabs { display: flex; gap: 6px; margin-top: 10px; }
        .mtab {
            flex: 1; padding: 7px; border-radius: var(--radius-sm);
            font-size: 0.72rem; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border); color: var(--text-secondary);
            background: transparent; text-align: center;
            transition: all 0.13s;
        }
        .mtab.active { color: var(--purple-lt); border-color: rgba(124,92,191,0.35); background: var(--purple-dim); }

        .upload-zone {
            border: 1.5px dashed rgba(124,92,191,0.3);
            border-radius: var(--radius-md);
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            position: relative;
            transition: all 0.18s;
            background: rgba(124,92,191,0.04);
        }
        .upload-zone:hover { border-color: var(--purple-lt); background: var(--purple-dim); }
        .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .upload-zone-text { font-size: 0.78rem; color: var(--text-secondary); pointer-events: none; }
        .upload-zone-text strong { display: block; color: var(--purple-lt); font-size: 0.82rem; margin-bottom: 3px; }

        /* Upload Progress Bar */
        #upload-progress-wrap { display: none; margin-top: 10px; }
        .progress-label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.68rem; color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .progress-label span { font-family: var(--font-mono); color: var(--purple-lt); font-weight: 600; }
        .progress-track {
            width: 100%; height: 6px;
            background: var(--bg-input);
            border-radius: 99px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-bar {
            height: 100%; width: 0%;
            border-radius: 99px;
            background: linear-gradient(90deg, var(--purple), var(--teal));
            transition: width 0.2s ease;
            box-shadow: 0 0 8px rgba(124,92,191,0.5);
        }
        .progress-status { font-size: 0.64rem; color: var(--text-muted); margin-top: 5px; font-family: var(--font-mono); }

        .fee-display { font-family: var(--font-mono); font-size: 0.62rem; color: var(--text-muted); text-align: right; margin-top: 6px; }

        /* Buttons */
        .btn {
            padding: 9px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-family: var(--font-body);
            font-weight: 600; font-size: 0.82rem;
            cursor: pointer; transition: all 0.16s;
        }
        .btn-purple { background: var(--purple); color: #fff; width: 100%; margin-top: 12px; }
        .btn-purple:hover { background: var(--purple-lt); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,92,191,0.3); }
        .btn-outline { background: transparent; border: 1px solid var(--border-md); color: var(--text-secondary); width: 100%; margin-top: 10px; }
        .btn-outline:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        .btn-sm { padding: 6px 13px; font-size: 0.75rem; border-radius: var(--radius-sm); }
        .btn-teal { background: var(--teal); color: #0d1117; font-weight: 700; }
        .btn-teal:hover { filter: brightness(1.08); }
        .btn-gold {
            background: linear-gradient(135deg, rgba(240,180,41,0.2), rgba(240,180,41,0.08));
            border: 1px solid rgba(240,180,41,0.4);
            color: var(--gold);
            font-weight: 700;
        }
        .btn-gold:hover { background: rgba(240,180,41,0.18); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(240,180,41,0.15); }

        /* Post cards */
        .post-card { animation: fadeUp 0.25s ease both; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .post-meta { flex-grow: 1; }
        .post-author { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .post-addr   { font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .post-more   { color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px 8px; border-radius: 6px; }
        .post-more:hover { background: var(--bg-hover); color: var(--text-primary); }
        .boosted-badge {
            font-family: var(--font-mono); font-size: 0.58rem; font-weight: 700;
            background: rgba(240,180,41,0.1); border: 1px solid rgba(240,180,41,0.3);
            color: var(--gold); padding: 2px 9px; border-radius: 50px;
        }
        .post-body  { font-size: 0.88rem; line-height: 1.6; color: var(--text-primary); margin-bottom: 12px; }
        .post-media {
            width: 100%; border-radius: var(--radius-md); overflow: hidden;
            margin-bottom: 12px; background: #000;
            max-height: 360px;
            display: flex; justify-content: center;
            border: 1px solid var(--border);
        }
        .post-media img  { width: 100%; max-height: 360px; object-fit: cover; display: block; }
        .post-media iframe { width: 100%; height: 280px; border: none; }

        .firebase-tag {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.58rem;
            background: rgba(255,160,0,0.1); border: 1px solid rgba(255,160,0,0.25);
            color: #ffb300; padding: 2px 8px; border-radius: 4px;
            margin-bottom: 8px;
        }
        .a-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--purple-lt); animation: blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.2;} }

        .post-actions {
            display: flex; align-items: center; gap: 4px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .pact {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 50px;
            font-size: 0.76rem; font-weight: 500;
            cursor: pointer; color: var(--text-secondary);
            background: transparent; border: 1px solid transparent;
            transition: all 0.13s;
        }
        .pact:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .pact.boost:hover { color: var(--gold); border-color: rgba(240,180,41,0.3); background: rgba(240,180,41,0.06); }
        .pact-num { font-family: var(--font-mono); font-size: 0.7rem; }

        /* â”€â”€ V17 COMMENT SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .comment-tray { display: none; padding-top: 14px; border-top: 1px dashed rgba(255,255,255,0.05); margin-top: 12px; }
        .comment-list { max-height: 430px; overflow-y: auto; margin-bottom: 10px; }
        .comment-list::-webkit-scrollbar { width: 2px; }
        .comment-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.07); }

        /* Dark block â€” every comment and reply */
        .cmt-row {
            padding: 10px 12px 8px;
            border-radius: var(--radius-md);
            background: var(--bg-input);
            border: 1px solid var(--border);
            margin-bottom: 6px;
            font-size: 0.82rem;
            color: var(--text-primary);
            line-height: 1.5;
        }
        .cmt-row.nested {
            margin-left: 18px;
            border-left: 2px solid rgba(124,92,191,0.3);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            background: rgba(16,22,40,0.95);
        }
        .cmt-body-line { margin-bottom: 6px; line-height: 1.5; word-break: break-word; }
        .cmt-author { color: var(--gold); font-weight: 700; }
        .cmt-text   { color: var(--text-primary); }

        /* Like / Reply micro-buttons */
        .cmt-meta { display: flex; gap: 8px; margin-top: 6px; flex-wrap: wrap; align-items: center; }
        .cbtn {
            font-size: 0.68rem; font-weight: 600; cursor: pointer;
            padding: 3px 9px; border-radius: 5px;
            border: 1px solid var(--border); color: var(--text-muted);
            background: transparent; transition: all 0.12s;
            user-select: none; line-height: 1.4;
        }
        .cbtn:hover { color: var(--teal); border-color: rgba(45,212,191,0.3); background: rgba(45,212,191,0.05); }
        .cbtn.reply:hover { color: var(--purple-lt); border-color: rgba(124,92,191,0.35); background: var(--purple-glow); }

        /* Inline reply box â€” visible white border per V17 spec */
        .reply-area {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(12,17,32,0.85);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: var(--radius-md);
        }
        .reply-textarea {
            display: block;
            width: 100%;
            min-height: 56px;
            background: var(--bg-card2);
            border: 1.5px solid rgba(255,255,255,0.22);   /* V17: white border */
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.8rem;
            padding: 9px 12px;
            outline: none;
            resize: none;
            box-sizing: border-box;
            transition: border-color 0.15s, box-shadow 0.15s;
            margin-bottom: 8px;
        }
        .reply-textarea:focus {
            border-color: rgba(155,125,224,0.65);
            box-shadow: 0 0 0 2px rgba(124,92,191,0.12);
        }
        .reply-textarea::placeholder { color: var(--text-muted); }
        .reply-send-row { display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
        .reply-send-row .cost-hint { font-size: 0.6rem; color: var(--text-muted); font-family: var(--font-mono); }

        .cmt-input-row { display: flex; gap: 8px; align-items: center; }
        .cmt-input-row .field { margin-top: 0; flex: 1; }
        .close-comments-btn {
            display: block; width: 100%;
            padding: 7px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 0.72rem; font-weight: 600;
            cursor: pointer; text-align: center;
            margin-top: 10px; transition: all 0.13s;
        }
        .close-comments-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); background: var(--purple-glow); }

        /* Right panel */
        #right-panel {
            border-left: 1px solid var(--border);
            background: var(--bg-panel);
            overflow-y: auto;
            padding: 16px 14px;
            display: flex; flex-direction: column; gap: 14px;
            min-width: 0;
        }
        #right-panel::-webkit-scrollbar { width: 3px; }
        #right-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .rp-heading {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; font-weight: 700; color: var(--text-white);
            margin-bottom: 10px;
        }
        .rp-card { background: var(--bg-card2); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 14px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-label span { display: block; font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
        .stat-val { font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700; color: var(--text-white); }
        .stat-val.gold   { color: var(--gold); }
        .stat-val.teal   { color: var(--teal); }
        .stat-val.purple { color: var(--purple-lt); }
        .stat-val.green  { color: var(--green); }

        /* Ledger */
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); gap: 8px; }
        .ledger-row:last-child { border-bottom: none; }
        .ledger-desc { font-size: 0.75rem; color: var(--text-secondary); flex: 1; line-height: 1.4; }
        .ledger-desc small { display: block; font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .ledger-badge { font-family: var(--font-mono); font-size: 0.52rem; font-weight: 700; padding: 2px 7px; border-radius: 4px; text-transform: uppercase; width: 58px; text-align: center; flex-shrink: 0; }
        .ledger-badge.earn    { background: rgba(62,207,142,0.12); color: var(--green); }
        .ledger-badge.spend   { background: rgba(248,113,113,0.12); color: var(--red); }
        .ledger-badge.deposit { background: var(--teal-dim); color: var(--teal); }
        .ledger-badge.settle  { background: var(--purple-dim); color: var(--purple-lt); }
        .ledger-amount { font-family: var(--font-mono); font-size: 0.76rem; font-weight: 700; width: 58px; text-align: right; flex-shrink: 0; }
        .ledger-amount.earn    { color: var(--green); }
        .ledger-amount.spend   { color: var(--red); }
        .ledger-amount.neutral { color: var(--text-muted); }
        .ledger-empty { font-size: 0.72rem; color: var(--text-muted); padding: 14px 0; text-align: center; }

        /* Admin panel â€” hidden by default */
        #admin-revenue-panel { display: none; }
        #admin-withdraw-btn {
            display: inline-flex; align-items: center; gap: 8px;
            margin-top: 12px; padding: 9px 18px;
            background: linear-gradient(135deg, rgba(240,180,41,0.2), rgba(240,180,41,0.08));
            border: 1px solid rgba(240,180,41,0.4);
            border-radius: var(--radius-md);
            color: var(--gold);
            font-family: var(--font-body); font-size: 0.8rem; font-weight: 700;
            cursor: pointer; transition: all 0.18s; letter-spacing: 0.3px;
        }
        #admin-withdraw-btn:hover { background: rgba(240,180,41,0.18); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(240,180,41,0.15); }

        /* Tokenomics */
        .tok-section { font-family: var(--font-mono); font-size: 0.56rem; color: var(--gold); letter-spacing: 2.5px; text-transform: uppercase; margin: 18px 0 8px; font-weight: 700; }
        .tok-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 0.84rem; }
        .tok-row:last-of-type { border-bottom: none; }
        .tok-label { color: var(--text-secondary); }
        .tok-value { font-family: var(--font-mono); font-weight: 700; color: var(--purple-lt); font-size: 0.8rem; }

        /* Page system */
        .page { display: none; }
        .page.active { display: contents; }
        #page-home { display: contents; }

        /* Misc */
        .hidden-post { display: none !important; }
        #load-more-btn { display: none; background: transparent; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; width: 100%; margin-top: 4px; }
        #load-more-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        #media-preview-container { display: none; margin-top: 10px; border-radius: var(--radius-md); overflow: hidden; background: #000; border: 1px solid var(--border); }
        #preview-img { max-width: 100%; max-height: 200px; display: block; margin: 0 auto; }
        .page-heading { font-size: 1.1rem; font-weight: 700; color: var(--text-white); margin-bottom: 14px; }
        .page-heading span { color: var(--purple-lt); }
        .info-box { padding: 12px 14px; background: var(--purple-dim); border: 1px solid rgba(124,92,191,0.2); border-radius: var(--radius-md); font-size: 0.78rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 14px; }
        .info-box strong { color: var(--purple-lt); }
        .balance-note { font-size: 0.62rem; color: var(--text-muted); margin-top: 2px; }

        /* Sparkline */
        .sparkline { height: 50px; border-radius: var(--radius-sm); background: var(--bg-input); margin: 10px 0 4px; position: relative; overflow: hidden; }
        .sparkline::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--purple-lt), var(--teal), transparent); opacity: 0.4; }
        .sparkline-line { position: absolute; bottom: 10px; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, var(--purple-lt), var(--teal)); clip-path: polygon(0 60%, 15% 30%, 30% 55%, 45% 20%, 60% 40%, 75% 15%, 90% 35%, 100% 25%, 100% 100%, 0 100%); }

        /* â”€â”€ V18: Low-Liquidity Vault Warning â”€â”€ */
        #vault-liquidity-warning {
            display: none;
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(248,113,113,0.08);
            border: 1px solid rgba(248,113,113,0.35);
            border-radius: var(--radius-md);
            font-size: 0.78rem;
            color: var(--red);
            font-family: var(--font-mono);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .btn-purple:disabled,
        .btn-teal:disabled {
            opacity: 0.38;
            cursor: not-allowed;
            pointer-events: none;
            transform: none !important;
            box-shadow: none !important;
        }

        /* â”€â”€ V18: Persistent Comment Input (always visible) â”€â”€ */
        .cmt-persistent-box {
            width: 100%;
            min-height: 56px;
            background: var(--bg-input);
            border: 1px solid rgba(255,255,255,1);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.8rem;
            padding: 9px 12px;
            outline: none;
            resize: none;
            box-sizing: border-box;
            transition: border-color 0.15s, box-shadow 0.15s;
            margin-bottom: 8px;
            display: block;
        }
        .cmt-persistent-box:focus {
            border-color: rgba(155,125,224,0.75);
            box-shadow: 0 0 0 2px rgba(124,92,191,0.15);
        }
        .cmt-persistent-box::placeholder { color: var(--text-muted); }

        /* Toast */
        #toast {
            position: fixed; bottom: 22px; right: 22px; z-index: 9999;
            background: var(--bg-card);
            border: 1px solid rgba(124,92,191,0.35);
            color: var(--purple-lt);
            font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
            padding: 10px 20px; border-radius: var(--radius-md);
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            transform: translateY(8px); letter-spacing: 0.4px;
        }
        #toast.show { opacity: 1; transform: translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE WALLET DRAWER (V11 NEW)
           Full-screen slide-up overlay triggered from bottom nav Wallet icon
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #wallet-drawer {
            display: none; /* toggled by JS */
            position: fixed;
            inset: 0;
            z-index: 200;
        }
        #wallet-drawer.open { display: flex; flex-direction: column; }

        /* Dark backdrop behind the drawer panel */
        #wallet-drawer-backdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
        }

        /* The sliding panel itself */
        #wallet-drawer-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            max-height: 92vh;
            background: var(--bg-app);
            border-radius: 24px 24px 0 0;
            border-top: 1px solid var(--border-md);
            display: flex; flex-direction: column;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.32s cubic-bezier(0.32, 0.72, 0, 1);
        }
        #wallet-drawer.open #wallet-drawer-panel {
            transform: translateY(0);
        }

        /* Sticky back button at top of drawer */
        #drawer-back-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            cursor: pointer;
            font-size: 0.82rem; font-weight: 700;
            color: var(--text-primary);
            border: none; width: 100%; text-align: left;
            letter-spacing: 0.2px;
        }
        #drawer-back-btn:hover { background: var(--bg-hover); }
        #drawer-back-btn span { font-size: 1rem; }

        /* Scrollable content area of drawer */
        #wallet-drawer-content {
            overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 16px;
            flex-grow: 1;
        }
        #wallet-drawer-content::-webkit-scrollbar { width: 3px; }
        #wallet-drawer-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }

        /* Drawer section headers */
        .drawer-section-label {
            font-family: var(--font-mono); font-size: 0.56rem;
            color: var(--text-muted); letter-spacing: 2px;
            text-transform: uppercase; font-weight: 700;
            margin-bottom: 8px;
        }

        /* Big star balance display in drawer */
        .drawer-stars-display {
            font-family: var(--font-mono);
            font-size: 3rem; font-weight: 700;
            color: var(--gold);
            line-height: 1; margin-bottom: 4px;
        }
        .drawer-price-display {
            font-size: 0.78rem; color: var(--teal);
            font-family: var(--font-mono); font-weight: 600;
        }

        /* Admin section in drawer */
        #drawer-admin-section { display: none; }
        .drawer-admin-header {
            display: flex; align-items: center; gap: 8px;
            font-family: var(--font-mono); font-size: 0.6rem;
            color: var(--gold); letter-spacing: 2px; text-transform: uppercase;
            font-weight: 700; margin-bottom: 12px;
        }
        .drawer-revenue-num {
            font-family: var(--font-mono); font-size: 1.8rem; font-weight: 700;
            color: var(--teal); margin-bottom: 4px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE RESPONSIVE â€” < 768px  (V10 + V11 additions)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            /* Hide sidebars on mobile */
            #sidebar, #right-panel { display: none !important; }

            #body-layout { grid-template-columns: 1fr; }

            #feed-col {
                padding: 12px;
                padding-bottom: calc(var(--bottom-nav-h) + 20px);
            }

            /* Edge-to-edge media on mobile */
            .post-card {
                padding: 14px 0;
                background: transparent;
                border: none;
                border-bottom: 1px solid var(--border);
                border-radius: 0;
            }
            .post-card .post-header,
            .post-card .post-body,
            .post-card .post-actions,
            .post-card .comment-tray {
                padding-left: 14px;
                padding-right: 14px;
            }
            .post-media {
                width: 100%; max-height: none;
                border-radius: 0;
                border-left: none; border-right: none;
                margin-bottom: 12px;
            }
            .post-media img { max-height: 60vw; }
            .post-media iframe { height: 56vw; }
            .card { border-radius: var(--radius-md); }

            /* Top nav compact */
            #topnav { padding: 0 14px; }
            .user-pill-name { display: none; }
            .user-pill-sub  { display: none; }
            .user-pill { padding: 5px; }

            /* Show bottom nav */
            #bottom-nav { display: flex; }

            /* Toast above bottom nav */
            #toast { bottom: calc(var(--bottom-nav-h) + 14px); }

            /* Show wallet drawer on mobile */
            #wallet-drawer { display: none; }
            #wallet-drawer.open { display: flex; }
        }

        /* â”€â”€ BOTTOM NAVIGATION BAR (mobile only) â”€â”€ */
        #bottom-nav {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-h);
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            z-index: 100;
            align-items: stretch;
        }
        .bnav-item {
            flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 3px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.55rem; font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.15s;
            border: none; background: transparent;
            text-transform: uppercase;
        }
        .bnav-item .bnav-icon { font-size: 1.15rem; }
        .bnav-item.active { color: var(--purple-lt); }
        .bnav-item:hover  { color: var(--text-primary); }
        .bnav-post {
            background: var(--purple);
            color: #fff !important;
            border-radius: 14px;
            margin: 8px 6px;
            flex: 1.1;
        }
        .bnav-post:hover { background: var(--purple-lt); }
        .bnav-wallet { }
        .bnav-wallet.active { color: var(--teal); }
    </style>
</head>
<body>

<div id="app-shell">

    <!-- TOP NAV -->
    <div id="topnav">
        <div class="brand">
            <div class="brand-icon">â—ˆ</div>
            SOCIALHUB
        </div>
        <div class="topnav-mid"></div>
        <div class="topnav-right">
            <div class="user-pill">
                <img id="nav-avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                <div>
                    <div class="user-pill-name" id="nav-handle">Anonymous</div>
                    <div class="user-pill-sub">Creator</div>
                </div>
            </div>
            <button id="wallet-btn" onclick="connectWallet()">
                <span class="wallet-dot"></span>
                <span id="wallet-status">Connect Wallet</span>
            </button>
        </div>
    </div>

    <!-- BODY LAYOUT -->
    <div id="body-layout">

        <!-- LEFT SIDEBAR -->
        <div id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-section-label">Navigation</div>
                <div class="nav-item active" id="nav-home" onclick="switchPage('home', this)"><span class="nav-icon">âŠ</span> Home Feed</div>
                <div class="nav-item" id="nav-earnings" onclick="switchPage('earnings', this)">
                    <span class="nav-icon">â—†</span> Creator Studio
                    <span class="nav-badge" id="sidebar-stars-badge">0 â˜…</span>
                </div>
                <div class="nav-item" id="nav-profile" onclick="switchPage('profile', this)"><span class="nav-icon">â—‰</span> My Profile</div>
                <div class="nav-item" id="nav-info" onclick="switchPage('info', this)"><span class="nav-icon">â—</span> Tokenomics</div>
            </div>
            <div class="sidebar-vault">
                <div class="vault-label">Total Spendable â˜…</div>
                <div class="vault-stars" id="user-stars">0 â˜…</div>
                <div style="font-size:0.58rem; color:var(--text-muted); margin-bottom:8px; line-height:1.6;">
                    Purchased: <span style="color:var(--gold); font-family:var(--font-mono);" id="sidebar-purchased-stars">0</span> â˜… &nbsp;|&nbsp;
                    Earned: <span style="color:var(--green); font-family:var(--font-mono);" id="sidebar-earned-stars">0</span> â˜…
                </div>
                <div class="vault-label" style="margin-top:4px;">APTM Vault</div>
                <div class="vault-aptm" id="sidebar-aptm-value">0.0000 $APTM</div>
                <div class="vault-rate" id="live-price-display">$0.3391 / APTM</div>
                <button class="btn btn-purple btn-sm" style="margin-top:12px; width:100%; font-size:0.72rem;" onclick="convertAPTM()">DEPOSIT $APTM</button>
            </div>
            <div style="padding: 10px 0 4px; border-top: 1px solid var(--border); margin-top: 12px;">
                <div class="vault-label" style="padding:0 2px; margin-bottom:4px;">Total Anchors</div>
                <div style="font-family:var(--font-mono); font-size:0.9rem; font-weight:700; color:var(--text-white);" id="total-anchors-display">0</div>
            </div>
        </div>

        <!-- FEED COLUMN â€” stretches via 1fr in grid -->
        <div id="feed-col">

            <!-- HOME PAGE -->
            <div id="page-home" style="display:contents;">
                <div class="feed-heading">Signal Feed</div>

                <!-- Compose -->
                <div class="card" id="composer-card" style="border-color: rgba(124,92,191,0.25);">
                    <div class="composer-row">
                        <img id="pb-avatar" class="av" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                        <div>
                            <div class="composer-name" id="pb-handle">Anonymous_Creator</div>
                            <div class="composer-sub">Broadcasting to the network</div>
                        </div>
                    </div>

                    <textarea id="post-text" class="field" style="min-height:64px;" placeholder="What's your signal?"></textarea>

                    <div class="media-tabs">
                        <div class="mtab active" id="tab-url"  onclick="setMediaTab('url')">ğŸ”— URL</div>
                        <div class="mtab"        id="tab-file" onclick="setMediaTab('file')">â˜ Firebase Upload</div>
                    </div>

                    <div id="url-input-wrap">
                        <input type="text" id="post-media" class="field" placeholder="Image URL (3.0â˜…) Â· Video URL (10.0â˜…)" oninput="updatePreview(this.value)">
                        <div id="media-preview-container"><img id="preview-img" src=""></div>
                    </div>

                    <div id="file-input-wrap" style="display:none;">
                        <div class="upload-zone">
                            <input type="file" id="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                            <div class="upload-zone-text">
                                <strong>â†‘ Click or drop to upload</strong>
                                Stored on <span style="color:#ffb300;">Firebase Storage</span>.<br>
                                <span style="font-size:0.68rem; color:var(--text-muted);">No MetaMask required.</span>
                            </div>
                        </div>
                        <div id="file-preview-wrap" style="display:none; margin-top:10px;">
                            <img   id="file-preview-img" style="max-width:100%; border-radius:10px; display:none;">
                            <video id="file-preview-vid" controls style="max-width:100%; border-radius:10px; display:none;"></video>
                            <div id="file-info" style="font-size:0.7rem; color:var(--text-muted); margin-top:5px;"></div>
                        </div>
                    </div>

                    <div id="upload-progress-wrap">
                        <div class="progress-label">
                            <span id="progress-label-text">Uploadingâ€¦</span>
                            <span id="progress-pct">0%</span>
                        </div>
                        <div class="progress-track"><div class="progress-bar" id="progress-bar"></div></div>
                        <div class="progress-status" id="progress-status">Preparingâ€¦</div>
                    </div>

                    <div class="fee-display" id="post-fee-display"></div>
                    <div id="vault-liquidity-warning">âš  Low Liquidity â€” Vault holds 0 APTM. Broadcast & Post disabled until funded.</div>
                    <button class="btn btn-purple" id="broadcast-btn" onclick="handleBroadcast()">â—ˆ Broadcast Signal</button>
                </div>

                <div id="feed-items"></div>
                <button id="load-more-btn" class="btn" onclick="showNextPage()">Load More Signals</button>
            </div>

            <!-- CREATOR STUDIO PAGE -->
            <div id="page-earnings" class="page">
                <div class="page-heading">Creator <span>Studio</span></div>

                <div class="card">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">Total Spendable Stars</div>
                            <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold);" id="creator-revenue-display">0 â˜…</div>
                            <div class="balance-note" style="margin-top:4px;">
                                <span style="color:var(--gold);" id="studio-purchased-stars">0</span> purchased &nbsp;+&nbsp;
                                <span style="color:var(--green);" id="studio-earned-stars">0</span> earned
                            </div>
                        </div>
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">APTM Vault</div>
                            <div style="font-family:var(--font-mono); font-size:0.95rem; font-weight:700; color:var(--teal); margin-top:6px;" id="earnings-aptm-value">0.0000 $APTM</div>
                            <div class="balance-note">ğŸ”’ On-chain</div>
                        </div>
                    </div>
                    <div class="info-box">
                        <strong>How it works:</strong> Stars power instant interactions on the internal ledger. Click <strong>Settle Total Balance to Wallet</strong> to convert your <strong>entire</strong> balance â€” both purchased and earned stars â€” into $APTM at the live price. Both balances are wiped to zero after the transaction mines.
                    </div>
                    <button class="btn btn-teal" style="width:auto; padding:10px 24px;" onclick="settleStarsToWallet()">Settle Total Balance to Wallet â†’</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--text-white);">Recent Activity</div>
                        <div style="font-size:0.62rem; color:var(--text-muted);">Last 10 transactions</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding-bottom:7px; border-bottom:1px solid var(--border); margin-bottom:4px;">
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; flex:1;">Description</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:center;">Type</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:right;">Amount</span>
                    </div>
                    <div id="ledger-list"><div class="ledger-empty">Connect wallet to view history.</div></div>
                </div>

                <!-- ADMIN PANEL â€” visible only to admin wallet -->
                <div class="card" id="admin-revenue-panel" style="border-color:rgba(240,180,41,0.2);">
                    <div style="font-family:var(--font-mono); font-size:0.58rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; font-weight:700; margin-bottom:4px;">ğŸ” Platform Revenue â€” Admin</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-bottom:12px;">100% of post fees + 20% of all interactions</div>
                    <div style="font-size:0.68rem; color:var(--text-secondary); margin-bottom:2px;">Total Platform Revenue</div>
                    <div style="font-family:var(--font-mono); font-size:2rem; font-weight:700; color:var(--teal);" id="admin-revenue-display">0 â˜…</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-top:4px;" id="admin-revenue-count">0 fee events</div>
                    <button id="admin-withdraw-btn" onclick="adminWithdraw()">â¬‡ Withdraw to Admin Wallet</button>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="page-profile" class="page">
                <div class="page-heading">My <span>Identity</span></div>
                <div class="card">
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:14px;">Set your display name and avatar URL. Saved locally, shown on all broadcasts.</div>
                    <input type="text" id="handle-input" class="field" placeholder="@Username" style="margin-top:0;">
                    <input type="text" id="avatar-input" class="field" placeholder="Avatar Image URL">
                    <button class="btn btn-purple" onclick="saveProfile()">Sync Identity</button>
                </div>
            </div>

            <!-- TOKENOMICS PAGE -->
            <div id="page-info" class="page">
                <div class="page-heading">Token<span>omics</span></div>
                <div class="card">
                    <div class="tok-section">Broadcast Costs (100% Admin Revenue)</div>
                    <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Boost to Top</span><span class="tok-value">10.0 â˜…</span></div>
                    <div class="tok-section">Interaction Costs</div>
                    <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Comment / Reply</span><span class="tok-value">1.0 â˜…</span></div>
                    <div class="tok-section">Creator Rewards (80% split)</div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Post</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Comment on Post</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Comment</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Reply</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-section">Media Storage</div>
                    <div class="tok-row"><span class="tok-label">Provider</span><span class="tok-value" style="color:#ffb300;">Firebase Storage</span></div>
                    <div class="tok-row"><span class="tok-label">No MetaMask for Upload</span><span class="tok-value" style="color:var(--green);">âœ“ Zero Popups</span></div>
                    <div class="tok-row"><span class="tok-label">MetaMask Only For</span><span class="tok-value" style="color:var(--text-white);">Deposit / Withdraw / Register</span></div>
                </div>
            </div>

        </div><!-- /feed-col -->

        <!-- RIGHT PANEL -->
        <div id="right-panel">
            <div class="rp-card">
                <div class="rp-heading">Star Balance</div>
                <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold); margin-bottom:2px;" id="rp-stars">0 â˜…</div>
                <div style="font-size:0.7rem; color:var(--text-muted);">Spending power</div>
                <div class="sparkline"><div class="sparkline-line"></div></div>
                <div style="font-size:0.62rem; color:var(--text-muted);">Earnings this session</div>
            </div>
            <div class="rp-card">
                <div class="rp-heading">Platform Stats</div>
                <div class="stat-row">
                    <div class="stat-label">Creator Earnings<span>80% payout rate</span></div>
                    <div class="stat-val green">0.8 â˜…</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Platform Fee<span>Per interaction</span></div>
                    <div class="stat-val purple">0.2 â˜…</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">APTM Vault<span>On-chain balance</span></div>
                    <div class="stat-val teal" id="rp-aptm">0.0000</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Live APTM Rate<span>USD peg</span></div>
                    <div class="stat-val gold" id="rp-rate">$0.3391</div>
                </div>
                <div class="stat-row" style="border:none;">
                    <div class="stat-label">Total Anchors<span>All time</span></div>
                    <div class="stat-val" id="rp-anchors">0</div>
                </div>
            </div>
            <div class="rp-card">
                <div class="rp-heading">Storage</div>
                <div style="font-size:0.72rem; color:var(--text-secondary); line-height:1.6; margin-bottom:10px;">
                    Media stored on <span style="color:#ffb300; font-weight:600;">Firebase Storage</span> (Blaze Plan). No MetaMask required for uploads.
                </div>
                <div style="display:flex; align-items:center; gap:6px; margin-top:8px;">
                    <span class="a-dot" style="background:#ffb300;"></span>
                    <span style="font-family:var(--font-mono); font-size:0.6rem; color:#ffb300;">FIREBASE STORAGE ACTIVE</span>
                </div>
            </div>
        </div><!-- /right-panel -->

    </div><!-- /body-layout -->
</div><!-- /app-shell -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAVIGATION BAR (mobile only â€” V10 + V11 Wallet tab)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bottom-nav">
    <button class="bnav-item active" id="bnav-home" onclick="switchPage('home', null); setBnav('home')">
        <span class="bnav-icon">âŠ</span>
        Home
    </button>
    <button class="bnav-item bnav-post" onclick="scrollToCompose()">
        <span class="bnav-icon">ï¼‹</span>
        Post
    </button>
    <button class="bnav-item" id="bnav-studio" onclick="switchPage('earnings', null); setBnav('studio')">
        <span class="bnav-icon">â—†</span>
        Studio
    </button>
    <!-- V11 NEW: Wallet icon â†’ opens drawer -->
    <button class="bnav-item bnav-wallet" id="bnav-wallet" onclick="openWalletDrawer()">
        <span class="bnav-icon">â—</span>
        Wallet
    </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MOBILE WALLET DRAWER (V11 NEW)
     Full-screen slide-up overlay with:
       â€¢ Star balance (big bold)
       â€¢ Live APTM price
       â€¢ Buy Stars section (deposit)
       â€¢ Creator Studio section (earned stars + settle)
       â€¢ Admin dashboard (conditional â€” admin wallet only)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wallet-drawer">
    <div id="wallet-drawer-backdrop" onclick="closeWalletDrawer()"></div>
    <div id="wallet-drawer-panel">

        <!-- Sticky back button -->
        <button id="drawer-back-btn" onclick="closeWalletDrawer()">
            <span>â†</span> Back to Feed
        </button>

        <div id="wallet-drawer-content">

            <!-- STAR BALANCE + PRICE -->
            <div class="rp-card">
                <div class="drawer-section-label">Total Spendable Stars</div>
                <div class="drawer-stars-display" id="drawer-stars">0 â˜…</div>
                <div class="drawer-price-display" id="drawer-price">APTM @ $0.3391</div>
                <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px 10px;">
                        <div style="font-size:0.56rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-weight:700; margin-bottom:2px;">Purchased</div>
                        <div style="font-family:var(--font-mono); font-size:1rem; font-weight:700; color:var(--gold);" id="drawer-purchased-stars">0 â˜…</div>
                    </div>
                    <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px 10px;">
                        <div style="font-size:0.56rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; font-weight:700; margin-bottom:2px;">Earned</div>
                        <div style="font-family:var(--font-mono); font-size:1rem; font-weight:700; color:var(--green);" id="drawer-earned-display">0 â˜…</div>
                    </div>
                </div>
                <div style="margin-top:8px; font-size:0.72rem; color:var(--text-muted);">
                    APTM Vault: <span style="color:var(--teal); font-family:var(--font-mono); font-weight:600;" id="drawer-aptm-val">0.0000 $APTM</span>
                </div>
            </div>

            <!-- BUY STARS (DEPOSIT) -->
            <div class="rp-card">
                <div class="drawer-section-label" style="margin-bottom:10px;">Buy Stars</div>
                <div style="font-size:0.78rem; color:var(--text-secondary); margin-bottom:10px; line-height:1.5;">
                    Deposit $APTM to receive Stars. MetaMask will open for the on-chain transaction.
                </div>
                <div style="display:flex; gap:8px; align-items:flex-end;">
                    <div style="flex:1;">
                        <div style="font-size:0.62rem; color:var(--text-muted); margin-bottom:4px;">APTM Amount</div>
                        <input type="number" id="drawer-deposit-input" class="field" style="margin-top:0;" placeholder="5.0" min="0.1" step="0.1">
                    </div>
                    <button class="btn btn-teal btn-sm" style="flex-shrink:0; margin-bottom:0; height:40px;" onclick="drawerDeposit()">Convert â†’</button>
                </div>
                <div style="font-size:0.65rem; color:var(--text-muted); margin-top:8px; font-family:var(--font-mono);">
                    Est. Stars: <span id="drawer-deposit-est" style="color:var(--gold);">â€”</span>
                </div>
                <input id="drawer-deposit-hidden" type="number" style="display:none;" value="5">
            </div>

            <!-- CREATOR STUDIO -->
            <div class="rp-card">
                <div class="drawer-section-label" style="margin-bottom:10px;">Creator Studio</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                    <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:12px;">
                        <div style="font-size:0.58rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700;">Earned Stars</div>
                        <div style="font-family:var(--font-mono); font-size:1.4rem; font-weight:700; color:var(--gold); margin-top:4px;" id="drawer-earned-stars">0 â˜…</div>
                    </div>
                    <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:12px;">
                        <div style="font-size:0.58rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700;">APTM Vault</div>
                        <div style="font-family:var(--font-mono); font-size:0.85rem; font-weight:700; color:var(--teal); margin-top:4px;" id="drawer-vault-aptm">0.0000</div>
                    </div>
                </div>
                <button class="btn btn-teal" style="margin-top:0;" onclick="settleStarsToWallet(); closeWalletDrawer();">Settle Total Balance to Wallet â†’</button>
            </div>

            <!-- ADMIN DASHBOARD (conditional) -->
            <div class="rp-card" id="drawer-admin-section" style="border-color:rgba(240,180,41,0.25);">
                <div class="drawer-admin-header">ğŸ” Admin Dashboard</div>
                <div style="font-size:0.68rem; color:var(--text-secondary); margin-bottom:6px;">Total Platform Revenue</div>
                <div class="drawer-revenue-num" id="drawer-admin-revenue">0 â˜…</div>
                <div style="font-size:0.62rem; color:var(--text-muted); margin-bottom:14px;" id="drawer-admin-count">0 fee events</div>
                <button class="btn btn-gold btn-sm" style="width:100%; margin-top:0;" onclick="adminWithdraw(); closeWalletDrawer();">â¬‡ Admin Withdraw</button>
            </div>

            <!-- Connect prompt if no wallet -->
            <div id="drawer-connect-prompt" style="text-align:center; padding:20px 0;">
                <div style="font-size:0.82rem; color:var(--text-secondary); margin-bottom:14px;">Connect your wallet to access your balance, buy stars, and settle earnings.</div>
                <button class="btn btn-purple" style="width:auto; padding:10px 24px;" onclick="connectWallet()">Connect Wallet</button>
            </div>

        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš™ï¸  GLOBAL CONFIG  (V17)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CONFIG = {
        // â”€â”€ Core vault contract â€” ALL balance checks use this address â”€â”€
        ADMIN_ADDRESS:    "0xe348fedea1850a0c2d4ac0fed3f903774de1e16a",
        CONTRACT_ADDRESS: "0x42E0A97844ac6623207F2a363aa318E83268910F", // canonical checksummed form
        STARS_PER_5_APTM: 169,
        STAR_USD:         0.01,
        PLATFORM_CUT:     0.2,
        CREATOR_CUT:      0.8,
        FEES: {
            TEXT:  1.2,
            PHOTO: 3.0,
            VIDEO: 10.0,
            BOOST: 10,
        },
        STORAGE_BUCKET: "gs://socialhub-33014.firebasestorage.app"
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentAptmBalance    = "0.0000";
    let purchasedStars        = 0;   // Stars from APTM deposits (user_balances.stars)
    let creatorEarnings       = 0;   // Stars earned from hypes/comments (user_balances.creatorStars)
    let currentAptmPriceUsd   = 0.3391;
    let totalAnchors          = 0;
    let provider, signer, hubContract;
    let userAddress  = "";
    let userHandle   = localStorage.getItem('hub_userName') || "Anonymous_Creator";
    let userAvatar   = localStorage.getItem('hub_userPic')  || "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";
    let visibleCount = 10;
    const pageSize   = 10;

    // V13: Total spendable = purchased + earned. Used everywhere for balance checks.
    function getTotalSpendableStars() {
        return parseFloat(purchasedStars || 0) + parseFloat(creatorEarnings || 0);
    }

    const abi = [
        "function depositAPTM() public payable",
        "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
        "function boostPost(uint256 _oneStarWei) public",
        "function interact(address _recipient, uint256 _oneStarWei) public",
        "function starBalances(address _user) view returns (uint256)",
        "function aptmBalances(address) view returns (uint256)",
        "function totalAnchors() view returns (uint256)",
        "function userWithdraw(uint256 _amountWei) public",
        "function adminWithdraw() public",
        "function PLATFORM_ADMIN() view returns (address)"
    ];

    let mediaTabMode = 'url';
    let selectedFile = null;


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRICE HEARTBEAT  (V17 â€” APERTUM RPC ONLY, ZERO EXTERNAL APIS)
    //
    // Official Apertum RPC:
    //   https://rpc.apertum.io/ext/bc/YDJ1r9RMkewATmA7B35q1bdV18aywzmdiXwd9zGBq3uQjsCnn/rpc
    //
    // Strategy: call getReserves() on the wAPTM/wUSDT liquidity pair.
    // wAPTM token: 0x110Ac02Ba3384Bc055c13A87766049a74517BedA
    // If RPC fails, ticker shows: 'Network: Connected | System: Online'
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const APERTUM_RPC = "https://rpc.apertum.io/ext/bc/YDJ1r9RMkewATmA7B35q1bdV18aywzmdiXwd9zGBq3uQjsCnn/rpc";
    const WAPTM_ADDR  = "0x110Ac02Ba3384Bc055c13A87766049a74517BedA";

    // Read-only RPC provider for price queries â€” separate from MetaMask signer
    let rpcProvider = null;
    function getRpcProvider() {
        if (!rpcProvider) rpcProvider = new ethers.providers.JsonRpcProvider(APERTUM_RPC);
        return rpcProvider;
    }

    // Minimal Uniswap-V2 Pair ABI for getReserves
    const PAIR_ABI_V17 = [
        "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
        "function token0() view returns (address)",
        "function token1() view returns (address)"
    ];
    const FACTORY_ABI_V17 = [
        "function getPair(address tokenA, address tokenB) view returns (address pair)"
    ];
    // Known Apertum DEX factory and wUSDT addresses to try
    const V17_FACTORIES = [
        "0x9Ad6C38BE94206cA50bb0d90783181662f0Cfa10",
        "0x6e7f5C0b9f4484E14D7D57b197E98C36b64B6B8"
    ];
    const V17_USDT = [
        "0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7",
        "0xc7198437980c041c805A1EDcbA50c1Ce5db95118",
        "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E"
    ];

    async function getLiveAptmPrice() {
        const rpc = getRpcProvider();
        for (const factoryAddr of V17_FACTORIES) {
            for (const usdtAddr of V17_USDT) {
                try {
                    const factory  = new ethers.Contract(factoryAddr, FACTORY_ABI_V17, rpc);
                    const pairAddr = await Promise.race([
                        factory.getPair(WAPTM_ADDR, usdtAddr),
                        new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000))
                    ]);
                    if (!pairAddr || pairAddr === ethers.constants.AddressZero) continue;
                    const pair = new ethers.Contract(pairAddr, PAIR_ABI_V17, rpc);
                    const [token0, reserves] = await Promise.all([pair.token0(), pair.getReserves()]);
                    const aptmIsToken0 = token0.toLowerCase() === WAPTM_ADDR.toLowerCase();
                    const aptmRes = aptmIsToken0 ? reserves.reserve0 : reserves.reserve1;
                    const usdtRes = aptmIsToken0 ? reserves.reserve1 : reserves.reserve0;
                    if (aptmRes.isZero() || usdtRes.isZero()) continue;
                    const price = parseFloat(ethers.utils.formatEther(usdtRes)) /
                                  parseFloat(ethers.utils.formatEther(aptmRes));
                    if (price > 0 && price < 100000) {
                        console.log('[V17 Heartbeat] APTM price from RPC reserves: $' + price.toFixed(6));
                        return price;
                    }
                } catch (_) { /* try next */ }
            }
        }
        console.warn('[V17 Heartbeat] RPC pair not reachable. Status ticker active.');
        return null;
    }

    // â”€â”€â”€ Price update helper â€” handles both live price and fallback status â”€â”€â”€
    function applyPriceUpdate(price) {
        const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        if (price === null) {
            // RPC reachable but pair not found â€” show status, keep last price for math
            const statusStr = 'Network: Connected | System: Online';
            s('live-price-display', statusStr);
            s('rp-rate',            statusStr);
            s('drawer-price',       statusStr);
        } else {
            currentAptmPriceUsd = price;
            const fmt = '$' + parseFloat(price).toFixed(4);
            s('live-price-display', fmt + ' / APTM');
            s('rp-rate',            fmt);
            s('drawer-price',       'APTM @ ' + fmt);
            const inp = document.getElementById('drawer-deposit-input');
            if (inp && inp.value) updateDepositEstimate(parseFloat(inp.value));
        }
    }

    // â”€â”€â”€ UNCONDITIONAL heartbeat â€” fires immediately on load, then every 30s â”€â”€â”€
    async function runPriceHeartbeat() {
        const price = await getLiveAptmPrice();
        applyPriceUpdate(price);
        if (provider && hubContract) {
            try { await syncData(); } catch (_) {}
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOBILE BOTTOM NAV
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setBnav(active) {
        document.querySelectorAll('.bnav-item').forEach(b => b.classList.remove('active'));
        const el = document.getElementById('bnav-' + active);
        if (el) el.classList.add('active');
    }

    function scrollToCompose() {
        switchPage('home', null);
        setBnav('home');
        setTimeout(() => {
            const c = document.getElementById('composer-card');
            if (c) c.scrollIntoView({ behavior: 'smooth' });
        }, 50);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET DRAWER (V11 NEW)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openWalletDrawer() {
        setBnav('wallet');
        const drawer = document.getElementById('wallet-drawer');
        drawer.classList.add('open');
        document.body.style.overflow = 'hidden';
        updateDrawerUI();
    }

    function closeWalletDrawer() {
        const drawer = document.getElementById('wallet-drawer');
        drawer.classList.remove('open');
        document.body.style.overflow = '';
        setBnav('home');
    }

    function updateDrawerUI() {
        const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        const fmt        = parseFloat(currentAptmPriceUsd).toFixed(4);
        const totalStars = getTotalSpendableStars();

        // Big balance = total spendable (purchased + earned)
        s('drawer-stars',          totalStars.toFixed(1) + " â˜…");
        s('drawer-price',          `APTM @ $${fmt}`);
        s('drawer-aptm-val',       (currentAptmBalance || "0.0000") + " $APTM");
        // Breakdown tiles in the balance card
        s('drawer-purchased-stars', purchasedStars.toFixed(1) + " â˜…");
        s('drawer-earned-display',  creatorEarnings.toFixed(1) + " â˜…");
        // Creator studio section shows earned-only stars
        s('drawer-earned-stars',    creatorEarnings.toFixed(1) + " â˜…");
        s('drawer-vault-aptm',      parseFloat(currentAptmBalance || 0).toFixed(4));

        // Show/hide connect prompt
        const prompt = document.getElementById('drawer-connect-prompt');
        if (prompt) prompt.style.display = userAddress ? 'none' : 'block';

        // Admin section
        const adminSec = document.getElementById('drawer-admin-section');
        if (adminSec) {
            adminSec.style.display = (userAddress && userAddress.toLowerCase() === CONFIG.ADMIN_ADDRESS.toLowerCase()) ? 'block' : 'none';
        }
    }

    function updateDepositEstimate(aptmAmt) {
        const stars = Math.floor(aptmAmt * currentAptmPriceUsd / CONFIG.STAR_USD);
        const el = document.getElementById('drawer-deposit-est');
        if (el) el.textContent = isNaN(stars) ? 'â€”' : stars + ' â˜…';
    }

    async function drawerDeposit() {
        const inp = document.getElementById('drawer-deposit-input');
        const amt = inp ? inp.value.trim() : "";
        if (!amt || isNaN(parseFloat(amt))) return showToast("Enter a valid APTM amount.");
        await _doDeposit(amt);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MEDIA TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setMediaTab(mode) {
        mediaTabMode = mode;
        document.getElementById('tab-url').classList.toggle('active', mode === 'url');
        document.getElementById('tab-file').classList.toggle('active', mode === 'file');
        document.getElementById('url-input-wrap').style.display  = mode === 'url'  ? '' : 'none';
        document.getElementById('file-input-wrap').style.display = mode === 'file' ? '' : 'none';
        updatePostFeeDisplay();
    }

    function updatePostFeeDisplay() {
        const el = document.getElementById('post-fee-display');
        if (!el) return;
        const url = document.getElementById('post-media')?.value || '';
        let cost = CONFIG.FEES.TEXT.toFixed(1) + ' â˜…';
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' â˜…  (Firebase upload â€” no MetaMask)';
        } else if (url) {
            const isVid = url.includes('mp4') || getYoutubeId(url);
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' â˜…';
        }
        el.textContent = 'Est. cost: ' + cost;
    }

    function handleFileSelect(input) {
        selectedFile = input.files[0];
        if (!selectedFile) return;
        const wrap = document.getElementById('file-preview-wrap');
        const img  = document.getElementById('file-preview-img');
        const vid  = document.getElementById('file-preview-vid');
        const info = document.getElementById('file-info');
        wrap.style.display = 'block';
        img.style.display  = 'none';
        vid.style.display  = 'none';
        const objUrl = URL.createObjectURL(selectedFile);
        if (selectedFile.type.startsWith('image/')) {
            img.src = objUrl; img.style.display = 'block';
        } else {
            vid.src = objUrl; vid.style.display = 'block';
        }
        const kb = (selectedFile.size / 1024).toFixed(1);
        info.innerHTML = `<span style="color:#ffb300;">â—ˆ ${selectedFile.name}</span> Â· ${kb} KB Â· Will upload to Firebase Storage`;
        updatePostFeeDisplay();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIREBASE STORAGE UPLOAD WITH REAL-TIME PROGRESS BAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function uploadToFirebaseStorage(file) {
        return new Promise((resolve, reject) => {
            if (!window.storage || !window.fsStorage) {
                return reject(new Error("Firebase Storage not ready. Try again in a moment."));
            }
            const timestamp   = Date.now();
            const safeName    = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            const storagePath = `media/${timestamp}_${safeName}`;
            const storageRef  = window.fsStorage.ref(window.storage, storagePath);
            const uploadTask  = window.fsStorage.uploadBytesResumable(storageRef, file);

            const progressWrap   = document.getElementById('upload-progress-wrap');
            const progressBar    = document.getElementById('progress-bar');
            const progressPct    = document.getElementById('progress-pct');
            const progressStatus = document.getElementById('progress-status');
            const progressLabel  = document.getElementById('progress-label-text');

            progressWrap.style.display = 'block';
            progressBar.style.width    = '0%';
            progressPct.textContent    = '0%';
            progressLabel.textContent  = `Uploading ${file.name}â€¦`;
            progressStatus.textContent = 'Startingâ€¦';

            uploadTask.on('state_changed',
                (snapshot) => {
                    const pct   = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    progressBar.style.width  = pct + '%';
                    progressPct.textContent  = pct + '%';
                    const kb    = (snapshot.bytesTransferred / 1024).toFixed(1);
                    const total = (snapshot.totalBytes / 1024).toFixed(1);
                    if (snapshot.state === 'running') {
                        progressStatus.textContent = `${kb} KB / ${total} KB transferred`;
                    } else if (snapshot.state === 'paused') {
                        progressStatus.textContent = 'Upload paused.';
                    }
                },
                (error) => { progressWrap.style.display = 'none'; reject(error); },
                async () => {
                    progressBar.style.width   = '100%';
                    progressPct.textContent   = '100%';
                    progressStatus.textContent = 'Processingâ€¦';
                    try {
                        const downloadURL = await window.fsStorage.getDownloadURL(uploadTask.snapshot.ref);
                        progressStatus.textContent = 'âœ“ Upload complete!';
                        progressLabel.textContent  = 'Stored on Firebase';
                        setTimeout(() => { progressWrap.style.display = 'none'; }, 2500);
                        resolve(downloadURL);
                    } catch (e) { progressWrap.style.display = 'none'; reject(e); }
                }
            );
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET â€” MetaMask only for Deposit, Withdraw, Admin Withdraw
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function connectWallet() {
        if (!window.ethereum) return alert("MetaMask not found. Please install it.");
        try {
            provider    = new ethers.providers.Web3Provider(window.ethereum);
            const accts = await provider.send("eth_requestAccounts", []);
            userAddress = accts[0];
            signer      = provider.getSigner();
            hubContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, abi, signer);

            const statusEl = document.getElementById('wallet-status');
            if (statusEl) statusEl.textContent = userAddress.slice(0, 6) + 'â€¦' + userAddress.slice(-4);

            await syncData();
            updateUI();
            subscribeToEarnings(userAddress);
            subscribeLedger(userAddress);
            subscribeAdminRevenue(userAddress);
            if (typeof loadGlobalFeed === "function") loadGlobalFeed();
            showToast("Connected & Synced âœ“");
        } catch (err) {
            console.error(err);
            showToast("Connection Failed");
        }
    }

    async function syncData() {
        if (!hubContract || !signer) return;
        try {
            const addr              = await signer.getAddress();
            const [balRaw, anchors] = await Promise.all([
                hubContract.aptmBalances(addr),
                hubContract.totalAnchors()
            ]);
            const humanBalance  = ethers.utils.formatEther(balRaw);
            currentAptmBalance  = humanBalance;
            totalAnchors        = anchors.toNumber();

            if (window.db) {
                const userRef = window.fs.doc(window.db, "user_balances", addr.toLowerCase());
                const snap    = await window.fs.getDoc(userRef);
                if (!snap.exists()) {
                    await window.fs.setDoc(userRef, { stars: 0, creatorStars: 0, lastSync: Date.now(), address: addr.toLowerCase() });
                } else {
                    // Read both star pools from Firebase
                    purchasedStars  = snap.data().stars        || 0;
                    creatorEarnings = snap.data().creatorStars  || 0;
                    await window.fs.updateDoc(userRef, { lastSync: Date.now() });
                }
            }
            updateUI();
        } catch (e) { console.error("Sync Failed:", e); }
    }

    function updateUI() {
        try {
            const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            const fmt         = `$${parseFloat(currentAptmPriceUsd).toFixed(4)}`;
            const totalStars  = getTotalSpendableStars();
            const totalStr    = totalStars.toFixed(1) + " â˜…";

            // Sidebar vault â€” shows TOTAL spendable (purchased + earned)
            s('user-stars',              totalStr);
            s('sidebar-purchased-stars', purchasedStars.toFixed(1));
            s('sidebar-earned-stars',    creatorEarnings.toFixed(1));
            // Studio nav badge â€” total spendable
            s('sidebar-stars-badge',     totalStars.toFixed(1) + " â˜…");
            // Right panel â€” total spendable
            s('rp-stars',                totalStr);
            s('sidebar-aptm-value',      (currentAptmBalance || "0.0000") + " $APTM");
            s('earnings-aptm-value',     (currentAptmBalance || "0.0000") + " $APTM");
            s('rp-aptm',                 parseFloat(currentAptmBalance || 0).toFixed(4));
            // Creator Studio "Active Stars" tile â†’ total spendable (purchased + earned)
            s('creator-revenue-display', totalStr);
            s('studio-purchased-stars',  purchasedStars.toFixed(1));
            s('studio-earned-stars',     creatorEarnings.toFixed(1));
            s('live-price-display',      fmt + ' / APTM');
            s('rp-rate',                 fmt);
            s('total-anchors-display',   totalAnchors);
            s('rp-anchors',              totalAnchors);

            const pbAv = document.getElementById('pb-avatar'); if (pbAv) pbAv.src = userAvatar;
            const nvAv = document.getElementById('nav-avatar'); if (nvAv) nvAv.src = userAvatar;
            const pbH  = document.getElementById('pb-handle');  if (pbH)  pbH.textContent = userHandle;
            const nvH  = document.getElementById('nav-handle');  if (nvH)  nvH.textContent = userHandle;

            // Sync drawer if open
            updateDrawerUI();
        } catch (e) { console.error("UI Update Error:", e); }
    }

    function saveProfile() {
        const nameVal = document.getElementById('handle-input').value.trim();
        const picVal  = document.getElementById('avatar-input').value.trim();
        if (nameVal && picVal) {
            localStorage.setItem('hub_userName', nameVal);
            localStorage.setItem('hub_userPic',  picVal);
            userHandle = nameVal; userAvatar = picVal;
            updateUI(); showToast("Identity Saved âœ“"); loadGlobalFeed();
        } else {
            alert("Please enter both a name and an image URL");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STAR ECONOMY â€” Firebase balance helpers  (V13 REWRITE)
    //
    // Two separate star pools per user in Firestore user_balances doc:
    //   stars        â€” purchased stars (from APTM deposits)
    //   creatorStars â€” earned stars (from hypes/comments received)
    //
    // Total spendable = stars + creatorStars.
    //
    // Deduction waterfall:
    //   1. Subtract from `stars` (purchased) first.
    //   2. If `stars` hits 0 and cost remainder > 0, take from `creatorStars`.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Deduct `amount` from the user's spendable balance using the waterfall.
    async function deductSpendableStars(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref  = window.fs.doc(window.db, "user_balances", addr);
        await window.fs.runTransaction(window.db, async (txn) => {
            const snap          = await txn.get(ref);
            let purchased       = snap.exists() ? (snap.data().stars        || 0) : 0;
            let earned          = snap.exists() ? (snap.data().creatorStars  || 0) : 0;
            let remaining       = amount;

            // Step 1: drain purchased stars first
            const fromPurchased = Math.min(purchased, remaining);
            purchased          -= fromPurchased;
            remaining          -= fromPurchased;

            // Step 2: overflow into earned stars
            const fromEarned    = Math.min(earned, remaining);
            earned             -= fromEarned;

            txn.set(ref, {
                stars:        Math.max(0, purchased),
                creatorStars: Math.max(0, earned),
                lastUpdated:  Date.now()
            }, { merge: true });
        });
    }

    // Credit earned stars to creatorStars pool (hype/comment rewards received)
    async function creditCreatorStars(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref  = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap    = await txn.get(ref);
                const current = snap.exists() ? (snap.data().creatorStars || 0) : 0;
                txn.set(ref, { creatorStars: current + amount, lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) { console.error("creditCreatorStars failed:", e); }
    }

    // Credit purchased stars to the `stars` pool (deposit)
    async function creditPurchasedStars(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref  = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap    = await txn.get(ref);
                const current = snap.exists() ? (snap.data().stars || 0) : 0;
                txn.set(ref, { stars: current + amount, lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) { console.error("creditPurchasedStars failed:", e); }
    }

    // Legacy wrapper kept so existing hype/comment calls that pass a negative
    // amount to the OLD adjustFirebaseBalance still work during transition.
    async function adjustFirebaseBalance(walletAddr, amount) {
        if (amount < 0) {
            await deductSpendableStars(walletAddr, Math.abs(amount));
        } else {
            await creditCreatorStars(walletAddr, amount);
        }
    }

    function subscribeToEarnings(walletAddr) {
        if (!walletAddr || !window.db) return;
        const ref = window.fs.doc(window.db, "user_balances", walletAddr.toLowerCase());
        window.fs.onSnapshot(ref, (snap) => {
            if (snap.exists()) {
                purchasedStars  = snap.data().stars        || 0;
                creatorEarnings = snap.data().creatorStars  || 0;
            } else {
                purchasedStars  = 0;
                creatorEarnings = 0;
            }
            // creator-revenue-display always shows TOTAL (purchased + earned) â€” synced via updateUI()
            updateUI();
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSACTION LEDGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function logTransaction(address, type, amount, description) {
        if (!address || !window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "user_transactions"), {
            address: address.toLowerCase(), type, amount, description, timestamp: Date.now()
        }).catch(e => console.warn("logTransaction:", e));
    }

    // 100% of post fees + 20% of interactions â†’ admin_revenue
    function logAdminRevenue(sourceAddress, actionType, amount) {
        if (!window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
            sourceAddress: (sourceAddress || "unknown").toLowerCase(),
            actionType, amount, timestamp: Date.now()
        }).catch(e => console.warn("logAdminRevenue:", e));

        const globalRef = window.fs.doc(window.db, "admin_revenue", "global");
        window.fs.runTransaction(window.db, async (txn) => {
            const snap = await txn.get(globalRef);
            const prev = snap.exists() ? (snap.data().total || 0) : 0;
            txn.set(globalRef, { total: prev + amount, lastUpdated: Date.now() }, { merge: true });
        }).catch(e => console.warn("logAdminRevenue global:", e));
    }

    function subscribeLedger(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const q    = window.fs.query(
            window.fs.collection(window.db, "user_transactions"),
            window.fs.where("address", "==", addr),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (docs) => {
            const el = document.getElementById('ledger-list');
            if (!el) return;
            if (docs.length === 0) { el.innerHTML = `<div class="ledger-empty">No activity yet.</div>`; return; }
            el.innerHTML = "";
            docs.slice(0, 10).forEach(tx => {
                const isEarn  = tx.type === "earn" || tx.type === "deposit";
                const prefix  = isEarn ? "+" : "âˆ’";
                const amtStr  = prefix + parseFloat(tx.amount).toFixed(1) + " â˜…";
                const amtCls  = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                const badge   = { earn:"Earned", spend:"Spent", deposit:"Deposit", settle:"Settle" }[tx.type] || tx.type;
                const date    = new Date(tx.timestamp).toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
                const row     = document.createElement('div');
                row.className = 'ledger-row';
                row.innerHTML = `
                    <div class="ledger-desc">${tx.description}<small>${date}</small></div>
                    <div style="width:58px;text-align:center;flex-shrink:0;"><span class="ledger-badge ${tx.type}">${badge}</span></div>
                    <div class="ledger-amount ${amtCls}">${amtStr}</div>`;
                el.appendChild(row);
            });
        };
        window.fs.onSnapshot(q, (snap) => {
            const docs = []; snap.forEach(d => docs.push(d.data())); render(docs);
        }, (err) => {
            console.warn("Ledger fallback:", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "user_transactions"),
                window.fs.where("address", "==", addr)
            );
            window.fs.onSnapshot(fq, (snap) => {
                const docs = []; snap.forEach(d => docs.push(d.data()));
                docs.sort((a, b) => b.timestamp - a.timestamp); render(docs);
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMIN REVENUE â€” subscribes and updates both desktop + drawer
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function subscribeAdminRevenue(walletAddr) {
        if (!walletAddr || !window.db) return;
        if (walletAddr.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) return;

        // Show admin panels
        const panel = document.getElementById('admin-revenue-panel');
        if (panel) panel.style.display = 'block';
        const drawerAdmin = document.getElementById('drawer-admin-section');
        if (drawerAdmin) drawerAdmin.style.display = 'block';

        const q = window.fs.query(
            window.fs.collection(window.db, "platform_revenue"),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (snap) => {
            let total = 0; snap.forEach(d => { total += (d.data().amount || 0); });
            const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            s('admin-revenue-display', total.toFixed(2) + " â˜…");
            s('admin-revenue-count',   snap.size + " fee events");
            s('drawer-admin-revenue',  total.toFixed(2) + " â˜…");
            s('drawer-admin-count',    snap.size + " fee events");
        };
        window.fs.onSnapshot(q, render, () => {
            window.fs.onSnapshot(window.fs.collection(window.db, "platform_revenue"), render);
        });
    }

    async function adminWithdraw() {
        if (!hubContract || !signer || !provider) return alert("Connect Wallet First");
        if (!userAddress || userAddress.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) {
            return alert("Admin only.");
        }
        try {
            // â”€â”€ Step 1: Read platform revenue stars from Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let totalRevenueStars = 0;
            if (window.db) {
                try {
                    const snap = await window.fs.getDocs(window.fs.collection(window.db, "platform_revenue"));
                    snap.forEach(d => {
                        // skip cleared docs
                        if (!d.data()._cleared) totalRevenueStars += (d.data().amount || 0);
                    });
                } catch (e) { console.warn("Could not read platform_revenue:", e); }
            }
            // Cross-check against admin_revenue/global
            let globalTotal = 0;
            try {
                const globalSnap = await window.fs.getDoc(window.fs.doc(window.db, "admin_revenue", "global"));
                if (globalSnap.exists()) globalTotal = globalSnap.data().total || 0;
            } catch (_) {}
            const revenueStars = Math.max(totalRevenueStars, globalTotal);

            // â”€â”€ Step 2: Read the ACTUAL contract balance via provider.getBalance â”€â”€
            // This is the native coin (APTM) held in the vault contract itself.
            // DO NOT use aptmBalances(admin) â€” that is a per-user deposit slot,
            // not the contract treasury that adminWithdraw() drains.
            const contractBalanceRaw  = await provider.getBalance(CONFIG.CONTRACT_ADDRESS);
            const contractBalanceAptm = parseFloat(ethers.utils.formatEther(contractBalanceRaw));

            if (contractBalanceAptm <= 0) {
                return alert(
                    `Contract vault balance: ${contractBalanceAptm.toFixed(6)} APTM\n\n` +
                    `The contract holds no APTM to withdraw. Revenue is tracked in Firebase (${revenueStars.toFixed(2)} â˜…) ` +
                    `but the on-chain vault is empty.`
                );
            }

            // â”€â”€ Step 3: Convert stars â†’ APTM for display purposes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const aptmValue    = (revenueStars * CONFIG.STAR_USD) / currentAptmPriceUsd;
            // Withdraw whatever is actually in the contract (adminWithdraw drains it all)
            const withdrawAptm = contractBalanceAptm;

            const confirmed = confirm(
                `Admin Revenue Withdrawal\n\n` +
                `Firebase Revenue:     ${revenueStars.toFixed(2)} â˜…\n` +
                `Stars â†’ APTM Value:   ${aptmValue.toFixed(6)} APTM\n` +
                `Contract Vault Holds: ${contractBalanceAptm.toFixed(6)} APTM\n` +
                `Will Withdraw:        ${withdrawAptm.toFixed(6)} APTM\n\n` +
                `adminWithdraw() sends the entire vault balance to the admin wallet.\n` +
                `Firebase revenue counter will be reset to 0. Proceed?`
            );
            if (!confirmed) return;

            showToast("Calling adminWithdraw()â€¦");

            // â”€â”€ Step 4: Execute on-chain adminWithdraw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // adminWithdraw() transfers ALL contract balance to PLATFORM_ADMIN.
            const tx = await hubContract.adminWithdraw({ gasLimit: 300000 });
            await tx.wait();

            // â”€â”€ Step 5: Reset Firebase platform_revenue to 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (window.db) {
                try {
                    const revSnap = await window.fs.getDocs(window.fs.collection(window.db, "platform_revenue"));
                    const ops = [];
                    revSnap.forEach(d => {
                        ops.push(window.fs.updateDoc(
                            window.fs.doc(window.db, "platform_revenue", d.id),
                            { _cleared: true, amount: 0, clearedAt: Date.now() }
                        ));
                    });
                    await Promise.all(ops);

                    await window.fs.setDoc(
                        window.fs.doc(window.db, "admin_revenue", "global"),
                        { total: 0, lastWithdraw: Date.now(), lastUpdated: Date.now() },
                        { merge: true }
                    );
                } catch (e) { console.warn("Firebase reset after admin withdraw:", e); }
            }

            logTransaction(userAddress, "settle", withdrawAptm,
                `Admin withdrew ${revenueStars.toFixed(2)}â˜… = ${withdrawAptm.toFixed(4)} APTM from vault`);

            // â”€â”€ Step 6: Update all revenue displays to 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            s('admin-revenue-display', "0.00 â˜…");
            s('admin-revenue-count',   "0 fee events");
            s('drawer-admin-revenue',  "0.00 â˜…");
            s('drawer-admin-count',    "0 fee events");

            showToast(`âœ“ Withdrawn ${withdrawAptm.toFixed(4)} APTM to admin wallet`);
            updateUI();
            updateDrawerUI();
            syncData();
        } catch (e) {
            console.error(e);
            alert("Admin withdraw failed: " + (e.reason || e.message || String(e)).slice(0, 200));
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET ACTIONS â€” MetaMask gated
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function _doDeposit(amt) {
        if (!hubContract) {
            await connectWallet();
            if (!hubContract) return;
        }
        try {
            showToast(`Depositing ${amt} $APTMâ€¦`);
            const tx = await hubContract.depositAPTM({ value: ethers.utils.parseEther(String(parseFloat(amt))), gasLimit: 150000 });
            await tx.wait();
            const starsReceived = Math.floor(parseFloat(amt) * currentAptmPriceUsd / CONFIG.STAR_USD);
            // Credit to purchased stars pool
            await creditPurchasedStars(userAddress, starsReceived);
            logTransaction(userAddress, "deposit", starsReceived, `Deposited ${parseFloat(amt).toFixed(2)} $APTM â†’ ${starsReceived} Stars`);
            showToast("Deposit Successful âœ“");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { console.error(e); alert("Transaction failed: " + (e.reason || e.message).slice(0,100)); }
    }

    async function convertAPTM() {
        const price = await getLiveAptmPrice();
        if (price !== null) applyPriceUpdate(price);
        const displayPrice = currentAptmPriceUsd > 0 ? currentAptmPriceUsd.toFixed(4) : "N/A";
        const amt = prompt(`Deposit $APTM\nPrice: $${displayPrice}`, "5");
        if (amt) await _doDeposit(amt);
    }

    async function settleToWallet() {
        if (!hubContract || !signer || !provider) return alert("Connect Wallet First");
        try {
            const addr = await signer.getAddress();

            // Read BOTH star pools live from Firebase
            let livePurchased = 0, liveEarned = 0;
            if (window.db) {
                try {
                    const snap = await window.fs.getDoc(window.fs.doc(window.db, "user_balances", addr.toLowerCase()));
                    if (snap.exists()) {
                        livePurchased = snap.data().stars        || 0;
                        liveEarned    = snap.data().creatorStars  || 0;
                    }
                } catch (_) { livePurchased = purchasedStars; liveEarned = creatorEarnings; }
            }
            const totalStars = livePurchased + liveEarned;
            if (totalStars <= 0) return alert("No stars to settle. Earn or deposit some first.");

            // Convert total stars â†’ APTM
            // Formula: APTM = (totalStars Ã— STAR_USD) / currentAptmPriceUsd
            const starsToAptm = (totalStars * CONFIG.STAR_USD) / currentAptmPriceUsd;

            // Read user's deposited balance in the contract (their personal slot)
            const onChainRaw  = await hubContract.aptmBalances(addr);
            const onChainAptm = parseFloat(ethers.utils.formatEther(onChainRaw));

            // Also read the total contract balance as a fallback reference
            const contractBalRaw  = await provider.getBalance(CONFIG.CONTRACT_ADDRESS);
            const contractBalAptm = parseFloat(ethers.utils.formatEther(contractBalRaw));

            // Withdraw the lesser of stars-value vs what is actually in the contract
            const availableAptm = Math.max(onChainAptm, 0);
            const withdrawAptm  = Math.min(starsToAptm, Math.max(availableAptm, contractBalAptm));

            if (withdrawAptm <= 0) {
                return alert(
                    `Settle failed â€” vault is empty.\n\n` +
                    `Your Stars:          ${totalStars.toFixed(1)} â˜…\n` +
                    `Stars Value (APTM):  ${starsToAptm.toFixed(6)}\n` +
                    `Your Deposit Slot:   ${onChainAptm.toFixed(6)} APTM\n` +
                    `Contract Balance:    ${contractBalAptm.toFixed(6)} APTM\n\n` +
                    `Deposit APTM first to fund the vault.`
                );
            }

            const confirmed = confirm(
                `Settle Stars to Wallet\n\n` +
                `Total Stars:    ${totalStars.toFixed(1)} â˜…\n` +
                `Stars Value:    ${starsToAptm.toFixed(6)} APTM\n` +
                `Your vault:     ${onChainAptm.toFixed(6)} APTM\n` +
                `Will Withdraw:  ${withdrawAptm.toFixed(6)} APTM\n\n` +
                `Proceed?`
            );
            if (!confirmed) return;

            showToast("Opening MetaMaskâ€¦");
            const withdrawWei = ethers.utils.parseEther(withdrawAptm.toFixed(18));
            const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
            await tx.wait();

            // Zero out Firebase star balances after successful on-chain withdrawal
            if (window.db) {
                try {
                    await window.fs.setDoc(
                        window.fs.doc(window.db, "user_balances", addr.toLowerCase()),
                        { stars: 0, creatorStars: 0, lastUpdated: Date.now() },
                        { merge: true }
                    );
                    purchasedStars  = 0;
                    creatorEarnings = 0;
                } catch (e) { console.warn("Could not zero Firebase balances:", e); }
            }

            logTransaction(addr, "settle", withdrawAptm, `Settled ${totalStars.toFixed(1)}â˜… â†’ ${withdrawAptm.toFixed(4)} $APTM to wallet`);
            showToast(`Settled! ${withdrawAptm.toFixed(4)} APTM â†’ wallet âœ“`);
            updateUI();
            updateDrawerUI();
            syncData();
        } catch (e) { console.error(e); alert("Settle failed: " + (e.reason || e.message || String(e)).slice(0, 160)); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FEED HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .card');
        posts.forEach((post, i) => {
            if (i < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const btn = document.getElementById('load-more-btn');
        if (btn) btn.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() { visibleCount += pageSize; refreshFeedVisibility(); }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img       = document.getElementById('preview-img');
        if (url && url.startsWith('http')) { img.src = url; container.style.display = 'block'; }
        else { container.style.display = 'none'; }
        updatePostFeeDisplay();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        if (t) { t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2800); }
    }

    function switchPage(p, el) {
        document.getElementById('page-home').style.display = 'none';
        ['earnings', 'profile', 'info'].forEach(id => {
            const pg = document.getElementById('page-' + id);
            if (pg) pg.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        if (p === 'home') {
            document.getElementById('page-home').style.display = 'contents';
        } else {
            const pg = document.getElementById('page-' + p);
            if (pg) pg.classList.add('active');
        }
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match  = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BROADCAST â€” ZERO MetaMask popups for posting
    //
    // Revenue rules:
    //   Text post:   1.2 â˜… â†’ 100% admin_revenue
    //   Photo post:  3.0 â˜… â†’ 100% admin_revenue
    //   Video post: 10.0 â˜… â†’ 100% admin_revenue
    //   Hype/Comment: 80% creator, 20% admin_revenue
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleBroadcast() {
        const txt = document.getElementById('post-text').value.trim();
        if (!txt) return showToast("Write something first!");
        if (!userAddress) return showToast("Connect your wallet first!");

        // V13 FIX: Read BOTH star pools from Firebase and sum them
        let livePurchased = 0;
        let liveEarned    = 0;
        if (window.db) {
            try {
                const userRef = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap    = await window.fs.getDoc(userRef);
                if (snap.exists()) {
                    livePurchased = snap.data().stars        || 0;
                    liveEarned    = snap.data().creatorStars  || 0;
                }
            } catch (e) { console.warn("Balance check failed:", e); }
        }
        const totalAvailable = livePurchased + liveEarned;

        let mediaUrl   = "";
        let feeAmount  = CONFIG.FEES.TEXT;
        let postType   = 1;
        let isFirebase = false;

        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            feeAmount   = isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO;
            postType    = isVid ? 3 : 2;
            isFirebase  = true;
        } else {
            const url = document.getElementById('post-media').value.trim();
            if (url) {
                if (url.includes('mp4') || getYoutubeId(url)) { feeAmount = CONFIG.FEES.VIDEO; postType = 3; }
                else { feeAmount = CONFIG.FEES.PHOTO; postType = 2; }
                mediaUrl = url;
            }
        }

        // V13 FIX: Check against COMBINED balance (purchased + earned)
        if (totalAvailable < feeAmount) {
            return alert(
                `Insufficient Stars!\n` +
                `Required:        ${feeAmount.toFixed(1)}â˜…\n` +
                `Purchased Stars: ${livePurchased.toFixed(1)}â˜…\n` +
                `Earned Stars:    ${liveEarned.toFixed(1)}â˜…\n` +
                `Total Available: ${totalAvailable.toFixed(1)}â˜…\n\n` +
                `Deposit more APTM to increase your balance.`
            );
        }

        // Firebase Storage upload (NO MetaMask)
        if (isFirebase && selectedFile) {
            showToast("Uploading to Firebase Storageâ€¦");
            try {
                mediaUrl = await uploadToFirebaseStorage(selectedFile);
                showToast("Upload complete! Writing postâ€¦");
            } catch (e) {
                console.error("Firebase upload failed:", e);
                return alert("Upload failed: " + e.message);
            }
        }

        // V13 FIX: Deduct using waterfall (purchased first, then earned remainder)
        try {
            await deductSpendableStars(userAddress, feeAmount);
        } catch (e) {
            console.error("Star deduction failed:", e);
            return alert("Failed to deduct stars. Please try again.");
        }

        // 100% of post fee â†’ admin_revenue
        const postTypeLabel = postType === 1 ? "text_post" : postType === 2 ? "photo_post" : "video_post";
        logAdminRevenue(userAddress, postTypeLabel, feeAmount);
        logTransaction(userAddress, "spend", feeAmount, `Paid ${feeAmount}â˜… for ${postType === 1 ? 'Text' : postType === 2 ? 'Photo' : 'Video'} Broadcast`);

        // Write post to Firestore (NO MetaMask)
        try {
            const postAuthorName = localStorage.getItem('hub_userName') || userHandle;
            const postAuthorPic  = localStorage.getItem('hub_userPic')  || userAvatar;
            const postData = {
                text:       txt,
                media:      mediaUrl,
                firebase:   isFirebase,
                author:     postAuthorName,
                authorAddr: userAddress,
                avatar:     postAuthorPic,
                timestamp:  Date.now(),
                hypes:      0,
                type:       postType,
                feePaid:    feeAmount
            };
            await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

            // Reset composer
            document.getElementById('post-text').value  = "";
            document.getElementById('post-media').value = "";
            selectedFile = null;
            const fPrev = document.getElementById('file-preview-wrap');
            if (fPrev) fPrev.style.display = 'none';
            const progWrap = document.getElementById('upload-progress-wrap');
            if (progWrap) progWrap.style.display = 'none';

            updateUI();
            showToast("Signal Live! â—ˆ");
        } catch (e) {
            console.error("Firebase write failed:", e);
            alert("Post failed: " + e.message);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BOOST (on-chain â€” MetaMask required)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function boostPost(postId) {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const userAddr      = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            const boostFee      = ethers.utils.parseEther(CONFIG.FEES.BOOST.toString());
            let tx;
            showToast("Preparing 10â˜… Boostâ€¦");
            if (internalStars.gte(boostFee)) {
                tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 });
            } else {
                tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 });
            }
            await tx.wait();
            const postRef = window.fs.doc(window.db, "posts", postId);
            await window.fs.updateDoc(postRef, { timestamp: Date.now(), isBoosted: true });
            showToast("Signal Boosted! ğŸš€");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { console.error(e); alert("Boost failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HYPE â€” Firebase only, NO MetaMask (80/20 split)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function hypeElement(recipientAddress, displayId) {
        if (!userAddress) return showToast("Connect wallet first!");

        // V14: Check combined total spendable balance
        let livePurchased = 0, liveEarned = 0;
        if (window.db) {
            try {
                const userRef  = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap     = await window.fs.getDoc(userRef);
                if (snap.exists()) {
                    livePurchased = snap.data().stars        || 0;
                    liveEarned    = snap.data().creatorStars  || 0;
                }
            } catch (_) { livePurchased = purchasedStars; liveEarned = creatorEarnings; }
        }
        if ((livePurchased + liveEarned) < 1) return showToast("Not enough Stars! Deposit APTM.");

        try {
            const isComment = displayId.startsWith('hc-');
            const entityId  = displayId.replace(isComment ? 'hc-' : 'hp-', '');

            if (isComment) {
                await window.fs.updateDoc(window.fs.doc(window.db, "comments", entityId), { hypes: window.fs.increment(1) });
            } else {
                await window.fs.updateDoc(window.fs.doc(window.db, "posts", entityId), { hypes: window.fs.increment(1) });
            }

            // 80% to creator â€” goes into their creatorStars pool
            if (recipientAddress && recipientAddress !== "unknown") {
                await creditCreatorStars(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT,
                    isComment ? "Earned 0.8â˜… â€” someone hyped your comment" : "Earned 0.8â˜… â€” someone hyped your post");
                // Audit log to transactions collection
                await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                    address: recipientAddress.toLowerCase(), type: "earn",
                    amount: CONFIG.CREATOR_CUT,
                    description: isComment ? "Earned 0.8â˜… â€” someone hyped your comment" : "Earned 0.8â˜… â€” someone hyped your post",
                    timestamp: Date.now()
                });
            }

            // Deduct 1â˜… from sender using waterfall â€” purchasedStars first (deductStars)
            await deductStars(1);

            // 20% admin revenue
            logAdminRevenue(userAddress, isComment ? "hype_comment" : "hype_post", CONFIG.PLATFORM_CUT);
            logTransaction(userAddress, "spend", 1, isComment ? "Spent 1â˜… on Comment Hype" : "Spent 1â˜… on Post Hype");
            // Audit log to transactions collection
            await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                address: userAddress.toLowerCase(), type: "spend",
                amount: 1,
                description: isComment ? "Spent 1â˜… on Comment Hype" : "Spent 1â˜… on Post Hype",
                timestamp: Date.now()
            });

            updateUI();
            updateDrawerUI();
            const counterEl = document.getElementById(displayId);
            if (counterEl) counterEl.textContent = (parseInt(counterEl.textContent || "0") + 1);
            showToast("Hyped! Creator +0.8â˜…");
        } catch (e) { console.error(e); showToast("Hype failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMENTS â€” Firebase only, NO MetaMask (80/20 split)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleTray(id) {
        const t = document.getElementById(`tray-${id}`);
        if (!t) return;
        t.style.display = t.style.display === 'block' ? 'none' : 'block';
    }

    async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
        if (!userAddress) return showToast("Connect wallet first!");

        // V14: Check combined total spendable balance
        let livePurchased = 0, liveEarned = 0;
        if (window.db) {
            try {
                const userRef  = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap     = await window.fs.getDoc(userRef);
                if (snap.exists()) {
                    livePurchased = snap.data().stars        || 0;
                    liveEarned    = snap.data().creatorStars  || 0;
                }
            } catch (_) { livePurchased = purchasedStars; liveEarned = creatorEarnings; }
        }
        if ((livePurchased + liveEarned) < 1) return showToast("Not enough Stars! Deposit APTM.");

        const inputId     = isReply ? `reply-in-${parentId}` : `input-${postId}`;
        const input       = document.getElementById(inputId);
        const commentText = input ? input.value.trim() : "";
        if (!commentText) return;

        try {
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;
            const commentData = {
                text: commentText, author: authorName,
                authorAddr: userAddress || "unknown", avatar: authorPic,
                postId: String(postId), parentId: parentId || null,
                isReply, timestamp: Date.now(), hypes: 0, likes: 0
            };

            await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);

            // 80% to creator â€” goes into their creatorStars pool
            if (recipientAddress && recipientAddress !== "unknown") {
                await creditCreatorStars(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8â˜… â€” someone commented on your content");
                // Audit log to transactions collection
                await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                    address: recipientAddress.toLowerCase(), type: "earn",
                    amount: CONFIG.CREATOR_CUT, description: "Earned 0.8â˜… â€” someone commented on your content",
                    timestamp: Date.now()
                });
            }

            // Deduct 1â˜… from commenter â€” purchasedStars first (deductStars)
            await deductStars(1);

            // 20% admin revenue
            logAdminRevenue(userAddress, isReply ? "reply" : "comment", CONFIG.PLATFORM_CUT);
            logTransaction(userAddress, "spend", 1, isReply ? "Spent 1â˜… on a Reply" : "Spent 1â˜… on a Comment");
            // Audit log to transactions collection
            await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                address: userAddress.toLowerCase(), type: "spend",
                amount: 1, description: isReply ? "Spent 1â˜… on a Reply" : "Spent 1â˜… on a Comment",
                timestamp: Date.now()
            });

            updateUI();
            updateDrawerUI();
            if (input) input.value = "";
            const tray = document.getElementById(`tray-${postId}`);
            if (tray) tray.style.display = 'block';
            showToast("Comment Live! Creator +0.8â˜…");
        } catch (e) { console.error(e); showToast("Failed."); }
    }

    const _commentListeners = {};

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // loadComments â€” V18: PERSISTENT INPUT BOX + INFINITE NESTING
    //
    // Key V18 changes:
    //   1. Comment input textarea is ALWAYS visible (not just when opened)
    //   2. The textarea has 1px solid white border, dark background
    //   3. Reply areas open directly below the comment they reply to
    //   4. Every comment/reply has its own Like and Reply buttons
    //   5. Hype on comments: 80% â†’ comment author, 20% â†’ admin (via likeComment)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadComments(postId) {
        const list = document.getElementById("list-" + postId);
        if (!list || !window.db || _commentListeners[postId]) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "comments"),
            window.fs.where("postId", "==", String(postId)),
            window.fs.orderBy("timestamp", "asc")
        );

        const renderComments = (snapshot) => {
            list.innerHTML = "";
            const topLevel = [];
            const repliesMap = {};
            snapshot.forEach(docRef => {
                const data = Object.assign({}, docRef.data(), { _id: docRef.id });
                if (data.parentId) {
                    if (!repliesMap[data.parentId]) repliesMap[data.parentId] = [];
                    repliesMap[data.parentId].push(data);
                } else {
                    topLevel.push(data);
                }
            });

            const counterEl = document.getElementById("cc-" + postId);
            if (counterEl) counterEl.textContent = snapshot.size > 0 ? " (" + snapshot.size + ")" : "";

            if (topLevel.length === 0) {
                list.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);padding:8px 0 6px;">No comments yet â€” be the first!</div>';
            } else {
                // Recursive row builder
                function buildRow(comment, depth) {
                    const cId        = comment._id;
                    const authorAddr = comment.authorAddr || "unknown";
                    const likeCount  = comment.likes || comment.hypes || 0;

                    const row = document.createElement('div');
                    row.className = "cmt-row" + (depth > 0 ? " nested" : "");
                    if (depth > 1) {
                        row.style.marginLeft = (18 + (depth - 1) * 14) + "px";
                        row.style.borderLeft = "2px solid rgba(124,92,191," + Math.min(0.25 + depth * 0.08, 0.55) + ")";
                    }

                    const textDiv = document.createElement('div');
                    textDiv.className = "cmt-body-line";
                    textDiv.innerHTML = '<span class="cmt-author">' + (comment.author || "Anonymous") + '</span>: ' +
                                        '<span class="cmt-text">' + (comment.text || "") + '</span>';

                    const meta = document.createElement('div');
                    meta.className = "cmt-meta";
                    meta.innerHTML =
                        '<span class="cbtn" onclick="likeComment(\'' + cId + '\',\'' + authorAddr + '\')">' +
                            'â¤ <span id="hc-' + cId + '">' + likeCount + '</span>' +
                        '</span>' +
                        '<span class="cbtn reply" onclick="toggleReplyInput(\'' + cId + '\')">â†© Reply</span>';

                    // Inline reply box â€” white-bordered, hidden until Reply clicked
                    const replyArea = document.createElement('div');
                    replyArea.className = "reply-area";
                    replyArea.id = "reply-area-" + cId;
                    replyArea.innerHTML =
                        '<textarea id="reply-input-' + cId + '" class="reply-textarea" placeholder="Write a replyâ€¦ (1â˜…)"></textarea>' +
                        '<div class="reply-send-row">' +
                            '<span class="cost-hint">1â˜… Â· 80% to author</span>' +
                            '<button class="btn btn-purple btn-sm" onclick="submitReply(\'' + cId + '\',\'' + authorAddr + '\',\'' + postId + '\')">Send Reply</button>' +
                        '</div>';

                    row.appendChild(textDiv);
                    row.appendChild(meta);
                    row.appendChild(replyArea);

                    const children = repliesMap[cId] || [];
                    children.forEach(function(child) {
                        row.appendChild(buildRow(child, depth + 1));
                    });

                    return row;
                }

                topLevel.forEach(function(c) {
                    list.appendChild(buildRow(c, 0));
                });
            }
        };

        // Primary snapshot with ordering; fallback without if index missing
        _commentListeners[postId] = window.fs.onSnapshot(q, renderComments, function(err) {
            console.warn("Comment listener fallback (no index):", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "comments"),
                window.fs.where("postId", "==", String(postId))
            );
            _commentListeners[postId] = window.fs.onSnapshot(fq, function(snap) {
                const docs = [];
                snap.forEach(function(d) { docs.push(Object.assign({}, d.data(), { _id: d.id })); });
                docs.sort(function(a, b) { return (a.timestamp || 0) - (b.timestamp || 0); });
                const fakeSnap = {
                    forEach: function(fn) { docs.forEach(function(d) { fn({ data: function() { return d; }, id: d._id }); }); },
                    size: docs.length
                };
                renderComments(fakeSnap);
            });
        });
    }



    function toggleReplyInput(commentId) {
        const area = document.getElementById(`reply-area-${commentId}`);
        if (!area) return;
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            const inp = document.getElementById(`reply-input-${commentId}`);
            if (inp) setTimeout(() => inp.focus(), 50);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // deductStars â€” V14 SPENDING PRIORITY
    // Always drains purchasedStars first; overflow into creatorEarnings.
    // Updates both `stars` and `creatorStars` in user_balances.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function deductStars(amount) {
        if (!userAddress || !window.db) return;
        await deductSpendableStars(userAddress, amount);
        // Refresh local cache from Firebase after deduction
        try {
            const snap = await window.fs.getDoc(window.fs.doc(window.db, "user_balances", userAddress.toLowerCase()));
            if (snap.exists()) {
                purchasedStars  = snap.data().stars        || 0;
                creatorEarnings = snap.data().creatorStars  || 0;
            }
        } catch (_) {}
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // likeComment â€” Firebase only, NO MetaMask (80/20 split)
    // Costs 1â˜…: 0.8â˜… â†’ commenter's creatorStars, 0.2â˜… â†’ adminBalance
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function likeComment(commentId, commenterAddress) {
        if (!userAddress) return showToast("Connect wallet first!");

        // Check combined spendable balance
        let livePurchased = 0, liveEarned = 0;
        if (window.db) {
            try {
                const snap = await window.fs.getDoc(window.fs.doc(window.db, "user_balances", userAddress.toLowerCase()));
                if (snap.exists()) { livePurchased = snap.data().stars || 0; liveEarned = snap.data().creatorStars || 0; }
            } catch (_) { livePurchased = purchasedStars; liveEarned = creatorEarnings; }
        }
        if ((livePurchased + liveEarned) < 1) return showToast("Not enough Stars! Deposit APTM.");

        try {
            // Increment like count on comment doc
            await window.fs.updateDoc(window.fs.doc(window.db, "comments", commentId), { likes: window.fs.increment(1) });

            // 80% â†’ commenter's creatorStars
            if (commenterAddress && commenterAddress !== "unknown") {
                await creditCreatorStars(commenterAddress, CONFIG.CREATOR_CUT);
                // Log to transactions collection
                await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                    address: commenterAddress.toLowerCase(), type: "earn",
                    amount: CONFIG.CREATOR_CUT, description: "Earned 0.8â˜… â€” someone liked your comment",
                    timestamp: Date.now()
                });
                logTransaction(commenterAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8â˜… â€” someone liked your comment");
            }

            // Deduct 1â˜… from liker (purchasedStars first via deductStars)
            await deductStars(1);

            // 20% â†’ adminBalance (platform_revenue)
            const adminRef = window.fs.doc(window.db, "admin_revenue", "global");
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap = await txn.get(adminRef);
                const prev = snap.exists() ? (snap.data().total || 0) : 0;
                txn.set(adminRef, { total: prev + CONFIG.PLATFORM_CUT, lastUpdated: Date.now() }, { merge: true });
            });
            await window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
                sourceAddress: userAddress.toLowerCase(), actionType: "like_comment",
                amount: CONFIG.PLATFORM_CUT, timestamp: Date.now()
            });

            // Log to transactions collection (audit)
            await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                address: userAddress.toLowerCase(), type: "spend",
                amount: 1, description: "Spent 1â˜… to like a comment",
                timestamp: Date.now()
            });
            logTransaction(userAddress, "spend", 1, "Spent 1â˜… to like a comment");

            // Update UI counter
            const counterEl = document.getElementById(`hc-${commentId}`);
            if (counterEl) counterEl.textContent = (parseInt(counterEl.textContent || "0") + 1);

            updateDrawerUI();
            showToast("Liked! Commenter +0.8â˜…");
        } catch (e) { console.error(e); showToast("Like failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // submitReply â€” Firebase only, NO MetaMask (80/20 split)
    // Costs 1â˜…: 0.8â˜… â†’ original commenter's creatorStars, 0.2â˜… â†’ adminBalance
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function submitReply(parentCommentId, commenterAddress, postId) {
        if (!userAddress) return showToast("Connect wallet first!");

        const textarea = document.getElementById(`reply-input-${parentCommentId}`);
        const replyText = textarea ? textarea.value.trim() : "";
        if (!replyText) return showToast("Write something first!");

        // Check combined spendable balance
        let livePurchased = 0, liveEarned = 0;
        if (window.db) {
            try {
                const snap = await window.fs.getDoc(window.fs.doc(window.db, "user_balances", userAddress.toLowerCase()));
                if (snap.exists()) { livePurchased = snap.data().stars || 0; liveEarned = snap.data().creatorStars || 0; }
            } catch (_) { livePurchased = purchasedStars; liveEarned = creatorEarnings; }
        }
        if ((livePurchased + liveEarned) < 1) return showToast("Not enough Stars! Deposit APTM.");

        try {
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            // Write reply to comments collection
            await window.fs.addDoc(window.fs.collection(window.db, "comments"), {
                text: replyText, author: authorName,
                authorAddr: userAddress, avatar: authorPic,
                postId: String(postId), parentId: parentCommentId,
                isReply: true, timestamp: Date.now(), likes: 0, hypes: 0
            });

            // 80% â†’ original commenter's creatorStars
            if (commenterAddress && commenterAddress !== "unknown") {
                await creditCreatorStars(commenterAddress, CONFIG.CREATOR_CUT);
                await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                    address: commenterAddress.toLowerCase(), type: "earn",
                    amount: CONFIG.CREATOR_CUT, description: "Earned 0.8â˜… â€” someone replied to your comment",
                    timestamp: Date.now()
                });
                logTransaction(commenterAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8â˜… â€” someone replied to your comment");
            }

            // Deduct 1â˜… from replier (purchasedStars first via deductStars)
            await deductStars(1);

            // 20% â†’ adminBalance
            const adminRef = window.fs.doc(window.db, "admin_revenue", "global");
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap = await txn.get(adminRef);
                const prev = snap.exists() ? (snap.data().total || 0) : 0;
                txn.set(adminRef, { total: prev + CONFIG.PLATFORM_CUT, lastUpdated: Date.now() }, { merge: true });
            });
            await window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
                sourceAddress: userAddress.toLowerCase(), actionType: "reply_comment",
                amount: CONFIG.PLATFORM_CUT, timestamp: Date.now()
            });

            // Log to transactions collection (audit)
            await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                address: userAddress.toLowerCase(), type: "spend",
                amount: 1, description: "Spent 1â˜… on a reply",
                timestamp: Date.now()
            });
            logTransaction(userAddress, "spend", 1, "Spent 1â˜… on a Reply");

            // Reset textarea and close reply area
            if (textarea) textarea.value = "";
            const replyArea = document.getElementById(`reply-area-${parentCommentId}`);
            if (replyArea) replyArea.style.display = 'none';

            updateDrawerUI();
            showToast("Reply sent! Commenter +0.8â˜…");
        } catch (e) { console.error(e); showToast("Reply failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // V18 â€” verifyVaultHealth()
    // Checks the actual on-chain APTM balance of the Vault address via
    // the Apertum RPC. If zero, disables Broadcast + Post buttons and
    // shows the 'Low Liquidity' warning banner.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function verifyVaultHealth() {
        const VAULT_ADDRESS = CONFIG.CONTRACT_ADDRESS; // 0x42E0A97844ac6623207F2a363aa318E83268910F
        const broadcastBtn  = document.getElementById('broadcast-btn');
        const warningEl     = document.getElementById('vault-liquidity-warning');
        const settleBtn     = document.querySelector('button[onclick*="settleStarsToWallet"]') ||
                              document.querySelector('button[onclick*="settleToWallet"]');

        try {
            const rpc = getRpcProvider();
            // eth_getBalance returns the native coin (APTM) held in the vault
            const balRaw  = await Promise.race([
                rpc.getBalance(VAULT_ADDRESS),
                new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 8000))
            ]);
            const balAptm = parseFloat(ethers.utils.formatEther(balRaw));

            const isEmpty = balAptm <= 0;
            if (broadcastBtn) broadcastBtn.disabled = isEmpty;
            if (warningEl)    warningEl.style.display = isEmpty ? 'block' : 'none';

            // Also update the sidebar vault display
            const vaultAptmEl = document.getElementById('sidebar-aptm-value');
            if (vaultAptmEl) vaultAptmEl.textContent = balAptm.toFixed(4) + ' $APTM';

            console.log(`[V18 VaultHealth] Vault balance: ${balAptm.toFixed(6)} APTM. Locked: ${isEmpty}`);
            return balAptm;
        } catch (e) {
            console.warn('[V18 VaultHealth] RPC check failed â€” leaving buttons enabled:', e.message);
            if (broadcastBtn) broadcastBtn.disabled = false;
            if (warningEl)    warningEl.style.display = 'none';
            return null;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // V18.1 â€” settleStarsToWallet()
    // Settles the user's TOTAL balance (purchased stars + earned creator
    // stars) to APTM. Calculates payout from the combined sum, triggers
    // a MetaMask userWithdraw from the Vault, then atomically sets BOTH
    // `stars` and `creatorStars` to 0 in Firebase after the tx mines.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function settleStarsToWallet() {
        if (!hubContract || !signer || !provider) return alert("Connect Wallet First");
        try {
            const addr = await signer.getAddress();

            // â”€â”€ Step 1: Read BOTH star pools live from Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let livePurchased    = 0;
            let liveCreatorStars = 0;
            if (window.db) {
                try {
                    const snap = await window.fs.getDoc(
                        window.fs.doc(window.db, "user_balances", addr.toLowerCase())
                    );
                    if (snap.exists()) {
                        livePurchased    = snap.data().stars        || 0;
                        liveCreatorStars = snap.data().creatorStars || 0;
                    }
                } catch (_) {
                    livePurchased    = purchasedStars;
                    liveCreatorStars = creatorEarnings;
                }
            }

            // â”€â”€ Step 2: Combine into a single total â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const totalStars = livePurchased + liveCreatorStars;

            if (totalStars <= 0) {
                return alert(
                    "Nothing to settle.\n\n" +
                    "Your total balance (purchased + earned) is 0 â˜….\n" +
                    "Deposit APTM or earn stars through interactions first."
                );
            }

            // â”€â”€ Step 3: Fetch live APTM price for accurate conversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const livePrice  = await getLiveAptmPrice();
            const priceToUse = (livePrice && livePrice > 0) ? livePrice : currentAptmPriceUsd;

            // totalStars Ã— $0.01 per star Ã· price per APTM = APTM to receive
            const totalValueUsd = totalStars * CONFIG.STAR_USD;
            const aptmToReceive = totalValueUsd / priceToUse;

            // â”€â”€ Step 4: Check vault liquidity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const vaultBalAptm = await verifyVaultHealth();
            const contractBal  = (vaultBalAptm !== null) ? vaultBalAptm :
                parseFloat(ethers.utils.formatEther(
                    await provider.getBalance(CONFIG.CONTRACT_ADDRESS)
                ));

            if (contractBal <= 0) {
                return alert(
                    "Vault is empty.\n\n" +
                    "The platform vault holds 0 APTM. Settlement is not possible until the vault is funded.\n" +
                    "Contact admin: " + CONFIG.ADMIN_ADDRESS
                );
            }

            // Cap to what the vault actually holds
            const withdrawAptm = Math.min(aptmToReceive, contractBal);

            if (withdrawAptm <= 0.000001) {
                return alert(
                    "Settlement amount too small to process.\n\n" +
                    `Total Stars:     ${totalStars.toFixed(2)} â˜…\n` +
                    `USD Value:       $${totalValueUsd.toFixed(4)}\n` +
                    `APTM @ $${priceToUse.toFixed(4)}\n` +
                    `= ${aptmToReceive.toFixed(8)} APTM`
                );
            }

            // â”€â”€ Step 5: Confirm with the user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const confirmed = confirm(
                `Settle Total Balance to Wallet\n\n` +
                `Purchased Stars:    ${livePurchased.toFixed(2)} â˜…\n` +
                `Earned Stars:       ${liveCreatorStars.toFixed(2)} â˜…\n` +
                `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
                `Total Stars:        ${totalStars.toFixed(2)} â˜…\n` +
                `Total USD Value:    $${totalValueUsd.toFixed(4)}\n` +
                `Live APTM Price:    $${priceToUse.toFixed(4)}\n` +
                `Will Receive:       ${withdrawAptm.toFixed(6)} APTM\n` +
                `Vault Balance:      ${contractBal.toFixed(4)} APTM\n\n` +
                `Both star balances will be set to 0 after the transaction mines.\n` +
                `Proceed?`
            );
            if (!confirmed) return;

            showToast("Opening MetaMask for settlementâ€¦");

            // â”€â”€ Step 6: Execute on-chain userWithdraw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const withdrawWei = ethers.utils.parseEther(withdrawAptm.toFixed(18));
            const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
            showToast("Transaction submitted â€” waiting for confirmationâ€¦");
            await tx.wait();

            // â”€â”€ Step 7: ONE-CLICK WIPE â€” set BOTH pools to 0 in Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (window.db) {
                await window.fs.runTransaction(window.db, async (txn) => {
                    const ref = window.fs.doc(window.db, "user_balances", addr.toLowerCase());
                    txn.set(ref, {
                        stars:        0,
                        creatorStars: 0,
                        lastUpdated:  Date.now()
                    }, { merge: true });
                });
                // Sync local cache immediately
                purchasedStars  = 0;
                creatorEarnings = 0;
            }

            // â”€â”€ Step 8: Log the settlement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            logTransaction(addr, "settle", totalStars,
                `Settled ${totalStars.toFixed(2)}â˜… total (${livePurchased.toFixed(2)} purchased + ${liveCreatorStars.toFixed(2)} earned) â†’ ${withdrawAptm.toFixed(4)} $APTM`
            );
            await window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
                address:     addr.toLowerCase(),
                type:        "settle",
                amount:      totalStars,
                description: `Settled ${totalStars.toFixed(2)}â˜… â†’ ${withdrawAptm.toFixed(4)} $APTM to wallet`,
                timestamp:   Date.now()
            });

            showToast(`âœ“ Settled! ${withdrawAptm.toFixed(4)} APTM â†’ wallet`);
            updateUI();
            updateDrawerUI();
            await syncData();
            verifyVaultHealth();
        } catch (e) {
            console.error(e);
            alert("Settlement failed: " + (e.reason || e.message || String(e)).slice(0, 200));
        }
    }


    async function loadGlobalFeed() {
        const feedContainer = document.getElementById('feed-items');
        if (!feedContainer || !window.db) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "posts"),
            window.fs.orderBy("timestamp", "desc")
        );

        window.fs.onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = "";
            Object.keys(_commentListeners).forEach(k => {
                if (typeof _commentListeners[k] === 'function') _commentListeners[k]();
                delete _commentListeners[k];
            });

            snapshot.forEach((docRef) => {
                const post      = docRef.data();
                const postId    = docRef.id;
                const isMe      = (post.authorAddr && userAddress && post.authorAddr.toLowerCase() === userAddress.toLowerCase());
                const localName = localStorage.getItem('hub_userName');
                const localPic  = localStorage.getItem('hub_userPic');
                const displayPic  = (isMe && localPic)  ? localPic  : (post.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${post.authorAddr || 'anon'}`);
                const displayName = (isMe && localName) ? localName : (post.author || "Anonymous");

                let mediaHtml = '';
                const ytId    = getYoutubeId(post.media || "");
                const storageBadge = post.firebase
                    ? `<div style="margin-bottom:8px;"><span class="firebase-tag"><span class="a-dot" style="background:#ffb300; animation:blink 2s infinite;"></span>FIREBASE STORAGE</span></div>`
                    : '';

                if (ytId) {
                    mediaHtml = `${storageBadge}<div class="post-media"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
                } else if (post.media) {
                    if (post.type === 3) {
                        mediaHtml = `${storageBadge}<div class="post-media"><video src="${post.media}" controls style="width:100%;max-height:360px;"></video></div>`;
                    } else {
                        mediaHtml = `${storageBadge}<div class="post-media"><img src="${post.media}" loading="lazy"></div>`;
                    }
                }

                const item = document.createElement('div');
                item.className = 'card post-card';
                item.setAttribute('data-id', postId);
                if (post.isBoosted) item.style.borderColor = 'rgba(240,180,41,0.3)';

                item.innerHTML = `
                    <div class="post-header">
                        <img src="${displayPic}" class="av">
                        <div class="post-meta">
                            <div class="post-author">${displayName} ${post.isBoosted ? '<span class="boosted-badge">ğŸš€ BOOSTED</span>' : ''}</div>
                            <div class="post-addr">${post.authorAddr ? post.authorAddr.slice(0,6)+'â€¦'+post.authorAddr.slice(-4) : 'anon'}</div>
                        </div>
                        <span class="post-more">Â·Â·Â·</span>
                    </div>
                    ${mediaHtml}
                    <div class="post-body">${post.text}</div>
                    <div class="post-actions">
                        <div class="pact" onclick="hypeElement('${post.authorAddr}','hp-${postId}')">â¤ <span class="pact-num" id="hp-${postId}">${post.hypes || 0}</span> Like</div>
                        <div class="pact" onclick="toggleTray('${postId}'); loadComments('${postId}')">ğŸ’¬ Comment<span class="pact-num" id="cc-${postId}" style="color:var(--teal);"></span></div>
                        <div class="pact boost" style="margin-left:auto;" onclick="boostPost('${postId}')">ğŸš€ Boost (10â˜…)</div>
                    </div>
                    <div class="comment-tray" id="tray-${postId}">
                        <div class="comment-list" id="list-${postId}"></div>
                        <div class="cmt-input-row" style="flex-direction:column; gap:6px;">
                            <textarea class="cmt-persistent-box" placeholder="Add a comment (1â˜…)â€¦" id="input-${postId}" rows="2"></textarea>
                            <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center;">
                                <span style="font-size:0.6rem; color:var(--text-muted); font-family:var(--font-mono);">1â˜… Â· 80% to creator</span>
                                <button class="btn btn-purple btn-sm" onclick="addComment('${post.authorAddr}','${postId}')">Send</button>
                            </div>
                        </div>
                        <button class="close-comments-btn" onclick="toggleTray('${postId}')">â†‘ Close Comments</button>
                    </div>`;
                feedContainer.appendChild(item);
            });
            if (typeof refreshFeedVisibility === "function") refreshFeedVisibility();
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEPOSIT ESTIMATE LIVE UPDATE (drawer)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', () => {
        const inp = document.getElementById('drawer-deposit-input');
        if (inp) {
            inp.addEventListener('input', () => {
                const v = parseFloat(inp.value);
                if (!isNaN(v)) updateDepositEstimate(v);
            });
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STARTUP (V18)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('load', async () => {
        try {
            updateUI();
            updateDrawerUI();

            // Auto-connect if wallet was previously connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }

            // Start global feed
            setTimeout(() => { loadGlobalFeed(); }, 1500);

            // V18: Vault health check â€” disables Broadcast/Post if vault is empty
            setTimeout(() => { verifyVaultHealth(); }, 2000);
            setInterval(() => { verifyVaultHealth(); }, 60_000); // re-check every minute
        } catch (e) { console.error("Startup failed:", e); }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STARTUP (V18) â€” UNCONDITIONAL PRICE HEARTBEAT via Apertum RPC
    // No external APIs. Fires for ALL visitors on load, then every 30s.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    runPriceHeartbeat();                          // immediate on script load
    setInterval(runPriceHeartbeat, 30_000);       // every 30 seconds unconditionally

</script>
</body>
</html>
