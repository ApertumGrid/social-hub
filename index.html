
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIAL HUB | DISRUPTOR ALPHA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
   <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
    authDomain: "socialhub-33014.firebaseapp.com",
    projectId: "socialhub-33014",
    storageBucket: "socialhub-33014.firebasestorage.app",
    messagingSenderId: "864088350104",
    appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
    measurementId: "G-B2C1K1LVGQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.fs = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc };
  
  console.log("Firebase Database Fully Linked with 'where' clause!");
</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a;
            --accent-cyan: #00f2ff;
            --accent-purple: #bc00ff;
            --gold: #ffcc00;
            --glass: rgba(15, 15, 25, 0.7);
            --border: rgba(255, 255, 255, 0.12);
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, #1a1033 0%, #05070a 100%);
            color: white; display: flex; height: 100vh; overflow: hidden;
        }

        #sidebar {
            width: 280px; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 40px 25px; z-index: 100;
        }

        .logo { font-size: 1.6rem; font-weight: 900; margin-bottom: 40px; letter-spacing: -1px; }
        .logo span { color: var(--accent-cyan); }

        .nav-item {
            padding: 14px 18px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; color: #777; font-weight: 700; transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item.active { background: linear-gradient(90deg, rgba(0,242,255,0.1), transparent); color: var(--accent-cyan); border-left: 3px solid var(--accent-cyan); }

        #viewport { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .top-bar { padding: 20px 50px; display: flex; justify-content: flex-end; align-items: center; position: sticky; top: 0; z-index: 90; background: rgba(5,7,10,0.8); backdrop-filter: blur(10px); }
        #main-content { flex-grow: 1; padding: 0 50px 50px 50px; max-width: 750px; margin: 0 auto; width: 100%; }

        .glass-panel { 
            background: var(--glass); border: 1px solid var(--border); 
            border-radius: 24px; padding: 25px; margin-bottom: 25px; backdrop-filter: blur(10px);
        }
        
        .creator-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .avatar-circle { width: 44px; height: 44px; border-radius: 50%; background: #111; border: 2px solid var(--accent-cyan); object-fit: cover; }

        .wallet-pill { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--accent-cyan); padding: 8px 16px; border-radius: 50px; font-size: 0.7rem; font-weight: 900; color: var(--accent-cyan); cursor: pointer; }

        .action-btn { width: 100%; background: var(--gold); border: none; padding: 12px; border-radius: 12px; font-weight: 900; color: #000; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .input-field { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; margin-top: 8px; outline: none; box-sizing: border-box; }

        #media-preview-container { margin-top: 10px; display: none; text-align: center; background: #000; border-radius: 12px; padding: 10px; border: 1px dashed var(--accent-cyan); }
        #preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; }

        .post-media-container { width: 100%; max-height: 400px; border-radius: 18px; overflow: hidden; margin: 15px 0; border: 1px solid #222; background: #000; display: flex; justify-content: center; }
        .post-media-container img, .post-media-container iframe { width: 100%; height: 100%; border: none; }

        .feed-actions { display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; }
        .feed-btn { cursor: pointer; font-size: 0.8rem; font-weight: 800; color: #666; display: flex; align-items: center; gap: 6px; }
        
        .comment-area { margin-top: 15px; padding-top: 15px; display: none; border-top: 1px dashed #222; }
        .comment-list { max-height: 400px; overflow-y: auto; margin-bottom: 10px; padding-right: 10px; }
        
        .comment-row { font-size: 0.85rem; margin-bottom: 15px; color: #bbb; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; position: relative; }
        .comment-meta { font-size: 0.65rem; color: #555; margin-top: 8px; display: flex; gap: 15px; }
        .meta-link { cursor: pointer; color: var(--accent-purple); font-weight: 800; }

        .reply-box { display: none; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .nested-container { margin-left: 20px; border-left: 1px solid #333; padding-left: 15px; margin-top: 10px; }

        .hash-anchor { font-family: monospace; font-size: 0.6rem; color: #3a3d42; display: block; margin-top: 10px; letter-spacing: 1px; }
        .aptm-indicator { font-size: 0.65rem; color: var(--accent-cyan); font-weight: 800; display: block; margin-top: 2px; text-transform: uppercase; }
        .price-ticker { font-size: 0.55rem; color: #444; margin-top: 5px; font-weight: 800; }

        .tok-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tok-label { color: #888; font-size: 0.9rem; }
        .tok-value { font-weight: 900; color: var(--accent-cyan); }
        .tok-section-title { font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; margin: 25px 0 10px 0; font-weight: 900; text-transform: uppercase; }

        .page { display: none; }
        .page.active { display: block; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--accent-cyan); color: black; padding: 12px 24px; border-radius: 8px; font-weight: 900; opacity: 0; transition: 0.3s; z-index: 1000; pointer-events: none; }

        #load-more-btn { display: none; margin: 20px auto; width: 200px; background: transparent; border: 1px solid #333; color: #666; font-size: 0.7rem; }
        .hidden-post { display: none !important; }

        /* Comment interaction row */
        .comment-actions { display: flex; gap: 14px; margin-top: 8px; }
        .comment-btn { 
            font-size: 0.7rem; font-weight: 800; color: #555; cursor: pointer; 
            padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06); transition: 0.15s;
            display: flex; align-items: center; gap: 4px;
        }
        .comment-btn:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .comment-btn.reply-btn:hover { color: var(--accent-purple); border-color: var(--accent-purple); }

        /* Inline reply input that slides open under a comment */
        .reply-input-area { 
            display: none; margin-top: 10px; 
            background: rgba(0,0,0,0.25); border-radius: 10px; 
            padding: 10px; border: 1px solid #2a2a2a;
        }
        .reply-input-row { display: flex; gap: 8px; margin-top: 0; }
        .reply-input-row input { margin-top: 0; flex: 1; }
        .reply-send-btn { 
            background: var(--accent-purple); border: none; color: white;
            padding: 8px 14px; border-radius: 8px; font-weight: 900; font-size: 0.75rem;
            cursor: pointer; white-space: nowrap; flex-shrink: 0;
        }

        /* Transaction Ledger */
        .ledger-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
            gap: 12px;
        }
        .ledger-row:last-child { border-bottom: none; }
        .ledger-desc { font-size: 0.8rem; color: #aaa; flex: 1; line-height: 1.3; }
        .ledger-desc small { display: block; font-size: 0.65rem; color: #555; margin-top: 2px; }
        .ledger-amount { font-size: 0.85rem; font-weight: 900; white-space: nowrap; }
        .ledger-amount.earn  { color: #4ade80; }
        .ledger-amount.spend { color: #f87171; }
        .ledger-amount.neutral { color: #888; }
        .ledger-empty { font-size: 0.75rem; color: #444; padding: 12px 0; text-align: center; }
        .balance-note { font-size: 0.6rem; color: #555; font-weight: 600; margin-top: 3px; letter-spacing: 0.02em; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="logo">SOCIAL<span>HUB</span></div>
    <div class="nav-item active" onclick="switchPage('home', this)">üè† Global Feed</div>
    <div class="nav-item" onclick="switchPage('earnings', this)">üíé Creator Studio</div>
    <div class="nav-item" onclick="switchPage('profile', this)">üë§ My Profile</div>
    <div class="nav-item" onclick="switchPage('info', this)">‚ÑπÔ∏è Tokenomics</div>
    <div style="margin-top: auto;">
        <div style="font-size: 0.6rem; color: #444; font-weight: 800; margin-bottom: 5px;">HUB BALANCE</div>
        <div style="font-size: 1.4rem; font-weight: 900; color: var(--gold);" id="user-stars">0 ‚òÖ</div>
        <div class="aptm-indicator" id="sidebar-aptm-value">0.00 $APTM</div>
        <div class="price-ticker" id="live-price-display">RATE: $0.34 / APTM</div>
        <button class="action-btn" onclick="convertAPTM()" id="deposit-btn">DEPOSIT $APTM</button>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <div style="font-size: 0.55rem; color: #444; font-weight: 800;">TOTAL LEDGER ANCHORS</div>
            <div style="font-size: 0.9rem; font-weight: 900; color: #fff;" id="total-anchors-display">0</div>
        </div>
    </div>
</div>

<div id="viewport">
    <div class="top-bar">
        <div id="wallet-status" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</div>
    </div>
    <div id="main-content">
        <div id="page-home" class="page active">
            <div class="glass-panel" style="border: 1px solid var(--accent-cyan);">
                <div class="creator-header">
                    <img id="pb-avatar" class="avatar-circle" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                    <b id="pb-handle">Anonymous_Creator</b>
                </div>
                <textarea id="post-text" class="input-field" style="min-height: 60px;" placeholder="What's the signal?"></textarea>
                <input type="text" id="post-media" class="input-field" placeholder="Media URL (Image: 3‚òÖ | Video: 10‚òÖ)" oninput="updatePreview(this.value)">
                <div id="media-preview-container">
                    <div style="font-size:0.6rem; color:var(--accent-cyan); margin-bottom:5px;">MEDIA PREVIEW</div>
                    <img id="preview-img" src="">
                </div>
                <button class="action-btn" style="background: var(--accent-cyan);" onclick="handleBroadcast()">BROADCAST SIGNAL</button>
            </div>
            <div id="feed-items"></div>
            <button id="load-more-btn" class="action-btn" onclick="showNextPage()">LOAD MORE SIGNALS</button>
        </div>

        <div id="page-profile" class="page">
            <h1 style="font-weight:900;">Identity Management</h1>
            <div class="glass-panel">
                <input type="text" id="handle-input" class="input-field" placeholder="@Username">
                <input type="text" id="avatar-input" class="input-field" placeholder="Avatar URL">
                <button class="action-btn" onclick="saveProfile()">SYNC IDENTITY</button>
            </div>
        </div>

        <div id="page-earnings" class="page">
            <h1 style="font-weight:900;">Creator Studio</h1>
            <div class="glass-panel">
                <div style="font-size: 0.7rem; color: #888; letter-spacing: 1px;">CREATOR EARNINGS (STAR ECONOMY)</div>
                <div style="font-size: 2.5rem; font-weight: 900; color: var(--gold);" id="creator-revenue-display">0 ‚òÖ</div>
                <div class="balance-note">‚ö° Active Credits ‚Äî updates on every interaction</div>
                <div style="font-size: 0.7rem; color: #555; margin-top: 6px; margin-bottom: 20px;">Stars earned from Hypes & Comments on your content</div>

                <div style="border-top: 1px solid #222; padding-top: 20px; margin-top: 5px;">
                    <div style="font-size: 0.7rem; color: #888; letter-spacing: 1px;">BLOCKCHAIN BALANCE ($APTM)</div>
                    <div class="aptm-indicator" id="earnings-aptm-value" style="font-size: 1.2rem; margin-top: 6px; margin-bottom: 4px;">0.00 $APTM</div>
                    <div class="balance-note">üîí Blockchain Vault ‚Äî updates on Deposit / Withdrawal only</div>
                </div>

                <button class="action-btn" style="width:auto; padding:15px 30px; margin-top:20px;" onclick="settleToWallet()">SETTLE TO WALLET</button>
            </div>

            <div class="glass-panel">
                <div style="font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; font-weight: 900; margin-bottom: 16px;">üìã RECENT ACTIVITY</div>
                <div id="ledger-list">
                    <div class="ledger-empty">Connect wallet to view your transaction history.</div>
                </div>
            </div>
        </div>

        <div id="page-info" class="page">
            <h1 style="font-weight:900;">Tokenomics</h1>
            <div class="glass-panel">
                <div class="tok-section-title">Broadcast Costs (Platform Fees)</div>
                <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label" style="color:var(--accent-cyan)">Boost Signal to Top (Global Placement)</span><span class="tok-value">10.0 ‚òÖ</span></div>

                <div class="tok-section-title">Interaction Mechanics (Costs)</div>
                <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label">Post a Comment / Reply</span><span class="tok-value">1.0 ‚òÖ</span></div>

                <div class="tok-section-title">Creator Rewards (80% Payout)</div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Receive Comment on your Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Comment</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label">Receive Reply to your Comment</span><span class="tok-value">+0.8 ‚òÖ</span></div>

                <div style="margin-top:25px; padding-top:15px; border-top: 1px solid #333; font-size: 0.75rem; color: #666; line-height: 1.5;">
                    <b style="color:#888;">Protocol Note:</b> The 1.2‚òÖ base broadcast fee and the 20% interaction tax (0.2‚òÖ per action) fuel the platform infrastructure and storage on the permanent ledger.
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast">SUCCESS</div>

<script>
    // GLOBAL STATE
    let currentAptmBalance = "0.0000";
    let starBalance = "0";
    let creatorEarnings = 0;   // ‚òÖ Firebase star economy earnings (separate from blockchain)
    let currentAptmPriceUsd = 0.3391;
    let totalAnchors = 0;
    let provider, signer, hubContract;
    let userAddress = "";

    // ‚úÖ FIX 1: Load identity from localStorage on startup so it's always available
    let userHandle = localStorage.getItem('hub_userName') || "Anonymous_Creator";
    let userAvatar = localStorage.getItem('hub_userPic') || "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";

    let visibleCount = 10;
    const pageSize = 10;
    const STAR_FIXED_USD = 0.01;
    const contractAddress = "0x42E0A97844ac6623207F2a363aa318E83268910F";
    const abi = [
        "function depositAPTM() public payable",
        "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
        "function boostPost(uint256 _oneStarWei) public",
        "function interact(address _recipient, uint256 _oneStarWei) public",
        "function starBalances(address _user) view returns (uint256)",
        "function aptmBalances(address) view returns (uint256)",
        "function totalAnchors() view returns (uint256)",
        "function userWithdraw(uint256 _amountWei) public",
        "function adminWithdraw() public",
        "function PLATFORM_ADMIN() view returns (address)"
    ];

    async function getLiveAptmPrice() {
        const poolAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57"; 
        try {
            if (!provider) return 0.3391;
            const poolContract = new ethers.Contract(poolAddress, [
                "function getReserves() external view returns (uint112, uint112, uint32)"
            ], provider);
            const reserves = await poolContract.getReserves();
            const humanAptm = parseFloat(ethers.utils.formatUnits(reserves[0], 18));
            const humanUsdt = parseFloat(ethers.utils.formatUnits(reserves[1], 18));
            const price = humanUsdt / humanAptm;
            console.log("Price Fixed (18/18 math):", price);
            return price > 0 ? price : 0.3391;
        } catch (e) { 
            console.error("Price Engine Error:", e);
            return 0.3391; 
        }
    }

    async function connectWallet() {
        if (window.ethereum) {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0]; 
                signer = provider.getSigner();
                hubContract = new ethers.Contract(contractAddress, abi, signer);
                
                const statusEl = document.getElementById('wallet-status');
                if(statusEl) statusEl.innerText = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
                
                await syncData(); 
                updateUI(); 
                subscribeToEarnings(userAddress);  // ‚òÖ Live-subscribe to Firebase earnings
                subscribeLedger(userAddress);       // üìã Live-subscribe to transaction ledger
                
                if (typeof loadGlobalFeed === "function") loadGlobalFeed(); 

                showToast("Connected & Synced");
            } catch (err) { 
                console.error(err); 
                showToast("Connection Failed"); 
            }
        } else { 
            alert("MetaMask not found"); 
        }
    }

    async function syncData() {
        if(!hubContract || !signer) return;
        try {
            const addr = await signer.getAddress();
            const [balRaw, anchors] = await Promise.all([
                hubContract.aptmBalances(addr), 
                hubContract.totalAnchors()
            ]);
            const humanBalance = ethers.utils.formatEther(balRaw);
            currentAptmBalance = humanBalance;
            currentAptmPriceUsd = await getLiveAptmPrice();
            const usdValue = parseFloat(humanBalance) * parseFloat(currentAptmPriceUsd);
            starBalance = Math.floor(usdValue / 0.01).toString();
            totalAnchors = anchors.toNumber();
            updateUI();
        } catch (e) { 
            console.error("Master Sync Failed:", e); 
        }
    }

    // ‚úÖ FIX 2: updateUI now also updates the post composer header (pb-avatar and pb-handle)
    function updateUI() {
        try {
            // Sidebar ‚Äî shows blockchain-derived star balance (spending power)
            const sDisp = document.getElementById('user-stars');
            if(sDisp) sDisp.innerText = (starBalance || "0") + " ‚òÖ";
            
            const aDisp = document.getElementById('sidebar-aptm-value');
            if(aDisp) aDisp.innerText = (currentAptmBalance || "0.0000") + " $APTM";

            // Creator Studio ‚Äî earnings from Firebase star economy
            const cStars = document.getElementById('creator-revenue-display');
            if(cStars) cStars.innerText = creatorEarnings.toFixed(1) + " ‚òÖ";

            // Blockchain balance shown separately in Creator Studio
            const cAptm = document.getElementById('earnings-aptm-value');
            if(cAptm) cAptm.innerText = (currentAptmBalance || "0.0000") + " $APTM";
            
            // Price ticker
            const pDisp = document.getElementById('live-price-display');
            if(pDisp) pDisp.innerText = `RATE: $${parseFloat(currentAptmPriceUsd).toFixed(4)} / APTM`;

            // ‚úÖ Post composer header ‚Äî was missing, this is why name/pic didn't show
            const pbAvatar = document.getElementById('pb-avatar');
            if(pbAvatar) pbAvatar.src = userAvatar;

            const pbHandle = document.getElementById('pb-handle');
            if(pbHandle) pbHandle.innerText = userHandle;

            console.log("UI Sync Complete: Stars=" + starBalance + " Earnings=" + creatorEarnings + " Handle=" + userHandle);
        } catch (e) {
            console.error("UI Update Error:", e);
        }
    }

    // ‚úÖ FIX 3: Single, correct saveProfile() ‚Äî saves to localStorage, updates globals, refreshes UI and feed
    function saveProfile() {
        const nameVal = document.getElementById('handle-input').value;
        const picVal = document.getElementById('avatar-input').value;

        if (nameVal && picVal) {
            localStorage.setItem('hub_userName', nameVal);
            localStorage.setItem('hub_userPic', picVal);
            
            userHandle = nameVal;
            userAvatar = picVal;

            updateUI();
            showToast("Identity Saved!");
            loadGlobalFeed(); 
        } else {
            alert("Please enter both a name and an image URL");
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STAR ECONOMY ‚Äî Firebase balance helpers
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Atomically adjust a user's internal star balance in Firebase.
    // amount can be positive (credit) or negative (debit).
    async function adjustFirebaseBalance(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap = await txn.get(ref);
                const current = snap.exists() ? (snap.data().stars || 0) : 0;
                const next = Math.max(0, current + amount);
                txn.set(ref, { stars: next, lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) {
            console.error("Balance adjustment failed for", addr, e);
        }
    }

    // Subscribe to the current user's Firebase earnings ‚Äî live updates Creator Studio.
    function subscribeToEarnings(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref = window.fs.doc(window.db, "user_balances", addr);
        window.fs.onSnapshot(ref, (snap) => {
            if (snap.exists()) {
                creatorEarnings = snap.data().stars || 0;
            } else {
                creatorEarnings = 0;
            }
            // Update only the Creator Studio display (not the sidebar spending balance)
            const cStars = document.getElementById('creator-revenue-display');
            if (cStars) cStars.innerText = creatorEarnings.toFixed(1) + " ‚òÖ";
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRANSACTION LEDGER ‚Äî Firebase `transactions` collection
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Write one transaction record. Fire-and-forget (non-blocking).
    function logTransaction(address, type, amount, description) {
        if (!address || !window.db) return;
        const addr = address.toLowerCase();
        window.fs.addDoc(window.fs.collection(window.db, "transactions"), {
            address: addr,
            type:    type,         // "earn" | "spend" | "deposit" | "settle"
            amount:  amount,       // positive number
            description: description,
            timestamp: Date.now()
        }).catch(e => console.warn("logTransaction failed:", e));
    }

    // Subscribe to the last 10 transactions for this user ‚Äî renders them live.
    function subscribeLedger(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const q = window.fs.query(
            window.fs.collection(window.db, "transactions"),
            window.fs.where("address", "==", addr),
            window.fs.orderBy("timestamp", "desc")
        );

        window.fs.onSnapshot(q, (snapshot) => {
            const el = document.getElementById('ledger-list');
            if (!el) return;

            if (snapshot.empty) {
                el.innerHTML = `<div class="ledger-empty">No activity yet ‚Äî start interacting!</div>`;
                return;
            }

            el.innerHTML = "";
            let count = 0;
            snapshot.forEach((docRef) => {
                if (count >= 10) return; // cap at last 10
                count++;
                const tx = docRef.data();
                const isEarn = tx.type === "earn" || tx.type === "deposit";
                const amountStr = (isEarn ? "+" : "‚àí") + parseFloat(tx.amount).toFixed(1) + " ‚òÖ";
                const cls = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                const date = new Date(tx.timestamp).toLocaleString([], {
                    month: "short", day: "numeric",
                    hour: "2-digit", minute: "2-digit"
                });

                const row = document.createElement('div');
                row.className = 'ledger-row';
                row.innerHTML = `
                    <div class="ledger-desc">
                        ${tx.description}
                        <small>${date}</small>
                    </div>
                    <div class="ledger-amount ${cls}">${amountStr}</div>
                `;
                el.appendChild(row);
            });
        }, (err) => {
            // Fallback if composite index not yet built ‚Äî sort client-side
            console.warn("Ledger listener error, trying fallback:", err.message);
            const fallQ = window.fs.query(
                window.fs.collection(window.db, "transactions"),
                window.fs.where("address", "==", addr)
            );
            window.fs.onSnapshot(fallQ, (snap) => {
                const el = document.getElementById('ledger-list');
                if (!el) return;
                const docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a, b) => b.timestamp - a.timestamp);
                el.innerHTML = "";
                docs.slice(0, 10).forEach(tx => {
                    const isEarn = tx.type === "earn" || tx.type === "deposit";
                    const amountStr = (isEarn ? "+" : "‚àí") + parseFloat(tx.amount).toFixed(1) + " ‚òÖ";
                    const cls = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                    const date = new Date(tx.timestamp).toLocaleString([], {
                        month: "short", day: "numeric",
                        hour: "2-digit", minute: "2-digit"
                    });
                    const row = document.createElement('div');
                    row.className = 'ledger-row';
                    row.innerHTML = `
                        <div class="ledger-desc">${tx.description}<small>${date}</small></div>
                        <div class="ledger-amount ${cls}">${amountStr}</div>
                    `;
                    el.appendChild(row);
                });
            });
        });
    }

    async function convertAPTM() {
        currentAptmPriceUsd = await getLiveAptmPrice();
        let amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
        if(amt && hubContract) { 
            try {
                showToast(`Depositing ${amt} $APTM...`);
                const tx = await hubContract.depositAPTM({ 
                    value: ethers.utils.parseEther(amt),
                    gasLimit: 150000 
                });
                await tx.wait();
                // üìã Log deposit transaction
                const starsReceived = Math.floor(parseFloat(amt) * currentAptmPriceUsd / 0.01);
                logTransaction(userAddress, "deposit", starsReceived, `Deposited ${parseFloat(amt).toFixed(2)} $APTM ‚Üí ${starsReceived} Stars`);
                setTimeout(() => { syncData(); }, 2000);
            } catch (e) {
                console.error(e);
                alert("Transaction failed. Check console for details.");
            }
        }
    }

    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .glass-panel');
        posts.forEach((post, index) => {
            if (index < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const loadMore = document.getElementById('load-more-btn');
        if(loadMore) loadMore.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() {
        visibleCount += pageSize;
        refreshFeedVisibility();
    }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img = document.getElementById('preview-img');
        if(url && url.startsWith('http')) {
            img.src = url;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        if(t) { t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }
    }

    function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        el.classList.add('active');
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    async function handleBroadcast() {
        const txt = document.getElementById('post-text').value;
        const media = document.getElementById('post-media').value;
        if(!txt || !hubContract) return alert("Write something or connect wallet!");

        let feeAmount = "1.2";
        let type = 1;

        if (media) {
            if (media.includes('mp4') || getYoutubeId(media)) {
                feeAmount = "10"; 
                type = 3;
            } else {
                feeAmount = "3"; 
                type = 2;
            }
        }

        const feeWei = ethers.utils.parseEther(feeAmount);

        try {
            const userAddr = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            
            showToast(`Preparing ${feeAmount} Star Broadcast...`);
            
            let tx;
            if (internalStars.gte(feeWei)) {
                showToast("Using internal Stars fund...");
                tx = await hubContract.postContent("", type, feeWei, { gasLimit: 500000 });
            } else {
                showToast(`Paying ${feeAmount} APTM from Wallet...`);
                tx = await hubContract.postContent("", type, feeWei, { 
                    value: feeWei, 
                    gasLimit: 500000 
                });
            }

            await tx.wait();
            showToast("Anchored! Syncing to Cloud...");

            // ‚úÖ Always read identity fresh from localStorage so posts never save as Anonymous
            const postAuthorName = localStorage.getItem('hub_userName') || userHandle;
            const postAuthorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            const postData = {
                text: txt,
                media: media,
                author: postAuthorName,
                authorAddr: userAddr,
                avatar: postAuthorPic,
                timestamp: Date.now(),
                hypes: 0,
                type: type,
                feePaid: feeAmount
            };

            await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

            document.getElementById('post-text').value = "";
            document.getElementById('post-media').value = "";
            showToast("Post Live!");
            // üìã Log broadcast spend
            logTransaction(userAddr, "spend", parseFloat(feeAmount), `Paid ${feeAmount} Stars for Content Broadcast`);
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { 
            console.error(e);
            alert("Broadcast failed. Check your APTM or Stars balance."); 
        }
    }

    async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
        // ‚òÖ STAR ECONOMY: Sender loses 1‚òÖ, Creator gets 0.8‚òÖ, Platform keeps 0.2‚òÖ
        if (parseInt(starBalance) < 1) {
            return alert("Not enough Stars! Please deposit APTM to continue.");
        }

        const inputId = isReply ? `reply-in-${parentId}` : `input-${postId}`;
        const input = document.getElementById(inputId);
        const commentText = input ? input.value.trim() : "";
        if (!commentText) return;

        try {
            // ‚úÖ Always read identity fresh from localStorage
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            const commentData = {
                text: commentText,
                author: authorName,
                authorAddr: userAddress || "unknown",
                avatar: authorPic,
                postId: String(postId),        // ‚òÖ FIX: always a clean string so the query matches
                parentId: parentId || null,
                isReply: isReply,
                timestamp: Date.now(),
                hypes: 0
            };

            // 1. Save comment to Firebase
            await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);

            // 2. 80/20 Split: credit post author 0.8‚òÖ in Firebase
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, 0.8);
                // üìã Log earn for recipient
                logTransaction(recipientAddress, "earn", 0.8, "Earned 0.8 Stars ‚Äî someone commented on your content");
            }

            // 3. Deduct 1‚òÖ from sender's local spending balance
            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();

            // üìã Log spend for sender
            logTransaction(userAddress, "spend", 1, isReply ? "Spent 1 Star on a Reply" : "Spent 1 Star on a Comment");

            // 4. Clear input and keep tray open (do NOT toggle it closed)
            if (input) input.value = "";

            // 5. Make sure the tray is visible (it may not have been opened yet)
            const tray = document.getElementById(`tray-${postId}`);
            if (tray) tray.style.display = 'block';

            showToast("Comment Live! Creator +0.8‚òÖ");
        } catch (e) { 
            console.error("Comment Error:", e);
            showToast("Failed to post. Check connection."); 
        }
    }

    async function settleToWallet() {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const addr = await signer.getAddress();
            const rawBalance = await hubContract.aptmBalances(addr);
            const humanAmount = ethers.utils.formatEther(rawBalance);
            let amt = prompt(`Withdraw Stars\nBalance: ${humanAmount} APTM`, humanAmount);
            if (amt && hubContract) {
                showToast("Opening MetaMask...");
                const withdrawWei = ethers.utils.parseUnits(parseFloat(amt).toFixed(18), 18);
                const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
                await tx.wait();
                // üìã Log settle transaction
                logTransaction(addr, "settle", parseFloat(amt), `Settled ${parseFloat(amt).toFixed(4)} $APTM to wallet`);
                showToast("Success!");
                syncData();
            }
        } catch (e) { console.error(e); alert("Failed: " + (e.reason || e.message).slice(0, 100)); }
    }

    async function boostPost(postId) {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const userAddr = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            const boostFee = ethers.utils.parseEther("10"); 
            
            let tx;
            showToast("Preparing 10-Star Boost...");

            if (internalStars.gte(boostFee)) {
                tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 }); 
            } else {
                tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 }); 
            }

            await tx.wait();
            const postRef = window.fs.doc(window.db, "posts", postId);
            await window.fs.updateDoc(postRef, { timestamp: Date.now(), isBoosted: true });
            showToast("üöÄ POST BOOSTED!");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { 
            console.error(e);
            alert("Boost failed. Ensure you have 10 Stars/APTM."); 
        }
    }

    async function hypeElement(recipientAddress, displayId) {
        // ‚òÖ STAR ECONOMY: Sender -1‚òÖ | Creator +0.8‚òÖ | Platform +0.2‚òÖ (gasless)
        if (parseInt(starBalance) < 1) {
            return alert("Not enough Stars! Please deposit APTM to continue.");
        }

        try {
            // displayId is either "hp-{postId}" for posts or "hc-{commentId}" for comments
            const isComment = displayId.startsWith('hc-');
            const entityId  = displayId.replace(isComment ? 'hc-' : 'hp-', '');

            if (isComment) {
                // Hype on a comment ‚Äî increment the hypes field on the comment doc
                const commentRef = window.fs.doc(window.db, "comments", entityId);
                await window.fs.updateDoc(commentRef, { hypes: window.fs.increment(1) });
            } else {
                // Hype on a post ‚Äî increment the hypes field on the post doc
                const postRef = window.fs.doc(window.db, "posts", entityId);
                await window.fs.updateDoc(postRef, { hypes: window.fs.increment(1) });
            }

            // 80/20 Split: credit recipient 0.8‚òÖ in Firebase
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, 0.8);
                // üìã Log earn for recipient
                const earnDesc = isComment ? "Earned 0.8 Stars ‚Äî someone hyped your comment" : "Earned 0.8 Stars ‚Äî someone hyped your post";
                logTransaction(recipientAddress, "earn", 0.8, earnDesc);
            }

            // Deduct 1‚òÖ from sender's local spending balance
            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();

            // üìã Log spend for sender
            const spendDesc = isComment ? "Spent 1 Star on a Comment Hype" : "Spent 1 Star on a Post Hype";
            logTransaction(userAddress, "spend", 1, spendDesc);

            // Update the hype counter in the UI immediately
            const counterEl = document.getElementById(displayId);
            if (counterEl) counterEl.innerText = (parseInt(counterEl.innerText || "0") + 1);

            showToast("Hype Recorded! ‚ú® Creator +0.8‚òÖ");
        } catch (e) { 
            console.error("Hype Error:", e);
            showToast("Hype failed. Check connection.");
        }
    }

    function toggleTray(id) {
        const t = document.getElementById(`tray-${id}`);
        if (!t) return;
        // Toggle: if currently hidden or not yet shown, open it; otherwise close it
        const isOpen = t.style.display === 'block';
        t.style.display = isOpen ? 'none' : 'block';
    }

    

    async function loadGlobalFeed() {
        const feedContainer = document.getElementById('feed-items');
        if (!feedContainer || !window.db) return;

        const q = window.fs.query(window.fs.collection(window.db, "posts"), window.fs.orderBy("timestamp", "desc"));

        window.fs.onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = ""; 
            // Clear comment listener registry since the DOM elements are gone
            Object.keys(_commentListeners).forEach(k => {
                if (typeof _commentListeners[k] === 'function') _commentListeners[k](); // unsubscribe
                delete _commentListeners[k];
            });
            snapshot.forEach((docRef) => {
                const post = docRef.data();
                const postId = docRef.id;

                const isMe = (post.authorAddr && userAddress && post.authorAddr.toLowerCase() === userAddress.toLowerCase());
                const localName = localStorage.getItem('hub_userName');
                const localPic = localStorage.getItem('hub_userPic');

                const displayPic = (isMe && localPic) ? localPic : (post.avatar || "https://via.placeholder.com/50");
                const displayName = (isMe && localName) ? localName : (post.author || "Anonymous");

                let mediaHtml = '';
                const ytId = getYoutubeId(post.media || "");
                if(ytId) {
                    mediaHtml = `<div class="post-media-container"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
                } else if(post.media) {
                    mediaHtml = `<div class="post-media-container"><img src="${post.media}"></div>`;
                }

                const item = document.createElement('div');
                item.className = 'glass-panel post-card';
                item.setAttribute('data-id', postId);
                if(post.isBoosted) item.style.border = "2px solid #FFD700"; 
                
                item.innerHTML = `
                    <div class='creator-header'>
                        <img src="${displayPic}" class="avatar-circle">
                        <b>${displayName}</b>
                    </div>
                    ${mediaHtml}
                    <p>${post.text}</p>
                    <div class="feed-actions">
                        <div class="feed-btn" onclick="hypeElement('${post.authorAddr}', 'hp-${postId}')">‚ù§Ô∏è Hype <span id="hp-${postId}">${post.hypes || 0}</span></div>
                        <div class="feed-btn" onclick="toggleTray('${postId}'); loadComments('${postId}')">üí¨ Comments <span id="cc-${postId}" style="color:var(--accent-cyan)"></span></div>
                        <div class="feed-btn" style="color:#FFD700" onclick="boostPost('${postId}')">üöÄ Boost (10‚òÖ)</div>
                    </div>
                    <div class="comment-area" id="tray-${postId}">
                        <div class="comment-list" id="list-${postId}"></div>
                        <div style="display:flex; gap:10px;">
                            <input type="text" class="input-field" style="margin-top:0;" placeholder="Add (1‚òÖ)" id="input-${postId}">
                            <button class="action-btn" style="margin-top:0; width:80px;" onclick="addComment('${post.authorAddr}', '${postId}')">SEND</button>
                        </div>
                    </div>`;
                feedContainer.appendChild(item);
            });
            if (typeof refreshFeedVisibility === "function") refreshFeedVisibility();
        });
    }

    // Track active comment listeners so we don't create duplicates
    const _commentListeners = {};

    async function loadComments(postId) {
        const list = document.getElementById(`list-${postId}`);
        if (!list || !window.db) return;

        // If we already have a live listener for this post, don't add another
        if (_commentListeners[postId]) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "comments"),
            window.fs.where("postId", "==", String(postId)),
            window.fs.orderBy("timestamp", "asc")
        );

        const renderComments = (snapshot) => {
            list.innerHTML = "";

            // Separate top-level comments from replies
            const topLevel = [];
            const repliesMap = {}; // parentId ‚Üí [reply, ...]
            snapshot.forEach((docRef) => {
                const data = { ...docRef.data(), _id: docRef.id };
                if (data.parentId) {
                    if (!repliesMap[data.parentId]) repliesMap[data.parentId] = [];
                    repliesMap[data.parentId].push(data);
                } else {
                    topLevel.push(data);
                }
            });

            // Update the comment counter on the feed button
            const totalCount = snapshot.size;
            const counterEl = document.getElementById(`cc-${postId}`);
            if (counterEl) counterEl.innerText = totalCount > 0 ? `(${totalCount})` : '';

            if (topLevel.length === 0 && Object.keys(repliesMap).length === 0) {
                list.innerHTML = `<div style="font-size:0.75rem; color:#555; padding:8px;">No comments yet. Be first!</div>`;
                return;
            }

            // Render a single comment row (used for both top-level and replies)
            const renderRow = (comment, isNested = false) => {
                const cId = comment._id;
                const authorAddr = comment.authorAddr || "unknown";
                const hypeCount = comment.hypes || 0;

                const row = document.createElement('div');
                row.className = 'comment-row';
                if (isNested) {
                    row.style.marginLeft = '18px';
                    row.style.borderLeft = '2px solid #333';
                    row.style.paddingLeft = '12px';
                    row.style.background = 'rgba(255,255,255,0.02)';
                }

                row.innerHTML = `
                    <div style="font-size:0.85rem;">
                        <b style="color:#FFD700;">${comment.author || "Anonymous"}</b>: ${comment.text}
                    </div>
                    <div class="comment-actions">
                        <span class="comment-btn" onclick="hypeElement('${authorAddr}', 'hc-${cId}')">
                            ‚ù§Ô∏è <span id="hc-${cId}">${hypeCount}</span>
                        </span>
                        ${!isNested ? `<span class="comment-btn reply-btn" onclick="toggleReplyInput('${cId}')">‚Ü©Ô∏è Reply</span>` : ''}
                    </div>
                    ${!isNested ? `
                    <div class="reply-input-area" id="reply-area-${cId}">
                        <div class="reply-input-row">
                            <input type="text" class="input-field" id="reply-in-${cId}" placeholder="Reply... (1‚òÖ)">
                            <button class="reply-send-btn" onclick="addComment('${authorAddr}', '${postId}', true, '${cId}')">SEND</button>
                        </div>
                    </div>` : ''}
                `;
                return row;
            };

            // Render top-level comments and their replies beneath each
            topLevel.forEach(comment => {
                list.appendChild(renderRow(comment, false));

                const replies = repliesMap[comment._id] || [];
                replies.forEach(reply => {
                    list.appendChild(renderRow(reply, true));
                });
            });
        };

        // Store the unsubscribe function ‚Äî primary listener with orderBy
        _commentListeners[postId] = window.fs.onSnapshot(q, renderComments, (err) => {
            console.error("Comment listener error for", postId, "‚Äî falling back:", err.message);
            // Fallback: no orderBy (avoids composite index requirement)
            const fallbackQ = window.fs.query(
                window.fs.collection(window.db, "comments"),
                window.fs.where("postId", "==", String(postId))
            );
            _commentListeners[postId] = window.fs.onSnapshot(fallbackQ, (snapshot) => {
                // Sort client-side instead
                const sorted = { forEach: (fn) => {
                    const docs = [];
                    snapshot.forEach(d => docs.push({ ...d, data: () => d.data(), id: d.id }));
                    docs.sort((a, b) => (a.data().timestamp || 0) - (b.data().timestamp || 0));
                    docs.forEach(fn);
                }, size: snapshot.size };
                renderComments(sorted);
            });
        });
    }

    function toggleReplyInput(commentId) {
        const area = document.getElementById(`reply-area-${commentId}`);
        if (!area) return;
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            // Focus the input when opened
            const inp = document.getElementById(`reply-in-${commentId}`);
            if (inp) setTimeout(() => inp.focus(), 50);
        }
    }

    // STARTUP
    window.addEventListener('load', async () => {
        try {
            // ‚úÖ FIX 4: Paint the identity immediately on load from localStorage (before any async calls)
            updateUI();

            const p = await getLiveAptmPrice();
            currentAptmPriceUsd = p;
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet(); 
            }
            setTimeout(() => { loadGlobalFeed(); }, 1500);
        } catch (e) { 
            console.error("Startup failed", e); 
        }
    });

    // HEARTBEAT
    setInterval(async () => { 
        if (provider && hubContract) {
            try {
                currentAptmPriceUsd = await getLiveAptmPrice();
                await syncData();
                console.log("Heartbeat Sync: Dashboard Updated.");
            } catch (e) {
                console.error("Heartbeat failed:", e);
            }
        }
    }, 30000);
</script> 
</body>
</html>
