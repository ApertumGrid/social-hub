
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIALHUB ‚Äî Signal Protocol v10</title>

    <!-- 1. Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <!-- 2. Irys WebIrys browser SDK -->
    <script src="https://gateway.irys.xyz/sdk/v0.2.8"></script>

    <!-- 3. Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
            authDomain: "socialhub-33014.firebaseapp.com",
            projectId: "socialhub-33014",
            storageBucket: "socialhub-33014.firebasestorage.app",
            messagingSenderId: "864088350104",
            appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
            measurementId: "G-B2C1K1LVGQ"
        };
        const app = initializeApp(firebaseConfig);
        const db  = getFirestore(app);
        const storage = getStorage(app);
        window.db = db;
        window.storage = storage;
        window.fs = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc };
        window.fsStorage = { ref, uploadBytesResumable, getDownloadURL };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-outer:    #0d1117;
            --bg-app:      #161b27;
            --bg-panel:    #1c2333;
            --bg-card:     #222a3a;
            --bg-card2:    #1e2638;
            --bg-input:    #151c2c;
            --bg-hover:    #263046;
            --border:      rgba(255,255,255,0.07);
            --border-md:   rgba(255,255,255,0.11);
            --purple:      #7c5cbf;
            --purple-lt:   #9b7de0;
            --purple-dim:  rgba(124,92,191,0.18);
            --purple-glow: rgba(124,92,191,0.08);
            --teal:        #2dd4bf;
            --teal-dim:    rgba(45,212,191,0.12);
            --gold:        #f0b429;
            --green:       #3ecf8e;
            --red:         #f87171;
            --text-primary:   #e8ecf4;
            --text-secondary: #8892a4;
            --text-muted:     #4e5a6e;
            --text-white:     #ffffff;
            --glow-warm: rgba(160,60,40,0.18);
            --glow-teal: rgba(30,80,100,0.22);
            --radius-sm:  8px;
            --radius-md:  12px;
            --radius-lg:  16px;
            --radius-xl:  20px;
            --font-body: 'Sora', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --bottom-nav-h: 60px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        body {
            font-family: var(--font-body);
            background: var(--bg-outer);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background:
                radial-gradient(ellipse 55% 45% at 0% 0%,   var(--glow-warm) 0%, transparent 65%),
                radial-gradient(ellipse 45% 55% at 100% 100%, var(--glow-teal) 0%, transparent 65%),
                radial-gradient(ellipse 30% 30% at 50% 50%,  rgba(20,28,50,0.6) 0%, transparent 100%);
        }

        body::after {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            opacity: 0.18;
            background-image: radial-gradient(circle, rgba(100,120,180,0.4) 1px, transparent 1px);
            background-size: 28px 28px;
        }

        /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
        #app-shell {
            position: relative; z-index: 5;
            width: min(1120px, 97vw);
            height: min(820px, 96vh);
            background: var(--bg-app);
            border-radius: 24px;
            border: 1px solid var(--border-md);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
        }

        /* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
        #topnav {
            height: 60px; flex-shrink: 0;
            display: flex; align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            gap: 16px;
        }
        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.1rem; font-weight: 700;
            color: var(--text-white); letter-spacing: -0.3px;
        }
        .brand-icon {
            width: 30px; height: 30px; border-radius: 8px;
            background: var(--purple-dim);
            border: 1px solid rgba(124,92,191,0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .topnav-mid { flex-grow: 1; }
        .topnav-right { display: flex; align-items: center; gap: 12px; }
        .user-pill {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 14px 6px 6px;
            border-radius: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .user-pill img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .user-pill-name { font-size: 0.78rem; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .user-pill-sub  { font-size: 0.65rem; color: var(--text-secondary); }
        #wallet-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            background: transparent;
            border: 1px solid var(--border-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.78rem; font-weight: 600;
            cursor: pointer;
            transition: all 0.18s;
            white-space: nowrap;
        }
        #wallet-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); background: var(--purple-glow); }
        .wallet-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--teal); flex-shrink: 0; }

        /* ‚îÄ‚îÄ BODY LAYOUT ‚îÄ‚îÄ */
        #body-layout {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 200px 1fr 240px;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */
        #sidebar {
            border-right: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex; flex-direction: column;
            padding: 16px 10px;
            overflow-y: auto;
        }
        .nav-item {
            display: flex; align-items: center; gap: 11px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.82rem; font-weight: 500;
            transition: all 0.15s;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .nav-icon { font-size: 0.95rem; width: 18px; text-align: center; flex-shrink: 0; opacity: 0.85; }
        .nav-badge {
            margin-left: auto;
            font-family: var(--font-mono);
            font-size: 0.58rem; font-weight: 600;
            color: var(--purple-lt);
            background: var(--purple-dim);
            border-radius: 50px; padding: 2px 7px;
            white-space: nowrap;
        }
        .sidebar-section { margin-top: 16px; margin-bottom: 6px; }
        .sidebar-section-label {
            font-size: 0.6rem; font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 1.5px; text-transform: uppercase;
            padding: 0 12px; margin-bottom: 6px;
        }
        .sidebar-vault {
            padding: 14px;
            background: var(--bg-card2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-top: 12px;
        }
        .vault-label { font-size: 0.58rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 3px; }
        .vault-stars { font-family: var(--font-mono); font-size: 1.3rem; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
        .vault-aptm  { font-size: 0.72rem; color: var(--teal); font-weight: 600; margin-bottom: 2px; }
        .vault-rate  { font-family: var(--font-mono); font-size: 0.58rem; color: var(--text-muted); }

        /* ‚îÄ‚îÄ FEED COLUMN ‚îÄ‚îÄ */
        #feed-col {
            overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 14px;
        }
        #feed-col::-webkit-scrollbar { width: 3px; }
        #feed-col::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }
        .feed-heading { font-size: 1rem; font-weight: 700; color: var(--text-white); margin-bottom: 4px; }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            transition: border-color 0.15s;
        }
        .card:hover { border-color: var(--border-md); }

        .composer-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .av { width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border-md); object-fit: cover; flex-shrink: 0; }
        .composer-name { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .composer-sub  { font-size: 0.65rem; color: var(--text-secondary); }

        .field {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            padding: 10px 14px;
            outline: none;
            resize: none;
            transition: border-color 0.15s;
            margin-top: 8px;
        }
        .field:focus { border-color: rgba(124,92,191,0.4); }
        .field::placeholder { color: var(--text-muted); }

        /* Media tabs */
        .media-tabs { display: flex; gap: 6px; margin-top: 10px; }
        .mtab {
            flex: 1; padding: 7px; border-radius: var(--radius-sm);
            font-size: 0.72rem; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border); color: var(--text-secondary);
            background: transparent; text-align: center;
            transition: all 0.13s;
        }
        .mtab.active { color: var(--purple-lt); border-color: rgba(124,92,191,0.35); background: var(--purple-dim); }

        .upload-zone {
            border: 1.5px dashed rgba(124,92,191,0.3);
            border-radius: var(--radius-md);
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            position: relative;
            transition: all 0.18s;
            background: rgba(124,92,191,0.04);
        }
        .upload-zone:hover { border-color: var(--purple-lt); background: var(--purple-dim); }
        .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .upload-zone-text { font-size: 0.78rem; color: var(--text-secondary); pointer-events: none; }
        .upload-zone-text strong { display: block; color: var(--purple-lt); font-size: 0.82rem; margin-bottom: 3px; }

        /* ‚îÄ‚îÄ UPLOAD PROGRESS BAR (NEW V10) ‚îÄ‚îÄ */
        #upload-progress-wrap {
            display: none;
            margin-top: 10px;
        }
        .progress-label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.68rem; color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .progress-label span { font-family: var(--font-mono); color: var(--purple-lt); font-weight: 600; }
        .progress-track {
            width: 100%; height: 6px;
            background: var(--bg-input);
            border-radius: 99px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 99px;
            background: linear-gradient(90deg, var(--purple), var(--teal));
            transition: width 0.2s ease;
            box-shadow: 0 0 8px rgba(124,92,191,0.5);
        }
        .progress-status {
            font-size: 0.64rem; color: var(--text-muted);
            margin-top: 5px; font-family: var(--font-mono);
        }

        #irys-status {
            font-size: 0.7rem; margin-top: 8px; padding: 7px 12px;
            border-radius: var(--radius-sm);
            background: var(--purple-dim); border: 1px solid rgba(124,92,191,0.2);
            color: var(--purple-lt); display: none;
        }

        .fee-display {
            font-family: var(--font-mono);
            font-size: 0.62rem; color: var(--text-muted);
            text-align: right; margin-top: 6px;
        }

        /* Buttons */
        .btn {
            padding: 9px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-family: var(--font-body);
            font-weight: 600; font-size: 0.82rem;
            cursor: pointer; transition: all 0.16s;
        }
        .btn-purple {
            background: var(--purple);
            color: #fff;
            width: 100%; margin-top: 12px;
        }
        .btn-purple:hover { background: var(--purple-lt); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,92,191,0.3); }
        .btn-outline {
            background: transparent; border: 1px solid var(--border-md);
            color: var(--text-secondary); width: 100%; margin-top: 10px;
        }
        .btn-outline:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        .btn-sm { padding: 6px 13px; font-size: 0.75rem; border-radius: var(--radius-sm); }
        .btn-teal { background: var(--teal); color: #0d1117; font-weight: 700; }
        .btn-teal:hover { filter: brightness(1.08); }

        /* Post cards */
        .post-card { animation: fadeUp 0.25s ease both; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .post-meta { flex-grow: 1; }
        .post-author { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .post-addr   { font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .post-more   { color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px 8px; border-radius: 6px; }
        .post-more:hover { background: var(--bg-hover); color: var(--text-primary); }
        .boosted-badge {
            font-family: var(--font-mono); font-size: 0.58rem; font-weight: 700;
            background: rgba(240,180,41,0.1); border: 1px solid rgba(240,180,41,0.3);
            color: var(--gold); padding: 2px 9px; border-radius: 50px;
        }
        .post-body  { font-size: 0.88rem; line-height: 1.6; color: var(--text-primary); margin-bottom: 12px; }
        .post-media {
            width: 100%; border-radius: var(--radius-md); overflow: hidden;
            margin-bottom: 12px; background: #000;
            max-height: 320px;
            display: flex; justify-content: center;
            border: 1px solid var(--border);
        }
        .post-media img  { width: 100%; max-height: 320px; object-fit: cover; display: block; }
        .post-media iframe { width: 100%; height: 260px; border: none; }

        .arweave-tag {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.58rem;
            background: var(--purple-dim); border: 1px solid rgba(124,92,191,0.25);
            color: var(--purple-lt); padding: 2px 8px; border-radius: 4px;
            margin-bottom: 8px;
        }
        .a-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--purple-lt); animation: blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.2;} }

        .post-actions {
            display: flex; align-items: center; gap: 4px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .pact {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 50px;
            font-size: 0.76rem; font-weight: 500;
            cursor: pointer; color: var(--text-secondary);
            background: transparent; border: 1px solid transparent;
            transition: all 0.13s;
        }
        .pact:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .pact.boost:hover { color: var(--gold); border-color: rgba(240,180,41,0.3); background: rgba(240,180,41,0.06); }
        .pact-num { font-family: var(--font-mono); font-size: 0.7rem; }

        /* Comment tray */
        .comment-tray { display: none; padding-top: 14px; border-top: 1px dashed rgba(255,255,255,0.05); margin-top: 12px; }
        .comment-list { max-height: 320px; overflow-y: auto; margin-bottom: 10px; }
        .cmt-row {
            padding: 10px 12px; border-radius: var(--radius-md);
            background: var(--bg-input); border: 1px solid var(--border);
            margin-bottom: 7px; font-size: 0.82rem; color: var(--text-primary);
            line-height: 1.5;
        }
        .cmt-row.nested {
            margin-left: 18px;
            border-left: 2px solid rgba(124,92,191,0.25);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            background: rgba(124,92,191,0.04);
        }
        .cmt-author { color: var(--gold); font-weight: 700; }
        .cmt-meta { display: flex; gap: 8px; margin-top: 8px; }
        .cbtn {
            font-size: 0.68rem; font-weight: 600; cursor: pointer;
            padding: 3px 9px; border-radius: 5px;
            border: 1px solid var(--border); color: var(--text-muted);
            background: transparent; transition: all 0.12s;
        }
        .cbtn:hover { color: var(--teal); border-color: rgba(45,212,191,0.3); }
        .cbtn.reply:hover { color: var(--purple-lt); border-color: rgba(124,92,191,0.3); }
        .reply-area { display: none; margin-top: 8px; }
        .reply-row  { display: flex; gap: 7px; }
        .reply-row .field { margin-top: 0; flex: 1; }
        .cmt-input-row { display: flex; gap: 8px; }
        .cmt-input-row .field { margin-top: 0; flex: 1; }

        /* ‚îÄ‚îÄ CLOSE COMMENTS BUTTON (NEW V10) ‚îÄ‚îÄ */
        .close-comments-btn {
            display: block;
            width: 100%;
            padding: 7px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            transition: all 0.13s;
        }
        .close-comments-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); background: var(--purple-glow); }

        /* Right panel */
        #right-panel {
            border-left: 1px solid var(--border);
            background: var(--bg-panel);
            overflow-y: auto;
            padding: 16px 14px;
            display: flex; flex-direction: column; gap: 14px;
        }
        #right-panel::-webkit-scrollbar { width: 3px; }
        #right-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .rp-heading {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; font-weight: 700; color: var(--text-white);
            margin-bottom: 10px;
        }
        .rp-card {
            background: var(--bg-card2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 14px;
        }
        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid var(--border);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-label span { display: block; font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
        .stat-val { font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700; color: var(--text-white); }
        .stat-val.gold   { color: var(--gold); }
        .stat-val.teal   { color: var(--teal); }
        .stat-val.purple { color: var(--purple-lt); }
        .stat-val.green  { color: var(--green); }

        /* Ledger */
        .ledger-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); gap: 8px;
        }
        .ledger-row:last-child { border-bottom: none; }
        .ledger-desc { font-size: 0.75rem; color: var(--text-secondary); flex: 1; line-height: 1.4; }
        .ledger-desc small { display: block; font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .ledger-badge {
            font-family: var(--font-mono); font-size: 0.52rem; font-weight: 700;
            padding: 2px 7px; border-radius: 4px; text-transform: uppercase;
            width: 58px; text-align: center; flex-shrink: 0;
        }
        .ledger-badge.earn    { background: rgba(62,207,142,0.12); color: var(--green); }
        .ledger-badge.spend   { background: rgba(248,113,113,0.12); color: var(--red); }
        .ledger-badge.deposit { background: var(--teal-dim); color: var(--teal); }
        .ledger-badge.settle  { background: var(--purple-dim); color: var(--purple-lt); }
        .ledger-amount { font-family: var(--font-mono); font-size: 0.76rem; font-weight: 700; width: 58px; text-align: right; flex-shrink: 0; }
        .ledger-amount.earn    { color: var(--green); }
        .ledger-amount.spend   { color: var(--red); }
        .ledger-amount.neutral { color: var(--text-muted); }
        .ledger-empty { font-size: 0.72rem; color: var(--text-muted); padding: 14px 0; text-align: center; }

        /* Admin panel ‚Äî hidden by default, shown for admin wallet only */
        #admin-revenue-panel { display: none; }

        /* ‚îÄ‚îÄ ADMIN WITHDRAW BUTTON (NEW V10) ‚îÄ‚îÄ */
        #admin-withdraw-btn {
            display: inline-flex; align-items: center; gap: 8px;
            margin-top: 12px;
            padding: 9px 18px;
            background: linear-gradient(135deg, rgba(240,180,41,0.2), rgba(240,180,41,0.08));
            border: 1px solid rgba(240,180,41,0.4);
            border-radius: var(--radius-md);
            color: var(--gold);
            font-family: var(--font-body);
            font-size: 0.8rem; font-weight: 700;
            cursor: pointer;
            transition: all 0.18s;
            letter-spacing: 0.3px;
        }
        #admin-withdraw-btn:hover { background: rgba(240,180,41,0.18); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(240,180,41,0.15); }

        /* Tokenomics */
        .tok-section {
            font-family: var(--font-mono); font-size: 0.56rem;
            color: var(--gold); letter-spacing: 2.5px;
            text-transform: uppercase; margin: 18px 0 8px; font-weight: 700;
        }
        .tok-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 0.84rem;
        }
        .tok-row:last-of-type { border-bottom: none; }
        .tok-label { color: var(--text-secondary); }
        .tok-value { font-family: var(--font-mono); font-weight: 700; color: var(--purple-lt); font-size: 0.8rem; }

        /* Page system */
        .page { display: none; }
        .page.active { display: contents; }
        #page-home { display: contents; }

        /* Misc */
        .hidden-post { display: none !important; }
        #load-more-btn { display: none; background: transparent; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; width: 100%; margin-top: 4px; }
        #load-more-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        #media-preview-container { display: none; margin-top: 10px; border-radius: var(--radius-md); overflow: hidden; background: #000; border: 1px solid var(--border); }
        #preview-img { max-width: 100%; max-height: 200px; display: block; margin: 0 auto; }

        /* Toast */
        #toast {
            position: fixed; bottom: 22px; right: 22px; z-index: 9999;
            background: var(--bg-card);
            border: 1px solid rgba(124,92,191,0.35);
            color: var(--purple-lt);
            font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
            padding: 10px 20px; border-radius: var(--radius-md);
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            transform: translateY(8px); letter-spacing: 0.4px;
        }
        #toast.show { opacity: 1; transform: translateY(0); }

        .page-heading { font-size: 1.1rem; font-weight: 700; color: var(--text-white); margin-bottom: 14px; }
        .page-heading span { color: var(--purple-lt); }

        .info-box {
            padding: 12px 14px; background: var(--purple-dim);
            border: 1px solid rgba(124,92,191,0.2);
            border-radius: var(--radius-md);
            font-size: 0.78rem; color: var(--text-secondary);
            line-height: 1.6; margin-bottom: 14px;
        }
        .info-box strong { color: var(--purple-lt); }
        .balance-note { font-size: 0.62rem; color: var(--text-muted); margin-top: 2px; }

        /* Sparkline */
        .sparkline {
            height: 50px; border-radius: var(--radius-sm);
            background: var(--bg-input);
            margin: 10px 0 4px;
            position: relative; overflow: hidden;
        }
        .sparkline::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--purple-lt), var(--teal), transparent);
            opacity: 0.4;
        }
        .sparkline-line {
            position: absolute; bottom: 10px; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, var(--purple-lt), var(--teal));
            clip-path: polygon(0 60%, 15% 30%, 30% 55%, 45% 20%, 60% 40%, 75% 15%, 90% 35%, 100% 25%, 100% 100%, 0 100%);
        }

        /* ‚îÄ‚îÄ FIREBASE STORAGE BADGE ‚îÄ‚îÄ */
        .firebase-tag {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.58rem;
            background: rgba(255,160,0,0.1); border: 1px solid rgba(255,160,0,0.25);
            color: #ffb300; padding: 2px 8px; border-radius: 4px;
            margin-bottom: 8px;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           MOBILE RESPONSIVE ‚Äî < 768px  (NEW V10)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        @media (max-width: 768px) {
            body { align-items: stretch; justify-content: stretch; }

            #app-shell {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            /* Hide sidebars on mobile */
            #sidebar, #right-panel { display: none !important; }

            #body-layout {
                grid-template-columns: 1fr;
            }

            #feed-col {
                padding: 12px;
                padding-bottom: calc(var(--bottom-nav-h) + 20px);
            }

            /* Edge-to-edge media on mobile */
            .post-card {
                border-radius: var(--radius-md);
                padding: 14px 0;
                background: transparent;
                border: none;
                border-bottom: 1px solid var(--border);
                border-radius: 0;
            }
            .post-card .post-header,
            .post-card .post-body,
            .post-card .post-actions,
            .post-card .comment-tray {
                padding-left: 14px;
                padding-right: 14px;
            }
            .post-media {
                width: 100%;
                max-height: none;
                border-radius: 0;
                border-left: none;
                border-right: none;
                margin-bottom: 12px;
            }
            .post-media img { max-height: 60vw; }
            .post-media iframe { height: 56vw; }

            /* Composer card on mobile */
            .card { border-radius: var(--radius-md); }

            /* Top nav on mobile ‚Äî compact */
            #topnav { padding: 0 14px; }
            .user-pill-name { display: none; }
            .user-pill-sub  { display: none; }
            .user-pill { padding: 5px; }

            /* Bottom navigation bar */
            #bottom-nav {
                display: flex;
            }

            /* Hide toast above bottom nav */
            #toast { bottom: calc(var(--bottom-nav-h) + 14px); }
        }

        /* ‚îÄ‚îÄ BOTTOM NAVIGATION BAR (NEW V10, mobile only) ‚îÄ‚îÄ */
        #bottom-nav {
            display: none; /* shown only on mobile via media query */
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-h);
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            z-index: 100;
            align-items: stretch;
        }
        .bnav-item {
            flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.6rem; font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.15s;
            border: none; background: transparent;
            text-transform: uppercase;
        }
        .bnav-item .bnav-icon { font-size: 1.2rem; }
        .bnav-item.active { color: var(--purple-lt); }
        .bnav-item:hover  { color: var(--text-primary); }
        /* Post button ‚Äî special */
        .bnav-post {
            background: var(--purple);
            color: #fff !important;
            border-radius: 14px;
            margin: 8px 10px;
            flex: 1.2;
        }
        .bnav-post:hover { background: var(--purple-lt); }
    </style>
</head>
<body>

<div id="app-shell">

    <!-- TOP NAV -->
    <div id="topnav">
        <div class="brand">
            <div class="brand-icon">‚óà</div>
            SOCIALHUB
        </div>
        <div class="topnav-mid"></div>
        <div class="topnav-right">
            <div class="user-pill">
                <img id="nav-avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                <div>
                    <div class="user-pill-name" id="nav-handle">Anonymous</div>
                    <div class="user-pill-sub">Creator</div>
                </div>
            </div>
            <button id="wallet-btn" onclick="connectWallet()">
                <span class="wallet-dot"></span>
                <span id="wallet-status">Connect Wallet</span>
            </button>
        </div>
    </div>

    <!-- BODY LAYOUT -->
    <div id="body-layout">

        <!-- LEFT SIDEBAR -->
        <div id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-section-label">Navigation</div>
                <div class="nav-item active" id="nav-home" onclick="switchPage('home', this)"><span class="nav-icon">‚äû</span> Home Feed</div>
                <div class="nav-item" id="nav-earnings" onclick="switchPage('earnings', this)">
                    <span class="nav-icon">‚óÜ</span> Creator Studio
                    <span class="nav-badge" id="sidebar-stars-badge">0 ‚òÖ</span>
                </div>
                <div class="nav-item" id="nav-profile" onclick="switchPage('profile', this)"><span class="nav-icon">‚óâ</span> My Profile</div>
                <div class="nav-item" id="nav-info" onclick="switchPage('info', this)"><span class="nav-icon">‚óé</span> Tokenomics</div>
            </div>

            <div class="sidebar-vault">
                <div class="vault-label">Active Stars</div>
                <div class="vault-stars" id="user-stars">0 ‚òÖ</div>
                <div class="vault-label" style="margin-top:8px;">APTM Vault</div>
                <div class="vault-aptm" id="sidebar-aptm-value">0.0000 $APTM</div>
                <div class="vault-rate" id="live-price-display">$0.3391 / APTM</div>
                <button class="btn btn-purple btn-sm" style="margin-top:12px; width:100%; font-size:0.72rem;" onclick="convertAPTM()">DEPOSIT $APTM</button>
            </div>

            <div style="padding: 10px 0 4px; border-top: 1px solid var(--border); margin-top: 12px;">
                <div class="vault-label" style="padding:0 2px; margin-bottom:4px;">Total Anchors</div>
                <div style="font-family:var(--font-mono); font-size:0.9rem; font-weight:700; color:var(--text-white);" id="total-anchors-display">0</div>
            </div>
        </div>

        <!-- FEED COLUMN -->
        <div id="feed-col">

            <!-- HOME PAGE -->
            <div id="page-home" style="display:contents;">
                <div class="feed-heading">Signal Feed</div>

                <!-- Compose -->
                <div class="card" style="border-color: rgba(124,92,191,0.25);">
                    <div class="composer-row">
                        <img id="pb-avatar" class="av" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                        <div>
                            <div class="composer-name" id="pb-handle">Anonymous_Creator</div>
                            <div class="composer-sub">Broadcasting to the network</div>
                        </div>
                    </div>

                    <textarea id="post-text" class="field" style="min-height:64px;" placeholder="What's your signal?"></textarea>

                    <div class="media-tabs">
                        <div class="mtab active" id="tab-url"  onclick="setMediaTab('url')">üîó URL</div>
                        <div class="mtab"        id="tab-file" onclick="setMediaTab('file')">‚òÅ Firebase Upload</div>
                    </div>

                    <!-- URL input panel -->
                    <div id="url-input-wrap">
                        <input type="text" id="post-media" class="field" placeholder="Image URL (3.0‚òÖ) ¬∑ Video URL (10.0‚òÖ)" oninput="updatePreview(this.value)">
                        <div id="media-preview-container">
                            <img id="preview-img" src="">
                        </div>
                    </div>

                    <!-- Firebase file upload panel -->
                    <div id="file-input-wrap" style="display:none;">
                        <div class="upload-zone">
                            <input type="file" id="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                            <div class="upload-zone-text">
                                <strong>‚Üë Click or drop to upload</strong>
                                Stored on <span style="color:#ffb300;">Firebase Storage</span>.<br>
                                <span style="font-size:0.68rem; color:var(--text-muted);">No MetaMask required for upload.</span>
                            </div>
                        </div>
                        <div id="file-preview-wrap" style="display:none; margin-top:10px;">
                            <img   id="file-preview-img" style="max-width:100%; border-radius:10px; display:none;">
                            <video id="file-preview-vid" controls style="max-width:100%; border-radius:10px; display:none;"></video>
                            <div id="file-info" style="font-size:0.7rem; color:var(--text-muted); margin-top:5px;"></div>
                        </div>
                    </div>

                    <!-- UPLOAD PROGRESS BAR (NEW V10) -->
                    <div id="upload-progress-wrap">
                        <div class="progress-label">
                            <span id="progress-label-text">Uploading to Firebase‚Ä¶</span>
                            <span id="progress-pct">0%</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-status" id="progress-status">Preparing‚Ä¶</div>
                    </div>

                    <div id="irys-status"></div>
                    <div class="fee-display" id="post-fee-display"></div>
                    <button class="btn btn-purple" onclick="handleBroadcast()">‚óà Broadcast Signal</button>
                </div>

                <div id="feed-items"></div>
                <button id="load-more-btn" class="btn" onclick="showNextPage()">Load More Signals</button>
            </div>

            <!-- CREATOR STUDIO PAGE -->
            <div id="page-earnings" class="page">
                <div class="page-heading">Creator <span>Studio</span></div>

                <div class="card">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">Active Stars</div>
                            <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold);" id="creator-revenue-display">0 ‚òÖ</div>
                            <div class="balance-note">‚ö° Live ledger</div>
                        </div>
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">APTM Vault</div>
                            <div style="font-family:var(--font-mono); font-size:0.95rem; font-weight:700; color:var(--teal); margin-top:6px;" id="earnings-aptm-value">0.0000 $APTM</div>
                            <div class="balance-note">üîí On-chain</div>
                        </div>
                    </div>
                    <div class="info-box">
                        <strong>How it works:</strong> Stars power instant interactions on the internal ledger. Click <strong>Settle to Wallet</strong> to convert to $APTM on-chain.
                    </div>
                    <button class="btn btn-teal" style="width:auto; padding:10px 24px;" onclick="settleToWallet()">Settle to Wallet ‚Üí</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--text-white);">Recent Activity</div>
                        <div style="font-size:0.62rem; color:var(--text-muted);">Last 10 transactions</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding-bottom:7px; border-bottom:1px solid var(--border); margin-bottom:4px;">
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; flex:1;">Description</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:center;">Type</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:right;">Amount</span>
                    </div>
                    <div id="ledger-list"><div class="ledger-empty">Connect wallet to view history.</div></div>
                </div>

                <!--
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    ADMIN REVENUE PANEL (V10)
                    Visible ONLY when connected wallet === CONFIG.ADMIN_ADDRESS
                    Shows: Total Platform Revenue + Withdraw button ‚Üí adminWithdraw()
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                -->
                <div class="card" id="admin-revenue-panel" style="border-color:rgba(240,180,41,0.2);">
                    <div style="font-family:var(--font-mono); font-size:0.58rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; font-weight:700; margin-bottom:4px;">üîê Platform Revenue ‚Äî Admin</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-bottom:12px;">Cumulative fees: 100% from posts + 20% from interactions</div>
                    <div style="font-size:0.68rem; color:var(--text-secondary); margin-bottom:2px;">Total Platform Revenue</div>
                    <div style="font-family:var(--font-mono); font-size:2rem; font-weight:700; color:var(--teal);" id="admin-revenue-display">0 ‚òÖ</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-top:4px;" id="admin-revenue-count">0 fee events</div>
                    <button id="admin-withdraw-btn" onclick="adminWithdraw()">
                        ‚¨á Withdraw to Admin Wallet
                    </button>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="page-profile" class="page">
                <div class="page-heading">My <span>Identity</span></div>
                <div class="card">
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:14px;">Set your display name and avatar URL. Saved locally, shown on all broadcasts.</div>
                    <input type="text" id="handle-input" class="field" placeholder="@Username" style="margin-top:0;">
                    <input type="text" id="avatar-input" class="field" placeholder="Avatar Image URL">
                    <button class="btn btn-purple" onclick="saveProfile()">Sync Identity</button>
                </div>
            </div>

            <!-- TOKENOMICS PAGE -->
            <div id="page-info" class="page">
                <div class="page-heading">Token<span>omics</span></div>
                <div class="card">
                    <div class="tok-section">Broadcast Costs (100% Admin Revenue)</div>
                    <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Boost to Top</span><span class="tok-value">10.0 ‚òÖ</span></div>
                    <div class="tok-section">Interaction Costs</div>
                    <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Comment / Reply</span><span class="tok-value">1.0 ‚òÖ</span></div>
                    <div class="tok-section">Creator Rewards (80% split)</div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Comment on Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Comment</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Reply</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                    <div class="tok-section">Media Storage</div>
                    <div class="tok-row"><span class="tok-label">Provider</span><span class="tok-value" style="color:#ffb300;">Firebase Storage</span></div>
                    <div class="tok-row"><span class="tok-label">No MetaMask for Upload</span><span class="tok-value" style="color:var(--green);">‚úì Zero Popups</span></div>
                    <div class="tok-row"><span class="tok-label">MetaMask Only For</span><span class="tok-value" style="color:var(--text-white);">Deposit / Withdraw / Register</span></div>
                </div>
            </div>

        </div><!-- /feed-col -->

        <!-- RIGHT PANEL -->
        <div id="right-panel">

            <div class="rp-card">
                <div class="rp-heading">Star Balance</div>
                <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold); margin-bottom:2px;" id="rp-stars">0 ‚òÖ</div>
                <div style="font-size:0.7rem; color:var(--text-muted);">Spending power</div>
                <div class="sparkline"><div class="sparkline-line"></div></div>
                <div style="font-size:0.62rem; color:var(--text-muted);">Earnings this session</div>
            </div>

            <div class="rp-card">
                <div class="rp-heading">Platform Stats</div>
                <div class="stat-row">
                    <div class="stat-label">Creator Earnings<span>80% payout rate</span></div>
                    <div class="stat-val green">0.8 ‚òÖ</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Platform Fee<span>Per interaction</span></div>
                    <div class="stat-val purple">0.2 ‚òÖ</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">APTM Vault<span>On-chain balance</span></div>
                    <div class="stat-val teal" id="rp-aptm">0.0000</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Live APTM Rate<span>USD peg</span></div>
                    <div class="stat-val gold" id="rp-rate">$0.3391</div>
                </div>
                <div class="stat-row" style="border:none;">
                    <div class="stat-label">Total Anchors<span>All time</span></div>
                    <div class="stat-val" id="rp-anchors">0</div>
                </div>
            </div>

            <div class="rp-card">
                <div class="rp-heading">Storage</div>
                <div style="font-size:0.72rem; color:var(--text-secondary); line-height:1.6; margin-bottom:10px;">
                    Media is stored on <span style="color:#ffb300; font-weight:600;">Firebase Storage</span> (Blaze Plan). No MetaMask required for uploads ‚Äî just post and go.
                </div>
                <div style="display:flex; align-items:center; gap:6px; margin-top:8px;">
                    <span class="a-dot" style="background:#ffb300;"></span>
                    <span style="font-family:var(--font-mono); font-size:0.6rem; color:#ffb300;">FIREBASE STORAGE ACTIVE</span>
                </div>
            </div>

        </div><!-- /right-panel -->

    </div><!-- /body-layout -->
</div><!-- /app-shell -->

<!-- ‚îÄ‚îÄ BOTTOM NAVIGATION BAR (Mobile, NEW V10) ‚îÄ‚îÄ -->
<div id="bottom-nav">
    <button class="bnav-item active" id="bnav-home" onclick="switchPage('home', null); setBnav('home')">
        <span class="bnav-icon">‚äû</span>
        Home
    </button>
    <button class="bnav-item bnav-post" onclick="scrollToCompose()">
        <span class="bnav-icon">+</span>
        Post
    </button>
    <button class="bnav-item" id="bnav-studio" onclick="switchPage('earnings', null); setBnav('studio')">
        <span class="bnav-icon">‚óÜ</span>
        Studio
    </button>
</div>

<div id="toast"></div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚öôÔ∏è  GLOBAL CONFIG  (V10)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
        ADMIN_ADDRESS:    "0xe348fedea1850a0c2d4ac0fed3f903774de1e16a",
        CONTRACT_ADDRESS: "0x42e0a97844ac6623207f2a363aa318e83268910f",
        STARS_PER_5_APTM: 169,
        STAR_USD:         0.01,
        PLATFORM_CUT:     0.2,
        CREATOR_CUT:      0.8,
        FEES: {
            TEXT:  1.2,
            PHOTO: 3.0,
            VIDEO: 10.0,
            BOOST: 10,
        },
        STORAGE_BUCKET: "gs://socialhub-33014.firebasestorage.app"
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBAL STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentAptmBalance = "0.0000";
    let starBalance = "0";
    let creatorEarnings = 0;
    let currentAptmPriceUsd = 0.3391;
    let totalAnchors = 0;
    let provider, signer, hubContract;
    let userAddress = "";
    let userHandle = localStorage.getItem('hub_userName') || "Anonymous_Creator";
    let userAvatar  = localStorage.getItem('hub_userPic')  || "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";
    let visibleCount = 10;
    const pageSize = 10;

    const abi = [
        "function depositAPTM() public payable",
        "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
        "function boostPost(uint256 _oneStarWei) public",
        "function interact(address _recipient, uint256 _oneStarWei) public",
        "function starBalances(address _user) view returns (uint256)",
        "function aptmBalances(address) view returns (uint256)",
        "function totalAnchors() view returns (uint256)",
        "function userWithdraw(uint256 _amountWei) public",
        "function adminWithdraw() public",
        "function PLATFORM_ADMIN() view returns (address)"
    ];

    // Media tab state
    let mediaTabMode = 'url';
    let selectedFile = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MOBILE BOTTOM NAV
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setBnav(active) {
        document.querySelectorAll('.bnav-item').forEach(b => b.classList.remove('active'));
        const el = document.getElementById('bnav-' + active);
        if (el) el.classList.add('active');
    }

    function scrollToCompose() {
        const compose = document.querySelector('#page-home .card');
        if (compose) compose.scrollIntoView({ behavior: 'smooth' });
        switchPage('home', null);
        setBnav('home');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MEDIA TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setMediaTab(mode) {
        mediaTabMode = mode;
        document.getElementById('tab-url').classList.toggle('active', mode === 'url');
        document.getElementById('tab-file').classList.toggle('active', mode === 'file');
        document.getElementById('url-input-wrap').style.display  = mode === 'url'  ? '' : 'none';
        document.getElementById('file-input-wrap').style.display = mode === 'file' ? '' : 'none';
        updatePostFeeDisplay();
    }

    function updatePostFeeDisplay() {
        const el = document.getElementById('post-fee-display');
        if (!el) return;
        const url = document.getElementById('post-media')?.value || '';
        let cost = CONFIG.FEES.TEXT.toFixed(1) + ' ‚òÖ';
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' ‚òÖ  (Firebase upload ‚Äî no MetaMask)';
        } else if (url) {
            const isVid = url.includes('mp4') || getYoutubeId(url);
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' ‚òÖ';
        }
        el.textContent = 'Est. cost: ' + cost;
    }

    function handleFileSelect(input) {
        selectedFile = input.files[0];
        if (!selectedFile) return;
        const wrap = document.getElementById('file-preview-wrap');
        const img  = document.getElementById('file-preview-img');
        const vid  = document.getElementById('file-preview-vid');
        const info = document.getElementById('file-info');
        wrap.style.display = 'block';
        img.style.display  = 'none';
        vid.style.display  = 'none';
        const objUrl = URL.createObjectURL(selectedFile);
        if (selectedFile.type.startsWith('image/')) {
            img.src = objUrl; img.style.display = 'block';
        } else {
            vid.src = objUrl; vid.style.display = 'block';
        }
        const kb = (selectedFile.size / 1024).toFixed(1);
        info.innerHTML = `<span style="color:#ffb300;">‚óà ${selectedFile.name}</span> ¬∑ ${kb} KB ¬∑ Will upload to Firebase Storage`;
        updatePostFeeDisplay();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIREBASE STORAGE UPLOAD WITH REAL-TIME PROGRESS BAR (NEW V10)
    //
    // Rules: Posts, Comments, Hypes = Firebase only, NO MetaMask popup
    // MetaMask ONLY for: Deposit, Withdraw, Register
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function uploadToFirebaseStorage(file) {
        return new Promise((resolve, reject) => {
            if (!window.storage || !window.fsStorage) {
                return reject(new Error("Firebase Storage not ready yet. Try again in a moment."));
            }

            const timestamp  = Date.now();
            const safeName   = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            const storagePath = `media/${timestamp}_${safeName}`;
            const storageRef  = window.fsStorage.ref(window.storage, storagePath);
            const uploadTask  = window.fsStorage.uploadBytesResumable(storageRef, file);

            // Show progress UI
            const progressWrap   = document.getElementById('upload-progress-wrap');
            const progressBar    = document.getElementById('progress-bar');
            const progressPct    = document.getElementById('progress-pct');
            const progressStatus = document.getElementById('progress-status');
            const progressLabel  = document.getElementById('progress-label-text');

            progressWrap.style.display = 'block';
            progressBar.style.width    = '0%';
            progressPct.textContent    = '0%';
            progressLabel.textContent  = `Uploading ${file.name}‚Ä¶`;
            progressStatus.textContent = 'Starting upload‚Ä¶';

            uploadTask.on('state_changed',
                (snapshot) => {
                    // PROGRESS EVENT ‚Äî 0‚Äì100%
                    const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    progressBar.style.width   = pct + '%';
                    progressPct.textContent   = pct + '%';

                    const kb = (snapshot.bytesTransferred / 1024).toFixed(1);
                    const total = (snapshot.totalBytes / 1024).toFixed(1);

                    switch (snapshot.state) {
                        case 'paused':
                            progressStatus.textContent = 'Upload paused.';
                            break;
                        case 'running':
                            progressStatus.textContent = `${kb} KB / ${total} KB transferred`;
                            break;
                    }
                },
                (error) => {
                    // UPLOAD FAILED
                    progressWrap.style.display = 'none';
                    reject(error);
                },
                async () => {
                    // UPLOAD COMPLETE ‚Äî get download URL
                    progressBar.style.width   = '100%';
                    progressPct.textContent   = '100%';
                    progressStatus.textContent = 'Processing‚Ä¶';

                    try {
                        const downloadURL = await window.fsStorage.getDownloadURL(uploadTask.snapshot.ref);
                        progressStatus.textContent = '‚úì Upload complete!';
                        progressLabel.textContent  = 'Stored on Firebase';
                        setTimeout(() => { progressWrap.style.display = 'none'; }, 2500);
                        resolve(downloadURL);
                    } catch (e) {
                        progressWrap.style.display = 'none';
                        reject(e);
                    }
                }
            );
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PRICE ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function getLiveAptmPrice() {
        const poolAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57";
        try {
            if (!provider) return 0.3391;
            const poolContract = new ethers.Contract(
                poolAddress,
                ["function getReserves() external view returns (uint112, uint112, uint32)"],
                provider
            );
            const reserves   = await poolContract.getReserves();
            const humanAptm  = parseFloat(ethers.utils.formatUnits(reserves[0], 18));
            const humanUsdt  = parseFloat(ethers.utils.formatUnits(reserves[1], 18));
            const price      = humanUsdt / humanAptm;
            return price > 0 ? price : 0.3391;
        } catch (e) { return 0.3391; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WALLET (MetaMask only for: Deposit, Withdraw, Register)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function connectWallet() {
        if (!window.ethereum) return alert("MetaMask not found");
        try {
            provider    = new ethers.providers.Web3Provider(window.ethereum);
            const accts = await provider.send("eth_requestAccounts", []);
            userAddress = accts[0];
            signer      = provider.getSigner();
            hubContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, abi, signer);

            const statusEl = document.getElementById('wallet-status');
            if (statusEl) statusEl.textContent = userAddress.slice(0, 6) + '‚Ä¶' + userAddress.slice(-4);

            await syncData();
            updateUI();
            subscribeToEarnings(userAddress);
            subscribeLedger(userAddress);
            subscribeAdminRevenue(userAddress);
            if (typeof loadGlobalFeed === "function") loadGlobalFeed();
            showToast("Connected & Synced ‚úì");
        } catch (err) {
            console.error(err);
            showToast("Connection Failed");
        }
    }

    async function syncData() {
        if (!hubContract || !signer) return;
        try {
            const addr              = await signer.getAddress();
            const [balRaw, anchors] = await Promise.all([
                hubContract.aptmBalances(addr),
                hubContract.totalAnchors()
            ]);
            const humanBalance  = ethers.utils.formatEther(balRaw);
            currentAptmBalance  = humanBalance;
            currentAptmPriceUsd = await getLiveAptmPrice();
            const usdValue      = parseFloat(humanBalance) * parseFloat(currentAptmPriceUsd);
            starBalance         = Math.floor(usdValue / CONFIG.STAR_USD).toString();
            totalAnchors        = anchors.toNumber();

            if (window.db) {
                const userRef = window.fs.doc(window.db, "user_balances", addr.toLowerCase());
                const snap    = await window.fs.getDoc(userRef);
                if (!snap.exists()) {
                    await window.fs.setDoc(userRef, { stars: 0, lastSync: Date.now(), address: addr.toLowerCase() });
                } else {
                    await window.fs.updateDoc(userRef, { lastSync: Date.now() });
                }
            }
            updateUI();
        } catch (e) { console.error("Sync Failed:", e); }
    }

    function updateUI() {
        try {
            const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            s('user-stars',              (starBalance || "0") + " ‚òÖ");
            s('sidebar-stars-badge',     (starBalance || "0") + " ‚òÖ");
            s('rp-stars',                (starBalance || "0") + " ‚òÖ");
            s('sidebar-aptm-value',      (currentAptmBalance || "0.0000") + " $APTM");
            s('earnings-aptm-value',     (currentAptmBalance || "0.0000") + " $APTM");
            s('rp-aptm',                 parseFloat(currentAptmBalance || 0).toFixed(4));
            s('creator-revenue-display', creatorEarnings.toFixed(1) + " ‚òÖ");
            s('live-price-display',      `$${parseFloat(currentAptmPriceUsd).toFixed(4)} / APTM`);
            s('rp-rate',                 `$${parseFloat(currentAptmPriceUsd).toFixed(4)}`);
            s('total-anchors-display',   totalAnchors);
            s('rp-anchors',              totalAnchors);

            const pbAv = document.getElementById('pb-avatar');   if (pbAv) pbAv.src = userAvatar;
            const nvAv = document.getElementById('nav-avatar');   if (nvAv) nvAv.src = userAvatar;
            const pbH  = document.getElementById('pb-handle');    if (pbH)  pbH.textContent  = userHandle;
            const nvH  = document.getElementById('nav-handle');   if (nvH)  nvH.textContent  = userHandle;
        } catch (e) { console.error("UI Update Error:", e); }
    }

    function saveProfile() {
        const nameVal = document.getElementById('handle-input').value;
        const picVal  = document.getElementById('avatar-input').value;
        if (nameVal && picVal) {
            localStorage.setItem('hub_userName', nameVal);
            localStorage.setItem('hub_userPic',  picVal);
            userHandle = nameVal; userAvatar = picVal;
            updateUI(); showToast("Identity Saved ‚úì"); loadGlobalFeed();
        } else {
            alert("Please enter both a name and an image URL");
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STAR ECONOMY ‚Äî Firebase balance helpers
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function adjustFirebaseBalance(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref  = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap    = await txn.get(ref);
                const current = snap.exists() ? (snap.data().stars || 0) : 0;
                txn.set(ref, { stars: Math.max(0, current + amount), lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) { console.error("Balance adjustment failed:", e); }
    }

    function subscribeToEarnings(walletAddr) {
        if (!walletAddr || !window.db) return;
        const ref = window.fs.doc(window.db, "user_balances", walletAddr.toLowerCase());
        window.fs.onSnapshot(ref, (snap) => {
            creatorEarnings = snap.exists() ? (snap.data().stars || 0) : 0;
            const el = document.getElementById('creator-revenue-display');
            if (el) el.textContent = creatorEarnings.toFixed(1) + " ‚òÖ";
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRANSACTION LEDGER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function logTransaction(address, type, amount, description) {
        if (!address || !window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "user_transactions"), {
            address: address.toLowerCase(), type, amount, description, timestamp: Date.now()
        }).catch(e => console.warn("logTransaction:", e));
    }

    // Admin revenue: logs to `admin_revenue` global document (Firestore)
    function logAdminRevenue(sourceAddress, actionType, amount) {
        if (!window.db) return;
        // Append to collection for itemized view
        window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
            sourceAddress: (sourceAddress || "unknown").toLowerCase(),
            actionType, amount, timestamp: Date.now()
        }).catch(e => console.warn("logAdminRevenue:", e));

        // Also increment the global admin_revenue document for easy total reads
        const globalRef = window.fs.doc(window.db, "admin_revenue", "global");
        window.fs.runTransaction(window.db, async (txn) => {
            const snap = await txn.get(globalRef);
            const prev = snap.exists() ? (snap.data().total || 0) : 0;
            txn.set(globalRef, { total: prev + amount, lastUpdated: Date.now() }, { merge: true });
        }).catch(e => console.warn("logAdminRevenue global:", e));
    }

    function subscribeLedger(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const q    = window.fs.query(
            window.fs.collection(window.db, "user_transactions"),
            window.fs.where("address", "==", addr),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (docs) => {
            const el = document.getElementById('ledger-list');
            if (!el) return;
            if (docs.length === 0) { el.innerHTML = `<div class="ledger-empty">No activity yet.</div>`; return; }
            el.innerHTML = "";
            docs.slice(0, 10).forEach(tx => {
                const isEarn   = tx.type === "earn" || tx.type === "deposit";
                const prefix   = isEarn ? "+" : "‚àí";
                const amtStr   = prefix + parseFloat(tx.amount).toFixed(1) + " ‚òÖ";
                const amtCls   = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                const badge    = { earn:"Earned", spend:"Spent", deposit:"Deposit", settle:"Settle" }[tx.type] || tx.type;
                const date     = new Date(tx.timestamp).toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
                const row      = document.createElement('div');
                row.className  = 'ledger-row';
                row.innerHTML  = `
                    <div class="ledger-desc">${tx.description}<small>${date}</small></div>
                    <div style="width:58px;text-align:center;flex-shrink:0;"><span class="ledger-badge ${tx.type}">${badge}</span></div>
                    <div class="ledger-amount ${amtCls}">${amtStr}</div>`;
                el.appendChild(row);
            });
        };
        window.fs.onSnapshot(q, (snap) => {
            const docs = []; snap.forEach(d => docs.push(d.data())); render(docs);
        }, (err) => {
            console.warn("Ledger fallback:", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "user_transactions"),
                window.fs.where("address", "==", addr)
            );
            window.fs.onSnapshot(fq, (snap) => {
                const docs = []; snap.forEach(d => docs.push(d.data()));
                docs.sort((a, b) => b.timestamp - a.timestamp); render(docs);
            });
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADMIN REVENUE PANEL (V10)
    // Shows Total Platform Revenue + Withdraw button
    // Only visible to CONFIG.ADMIN_ADDRESS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function subscribeAdminRevenue(walletAddr) {
        if (!walletAddr || !window.db) return;
        if (walletAddr.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) return;

        const panel = document.getElementById('admin-revenue-panel');
        if (panel) panel.style.display = 'block';

        // Subscribe to itemized revenue collection for counts + breakdown
        const q = window.fs.query(
            window.fs.collection(window.db, "platform_revenue"),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (snap) => {
            let total = 0; snap.forEach(d => { total += (d.data().amount || 0); });
            const dEl = document.getElementById('admin-revenue-display'); if (dEl) dEl.textContent = total.toFixed(2) + " ‚òÖ";
            const cEl = document.getElementById('admin-revenue-count');   if (cEl) cEl.textContent = snap.size + " fee events";
        };
        window.fs.onSnapshot(q, render, () => {
            window.fs.onSnapshot(window.fs.collection(window.db, "platform_revenue"), render);
        });
    }

    // Admin Withdraw ‚Äî calls smart contract adminWithdraw()
    // This IS a MetaMask-required action (withdrawal)
    async function adminWithdraw() {
        if (!hubContract) return alert("Connect Wallet First");
        if (!userAddress || userAddress.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) {
            return alert("Admin only.");
        }
        try {
            showToast("Calling adminWithdraw()‚Ä¶");
            const tx = await hubContract.adminWithdraw({ gasLimit: 300000 });
            await tx.wait();
            showToast("Admin Withdrawal Successful ‚úì");
            logTransaction(userAddress, "settle", 0, "Admin withdrew platform revenue to wallet");
            syncData();
        } catch (e) {
            console.error(e);
            alert("Admin withdraw failed: " + (e.reason || e.message).slice(0, 120));
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WALLET ACTIONS (MetaMask gated: Deposit, User Withdraw)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function convertAPTM() {
        currentAptmPriceUsd = await getLiveAptmPrice();
        const amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
        if (amt && hubContract) {
            try {
                showToast(`Depositing ${amt} $APTM‚Ä¶`);
                const tx = await hubContract.depositAPTM({ value: ethers.utils.parseEther(amt), gasLimit: 150000 });
                await tx.wait();
                const starsReceived = Math.floor(parseFloat(amt) * currentAptmPriceUsd / CONFIG.STAR_USD);
                logTransaction(userAddress, "deposit", starsReceived, `Deposited ${parseFloat(amt).toFixed(2)} $APTM ‚Üí ${starsReceived} Stars`);
                setTimeout(() => { syncData(); }, 2000);
            } catch (e) { console.error(e); alert("Transaction failed."); }
        }
    }

    async function settleToWallet() {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const addr        = await signer.getAddress();
            const rawBalance  = await hubContract.aptmBalances(addr);
            const humanAmount = ethers.utils.formatEther(rawBalance);
            const amt         = prompt(`Withdraw\nBalance: ${humanAmount} APTM`, humanAmount);
            if (amt && hubContract) {
                showToast("Opening MetaMask‚Ä¶");
                const withdrawWei = ethers.utils.parseUnits(parseFloat(amt).toFixed(18), 18);
                const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
                await tx.wait();
                logTransaction(addr, "settle", parseFloat(amt), `Settled ${parseFloat(amt).toFixed(4)} $APTM to wallet`);
                showToast("Success! ‚úì");
                syncData();
            }
        } catch (e) { console.error(e); alert("Failed: " + (e.reason || e.message).slice(0, 100)); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FEED HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .card');
        posts.forEach((post, i) => {
            if (i < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const btn = document.getElementById('load-more-btn');
        if (btn) btn.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() { visibleCount += pageSize; refreshFeedVisibility(); }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img       = document.getElementById('preview-img');
        if (url && url.startsWith('http')) { img.src = url; container.style.display = 'block'; }
        else { container.style.display = 'none'; }
        updatePostFeeDisplay();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        if (t) { t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2800); }
    }

    function switchPage(p, el) {
        document.getElementById('page-home').style.display = 'none';
        ['earnings', 'profile', 'info'].forEach(id => {
            const pg = document.getElementById('page-' + id);
            if (pg) pg.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        if (p === 'home') {
            document.getElementById('page-home').style.display = 'contents';
        } else {
            const pg = document.getElementById('page-' + p);
            if (pg) pg.classList.add('active');
        }
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match  = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BROADCAST (V10)
    //
    // ZERO POPUPS for posting:
    //   - Text: pure Firestore write, star deducted from Firebase balance
    //   - Photo/Video (file): Firebase Storage upload ‚Üí Firestore write
    //   - Photo/Video (url): Firestore write
    // Admin revenue logged to `admin_revenue` collection (100% of post fee)
    // MetaMask is NOT called here.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function handleBroadcast() {
        const txt = document.getElementById('post-text').value.trim();
        if (!txt) return showToast("Write something first!");
        if (!userAddress) return showToast("Connect your wallet first!");

        // Check Firebase star balance (internal ledger)
        let currentFbStars = 0;
        if (window.db) {
            try {
                const userRef = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap    = await window.fs.getDoc(userRef);
                currentFbStars = snap.exists() ? (snap.data().stars || 0) : 0;
            } catch (e) { console.warn("Balance check failed:", e); }
        }

        let mediaUrl  = "";
        let feeAmount = CONFIG.FEES.TEXT;
        let postType  = 1; // 1=text, 2=photo, 3=video
        let isFirebase = false;

        // Determine post type and fee
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            feeAmount   = isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO;
            postType    = isVid ? 3 : 2;
            isFirebase  = true;
        } else {
            const url = document.getElementById('post-media').value.trim();
            if (url) {
                if (url.includes('mp4') || getYoutubeId(url)) { feeAmount = CONFIG.FEES.VIDEO; postType = 3; }
                else { feeAmount = CONFIG.FEES.PHOTO; postType = 2; }
                mediaUrl = url;
            }
        }

        // Check sufficient stars (Firebase internal balance)
        if (currentFbStars < feeAmount) {
            return alert(`Insufficient Stars!\nRequired: ${feeAmount}‚òÖ\nYour balance: ${currentFbStars.toFixed(1)}‚òÖ\n\nDeposit APTM to get more Stars.`);
        }

        // Step 1: Firebase Storage upload if file selected (NO MetaMask)
        if (isFirebase && selectedFile) {
            showToast("Uploading to Firebase Storage‚Ä¶");
            try {
                mediaUrl = await uploadToFirebaseStorage(selectedFile);
                showToast("Upload complete! Writing post‚Ä¶");
            } catch (e) {
                console.error("Firebase upload failed:", e);
                return alert("Upload failed: " + e.message);
            }
        }

        // Step 2: Deduct stars from Firebase (internal ledger) ‚Äî NO MetaMask
        try {
            await adjustFirebaseBalance(userAddress, -feeAmount);
        } catch (e) {
            console.error("Star deduction failed:", e);
            return alert("Failed to deduct stars. Please try again.");
        }

        // Step 3: Log 100% of post fee as admin revenue
        logAdminRevenue(userAddress, postType === 1 ? "text_post" : postType === 2 ? "photo_post" : "video_post", feeAmount);
        logTransaction(userAddress, "spend", feeAmount, `Paid ${feeAmount}‚òÖ for ${postType === 1 ? 'Text' : postType === 2 ? 'Photo' : 'Video'} Broadcast`);

        // Step 4: Write post to Firestore ‚Äî NO MetaMask
        try {
            const postAuthorName = localStorage.getItem('hub_userName') || userHandle;
            const postAuthorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            const postData = {
                text:       txt,
                media:      mediaUrl,
                firebase:   isFirebase,
                author:     postAuthorName,
                authorAddr: userAddress,
                avatar:     postAuthorPic,
                timestamp:  Date.now(),
                hypes:      0,
                type:       postType,
                feePaid:    feeAmount
            };

            await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

            // Reset composer
            document.getElementById('post-text').value  = "";
            document.getElementById('post-media').value = "";
            selectedFile = null;
            const fPrev = document.getElementById('file-preview-wrap');
            if (fPrev) fPrev.style.display = 'none';
            const progWrap = document.getElementById('upload-progress-wrap');
            if (progWrap) progWrap.style.display = 'none';

            // Update local star balance optimistically
            starBalance = Math.max(0, parseFloat(starBalance) - feeAmount).toString();
            updateUI();

            showToast("Signal Live! ‚óà");
        } catch (e) {
            console.error("Firebase write failed:", e);
            alert("Post failed: " + e.message);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOOST (still on-chain ‚Äî MetaMask required)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function boostPost(postId) {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const userAddr  = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            const boostFee  = ethers.utils.parseEther(CONFIG.FEES.BOOST.toString());
            let tx;
            showToast("Preparing 10‚òÖ Boost‚Ä¶");
            if (internalStars.gte(boostFee)) {
                tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 });
            } else {
                tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 });
            }
            await tx.wait();
            const postRef = window.fs.doc(window.db, "posts", postId);
            await window.fs.updateDoc(postRef, { timestamp: Date.now(), isBoosted: true });
            showToast("Signal Boosted! üöÄ");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { console.error(e); alert("Boost failed."); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HYPE ‚Äî Firebase only, NO MetaMask (80/20 split)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function hypeElement(recipientAddress, displayId) {
        if (!userAddress) return showToast("Connect wallet first!");

        // Check Firebase star balance
        let currentFbStars = 0;
        if (window.db) {
            try {
                const userRef  = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap     = await window.fs.getDoc(userRef);
                currentFbStars = snap.exists() ? (snap.data().stars || 0) : 0;
            } catch (e) { /* use cached */ currentFbStars = parseInt(starBalance) || 0; }
        }
        if (currentFbStars < 1) return showToast("Not enough Stars! Deposit APTM.");

        try {
            const isComment = displayId.startsWith('hc-');
            const entityId  = displayId.replace(isComment ? 'hc-' : 'hp-', '');

            // Update hype count in Firestore (no MetaMask)
            if (isComment) {
                await window.fs.updateDoc(window.fs.doc(window.db, "comments", entityId), { hypes: window.fs.increment(1) });
            } else {
                await window.fs.updateDoc(window.fs.doc(window.db, "posts", entityId), { hypes: window.fs.increment(1) });
            }

            // 80% to creator
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT,
                    isComment ? "Earned 0.8‚òÖ ‚Äî someone hyped your comment" : "Earned 0.8‚òÖ ‚Äî someone hyped your post");
            }

            // Deduct 1‚òÖ from sender
            await adjustFirebaseBalance(userAddress, -1);

            // 20% admin revenue
            logAdminRevenue(userAddress, isComment ? "hype_comment" : "hype_post", CONFIG.PLATFORM_CUT);
            logTransaction(userAddress, "spend", 1, isComment ? "Spent 1‚òÖ on Comment Hype" : "Spent 1‚òÖ on Post Hype");

            // Update local display
            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            const counterEl = document.getElementById(displayId);
            if (counterEl) counterEl.textContent = (parseInt(counterEl.textContent || "0") + 1);
            showToast("Hyped! Creator +0.8‚òÖ");
        } catch (e) { console.error(e); showToast("Hype failed."); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMMENTS ‚Äî Firebase only, NO MetaMask
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleTray(id) {
        const t = document.getElementById(`tray-${id}`);
        if (!t) return;
        t.style.display = t.style.display === 'block' ? 'none' : 'block';
    }

    async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
        if (!userAddress) return showToast("Connect wallet first!");

        // Check Firebase star balance
        let currentFbStars = 0;
        if (window.db) {
            try {
                const userRef  = window.fs.doc(window.db, "user_balances", userAddress.toLowerCase());
                const snap     = await window.fs.getDoc(userRef);
                currentFbStars = snap.exists() ? (snap.data().stars || 0) : 0;
            } catch (e) { currentFbStars = parseInt(starBalance) || 0; }
        }
        if (currentFbStars < 1) return showToast("Not enough Stars! Deposit APTM.");

        const inputId    = isReply ? `reply-in-${parentId}` : `input-${postId}`;
        const input      = document.getElementById(inputId);
        const commentText = input ? input.value.trim() : "";
        if (!commentText) return;

        try {
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;
            const commentData = {
                text: commentText, author: authorName,
                authorAddr: userAddress || "unknown", avatar: authorPic,
                postId: String(postId), parentId: parentId || null,
                isReply, timestamp: Date.now(), hypes: 0
            };

            // Write to Firestore ‚Äî no MetaMask
            await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);

            // 80% to creator
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8‚òÖ ‚Äî someone commented on your content");
            }

            // Deduct 1‚òÖ from commenter
            await adjustFirebaseBalance(userAddress, -1);

            // 20% admin revenue
            logAdminRevenue(userAddress, isReply ? "reply" : "comment", CONFIG.PLATFORM_CUT);
            logTransaction(userAddress, "spend", 1, isReply ? "Spent 1‚òÖ on a Reply" : "Spent 1‚òÖ on a Comment");

            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            if (input) input.value = "";
            const tray = document.getElementById(`tray-${postId}`);
            if (tray) tray.style.display = 'block';
            showToast("Comment Live! Creator +0.8‚òÖ");
        } catch (e) { console.error(e); showToast("Failed."); }
    }

    const _commentListeners = {};

    async function loadComments(postId) {
        const list = document.getElementById(`list-${postId}`);
        if (!list || !window.db || _commentListeners[postId]) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "comments"),
            window.fs.where("postId", "==", String(postId)),
            window.fs.orderBy("timestamp", "asc")
        );

        const renderComments = (snapshot) => {
            list.innerHTML = "";
            const topLevel = [], repliesMap = {};
            snapshot.forEach(docRef => {
                const data = { ...docRef.data(), _id: docRef.id };
                if (data.parentId) {
                    if (!repliesMap[data.parentId]) repliesMap[data.parentId] = [];
                    repliesMap[data.parentId].push(data);
                } else { topLevel.push(data); }
            });
            const counterEl = document.getElementById(`cc-${postId}`);
            if (counterEl) counterEl.textContent = snapshot.size > 0 ? ` (${snapshot.size})` : '';
            if (topLevel.length === 0) {
                list.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);padding:8px;">No comments yet. Be first!</div>`;
                return;
            }
            const renderRow = (comment, isNested) => {
                const cId        = comment._id;
                const authorAddr = comment.authorAddr || "unknown";
                const row        = document.createElement('div');
                row.className    = 'cmt-row' + (isNested ? ' nested' : '');
                row.innerHTML    = `
                    <span class="cmt-author">${comment.author || "Anonymous"}</span>: ${comment.text}
                    <div class="cmt-meta">
                        <span class="cbtn" onclick="hypeElement('${authorAddr}','hc-${cId}')">‚ù§ <span id="hc-${cId}">${comment.hypes || 0}</span></span>
                        ${!isNested ? `<span class="cbtn reply" onclick="toggleReplyInput('${cId}')">‚Ü© Reply</span>` : ''}
                    </div>
                    ${!isNested ? `
                    <div class="reply-area" id="reply-area-${cId}">
                        <div class="reply-row">
                            <input type="text" class="field" id="reply-in-${cId}" placeholder="Reply‚Ä¶ (1‚òÖ)" style="font-size:0.8rem;">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${authorAddr}','${postId}',true,'${cId}')">Send</button>
                        </div>
                    </div>` : ''}`;
                return row;
            };
            topLevel.forEach(c => {
                list.appendChild(renderRow(c, false));
                (repliesMap[c._id] || []).forEach(r => list.appendChild(renderRow(r, true)));
            });
        };

        _commentListeners[postId] = window.fs.onSnapshot(q, renderComments, (err) => {
            console.error("Comment listener, trying fallback:", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "comments"),
                window.fs.where("postId", "==", String(postId))
            );
            _commentListeners[postId] = window.fs.onSnapshot(fq, (snap) => {
                const sorted = {
                    forEach: (fn) => {
                        const docs = [];
                        snap.forEach(d => docs.push({ ...d, data: () => d.data(), id: d.id }));
                        docs.sort((a, b) => (a.data().timestamp || 0) - (b.data().timestamp || 0));
                        docs.forEach(fn);
                    },
                    size: snap.size
                };
                renderComments(sorted);
            });
        });
    }

    function toggleReplyInput(commentId) {
        const area = document.getElementById(`reply-area-${commentId}`);
        if (!area) return;
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            const inp = document.getElementById(`reply-in-${commentId}`);
            if (inp) setTimeout(() => inp.focus(), 50);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBAL FEED
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadGlobalFeed() {
        const feedContainer = document.getElementById('feed-items');
        if (!feedContainer || !window.db) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "posts"),
            window.fs.orderBy("timestamp", "desc")
        );

        window.fs.onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = "";
            Object.keys(_commentListeners).forEach(k => {
                if (typeof _commentListeners[k] === 'function') _commentListeners[k]();
                delete _commentListeners[k];
            });

            snapshot.forEach((docRef) => {
                const post      = docRef.data();
                const postId    = docRef.id;
                const isMe      = (post.authorAddr && userAddress && post.authorAddr.toLowerCase() === userAddress.toLowerCase());
                const localName = localStorage.getItem('hub_userName');
                const localPic  = localStorage.getItem('hub_userPic');
                const displayPic  = (isMe && localPic)  ? localPic  : (post.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${post.authorAddr || 'anon'}`);
                const displayName = (isMe && localName) ? localName : (post.author || "Anonymous");

                let mediaHtml  = '';
                const ytId     = getYoutubeId(post.media || "");

                // Badge: Firebase or plain
                const storageBadge = post.firebase
                    ? `<div style="margin-bottom:8px;"><span class="firebase-tag"><span class="a-dot" style="background:#ffb300;"></span>FIREBASE STORAGE</span></div>`
                    : '';

                if (ytId) {
                    mediaHtml = `${storageBadge}<div class="post-media"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
                } else if (post.media) {
                    if (post.type === 3 && !ytId) {
                        mediaHtml = `${storageBadge}<div class="post-media"><video src="${post.media}" controls style="width:100%;max-height:320px;"></video></div>`;
                    } else {
                        mediaHtml = `${storageBadge}<div class="post-media"><img src="${post.media}" loading="lazy"></div>`;
                    }
                }

                const item = document.createElement('div');
                item.className = 'card post-card';
                item.setAttribute('data-id', postId);
                if (post.isBoosted) item.style.borderColor = 'rgba(240,180,41,0.3)';

                item.innerHTML = `
                    <div class="post-header">
                        <img src="${displayPic}" class="av">
                        <div class="post-meta">
                            <div class="post-author">${displayName} ${post.isBoosted ? '<span class="boosted-badge">üöÄ BOOSTED</span>' : ''}</div>
                            <div class="post-addr">${post.authorAddr ? post.authorAddr.slice(0,6)+'‚Ä¶'+post.authorAddr.slice(-4) : 'anon'}</div>
                        </div>
                        <span class="post-more">¬∑¬∑¬∑</span>
                    </div>
                    ${mediaHtml}
                    <div class="post-body">${post.text}</div>
                    <div class="post-actions">
                        <div class="pact" onclick="hypeElement('${post.authorAddr}','hp-${postId}')">‚ù§ <span class="pact-num" id="hp-${postId}">${post.hypes || 0}</span> Like</div>
                        <div class="pact" onclick="toggleTray('${postId}'); loadComments('${postId}')">üí¨ Comment<span class="pact-num" id="cc-${postId}" style="color:var(--teal);"></span></div>
                        <div class="pact boost" style="margin-left:auto;" onclick="boostPost('${postId}')">üöÄ Boost (10‚òÖ)</div>
                    </div>
                    <div class="comment-tray" id="tray-${postId}">
                        <div class="comment-list" id="list-${postId}"></div>
                        <div class="cmt-input-row">
                            <input type="text" class="field" style="font-size:0.8rem;" placeholder="Add a comment (1‚òÖ)‚Ä¶" id="input-${postId}">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${post.authorAddr}','${postId}')">Send</button>
                        </div>
                        <button class="close-comments-btn" onclick="toggleTray('${postId}')">‚Üë Close Comments</button>
                    </div>`;
                feedContainer.appendChild(item);
            });
            if (typeof refreshFeedVisibility === "function") refreshFeedVisibility();
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STARTUP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.addEventListener('load', async () => {
        try {
            updateUI();
            currentAptmPriceUsd = await getLiveAptmPrice();
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
            setTimeout(() => { loadGlobalFeed(); }, 1500);
        } catch (e) { console.error("Startup failed:", e); }
    });

    // Heartbeat ‚Äî 30s sync
    setInterval(async () => {
        if (provider && hubContract) {
            try {
                currentAptmPriceUsd = await getLiveAptmPrice();
                await syncData();
            } catch (e) { console.error("Heartbeat failed:", e); }
        }
    }, 30000);

</script>
</body>
</html>
