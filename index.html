
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIALHUB â€” Signal Protocol</title>

    <!-- 1. Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <!-- 2. Irys WebIrys browser SDK (Fix #1) -->
    <script src="https://gateway.irys.xyz/sdk/v0.2.8"></script>

    <!-- 3. Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
            authDomain: "socialhub-33014.firebaseapp.com",
            projectId: "socialhub-33014",
            storageBucket: "socialhub-33014.firebasestorage.app",
            messagingSenderId: "864088350104",
            appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
            measurementId: "G-B2C1K1LVGQ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fs = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-outer:    #0d1117;
            --bg-app:      #161b27;
            --bg-panel:    #1c2333;
            --bg-card:     #222a3a;
            --bg-card2:    #1e2638;
            --bg-input:    #151c2c;
            --bg-hover:    #263046;
            --border:      rgba(255,255,255,0.07);
            --border-md:   rgba(255,255,255,0.11);
            --purple:      #7c5cbf;
            --purple-lt:   #9b7de0;
            --purple-dim:  rgba(124,92,191,0.18);
            --purple-glow: rgba(124,92,191,0.08);
            --teal:        #2dd4bf;
            --teal-dim:    rgba(45,212,191,0.12);
            --gold:        #f0b429;
            --green:       #3ecf8e;
            --red:         #f87171;
            --text-primary:   #e8ecf4;
            --text-secondary: #8892a4;
            --text-muted:     #4e5a6e;
            --text-white:     #ffffff;
            --glow-warm: rgba(160,60,40,0.18);
            --glow-teal: rgba(30,80,100,0.22);
            --radius-sm:  8px;
            --radius-md:  12px;
            --radius-lg:  16px;
            --radius-xl:  20px;
            --font-body: 'Sora', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        body {
            font-family: var(--font-body);
            background: var(--bg-outer);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background:
                radial-gradient(ellipse 55% 45% at 0% 0%,   var(--glow-warm) 0%, transparent 65%),
                radial-gradient(ellipse 45% 55% at 100% 100%, var(--glow-teal) 0%, transparent 65%),
                radial-gradient(ellipse 30% 30% at 50% 50%,  rgba(20,28,50,0.6) 0%, transparent 100%);
        }

        body::after {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            opacity: 0.18;
            background-image: radial-gradient(circle, rgba(100,120,180,0.4) 1px, transparent 1px);
            background-size: 28px 28px;
        }

        /* â”€â”€ APP SHELL â”€â”€ */
        #app-shell {
            position: relative; z-index: 5;
            width: min(1120px, 97vw);
            height: min(820px, 96vh);
            background: var(--bg-app);
            border-radius: 24px;
            border: 1px solid var(--border-md);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.04);
        }

        /* â”€â”€ TOP NAV â”€â”€ */
        #topnav {
            height: 60px; flex-shrink: 0;
            display: flex; align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            gap: 16px;
        }
        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.1rem; font-weight: 700;
            color: var(--text-white); letter-spacing: -0.3px;
        }
        .brand-icon {
            width: 30px; height: 30px; border-radius: 8px;
            background: var(--purple-dim);
            border: 1px solid rgba(124,92,191,0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .topnav-mid { flex-grow: 1; }
        .topnav-right { display: flex; align-items: center; gap: 12px; }
        .user-pill {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 14px 6px 6px;
            border-radius: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .user-pill img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .user-pill-name { font-size: 0.78rem; font-weight: 600; color: var(--text-primary); line-height: 1.2; }
        .user-pill-sub  { font-size: 0.65rem; color: var(--text-secondary); }
        #wallet-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            background: transparent;
            border: 1px solid var(--border-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.78rem; font-weight: 600;
            cursor: pointer;
            transition: all 0.18s;
            white-space: nowrap;
        }
        #wallet-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); background: var(--purple-glow); }
        .wallet-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--teal); flex-shrink: 0; }

        /* â”€â”€ BODY LAYOUT â”€â”€ */
        #body-layout {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 200px 1fr 240px;
            overflow: hidden;
        }

        /* â”€â”€ LEFT SIDEBAR â”€â”€ */
        #sidebar {
            border-right: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex; flex-direction: column;
            padding: 16px 10px;
            overflow-y: auto;
        }
        .nav-item {
            display: flex; align-items: center; gap: 11px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.82rem; font-weight: 500;
            transition: all 0.15s;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .nav-icon { font-size: 0.95rem; width: 18px; text-align: center; flex-shrink: 0; opacity: 0.85; }
        .nav-badge {
            margin-left: auto;
            font-family: var(--font-mono);
            font-size: 0.58rem; font-weight: 600;
            color: var(--purple-lt);
            background: var(--purple-dim);
            border-radius: 50px; padding: 2px 7px;
            white-space: nowrap;
        }
        .sidebar-section { margin-top: 16px; margin-bottom: 6px; }
        .sidebar-section-label {
            font-size: 0.6rem; font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 1.5px; text-transform: uppercase;
            padding: 0 12px; margin-bottom: 6px;
        }
        .sidebar-vault {
            padding: 14px;
            background: var(--bg-card2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-top: 12px;
        }
        .vault-label { font-size: 0.58rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 3px; }
        .vault-stars { font-family: var(--font-mono); font-size: 1.3rem; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
        .vault-aptm  { font-size: 0.72rem; color: var(--teal); font-weight: 600; margin-bottom: 2px; }
        .vault-rate  { font-family: var(--font-mono); font-size: 0.58rem; color: var(--text-muted); }

        /* â”€â”€ FEED COLUMN â”€â”€ */
        #feed-col {
            overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 14px;
        }
        #feed-col::-webkit-scrollbar { width: 3px; }
        #feed-col::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }
        .feed-heading { font-size: 1rem; font-weight: 700; color: var(--text-white); margin-bottom: 4px; }

        /* â”€â”€ CARDS â”€â”€ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            transition: border-color 0.15s;
        }
        .card:hover { border-color: var(--border-md); }

        .composer-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .av { width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border-md); object-fit: cover; flex-shrink: 0; }
        .composer-name { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .composer-sub  { font-size: 0.65rem; color: var(--text-secondary); }

        .field {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.85rem;
            padding: 10px 14px;
            outline: none;
            resize: none;
            transition: border-color 0.15s;
            margin-top: 8px;
        }
        .field:focus { border-color: rgba(124,92,191,0.4); }
        .field::placeholder { color: var(--text-muted); }

        /* Media tabs */
        .media-tabs { display: flex; gap: 6px; margin-top: 10px; }
        .mtab {
            flex: 1; padding: 7px; border-radius: var(--radius-sm);
            font-size: 0.72rem; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border); color: var(--text-secondary);
            background: transparent; text-align: center;
            transition: all 0.13s;
        }
        .mtab.active { color: var(--purple-lt); border-color: rgba(124,92,191,0.35); background: var(--purple-dim); }

        .upload-zone {
            border: 1.5px dashed rgba(124,92,191,0.3);
            border-radius: var(--radius-md);
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            position: relative;
            transition: all 0.18s;
            background: rgba(124,92,191,0.04);
        }
        .upload-zone:hover { border-color: var(--purple-lt); background: var(--purple-dim); }
        .upload-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .upload-zone-text { font-size: 0.78rem; color: var(--text-secondary); pointer-events: none; }
        .upload-zone-text strong { display: block; color: var(--purple-lt); font-size: 0.82rem; margin-bottom: 3px; }

        #irys-status {
            font-size: 0.7rem; margin-top: 8px; padding: 7px 12px;
            border-radius: var(--radius-sm);
            background: var(--purple-dim); border: 1px solid rgba(124,92,191,0.2);
            color: var(--purple-lt); display: none;
        }

        .fee-display {
            font-family: var(--font-mono);
            font-size: 0.62rem; color: var(--text-muted);
            text-align: right; margin-top: 6px;
        }

        /* Buttons */
        .btn {
            padding: 9px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-family: var(--font-body);
            font-weight: 600; font-size: 0.82rem;
            cursor: pointer; transition: all 0.16s;
        }
        .btn-purple {
            background: var(--purple);
            color: #fff;
            width: 100%; margin-top: 12px;
        }
        .btn-purple:hover { background: var(--purple-lt); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,92,191,0.3); }
        .btn-outline {
            background: transparent; border: 1px solid var(--border-md);
            color: var(--text-secondary); width: 100%; margin-top: 10px;
        }
        .btn-outline:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        .btn-sm { padding: 6px 13px; font-size: 0.75rem; border-radius: var(--radius-sm); }
        .btn-teal { background: var(--teal); color: #0d1117; font-weight: 700; }
        .btn-teal:hover { filter: brightness(1.08); }

        /* Post cards */
        .post-card { animation: fadeUp 0.25s ease both; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .post-meta { flex-grow: 1; }
        .post-author { font-size: 0.85rem; font-weight: 600; color: var(--text-white); }
        .post-addr   { font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .post-more   { color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 4px 8px; border-radius: 6px; }
        .post-more:hover { background: var(--bg-hover); color: var(--text-primary); }
        .boosted-badge {
            font-family: var(--font-mono); font-size: 0.58rem; font-weight: 700;
            background: rgba(240,180,41,0.1); border: 1px solid rgba(240,180,41,0.3);
            color: var(--gold); padding: 2px 9px; border-radius: 50px;
        }
        .post-body  { font-size: 0.88rem; line-height: 1.6; color: var(--text-primary); margin-bottom: 12px; }
        .post-media {
            width: 100%; border-radius: var(--radius-md); overflow: hidden;
            margin-bottom: 12px; background: #000;
            max-height: 320px;
            display: flex; justify-content: center;
            border: 1px solid var(--border);
        }
        .post-media img  { width: 100%; max-height: 320px; object-fit: cover; display: block; }
        .post-media iframe { width: 100%; height: 260px; border: none; }

        .arweave-tag {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--font-mono); font-size: 0.58rem;
            background: var(--purple-dim); border: 1px solid rgba(124,92,191,0.25);
            color: var(--purple-lt); padding: 2px 8px; border-radius: 4px;
            margin-bottom: 8px;
        }
        .a-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--purple-lt); animation: blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.2;} }

        .post-actions {
            display: flex; align-items: center; gap: 4px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .pact {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 50px;
            font-size: 0.76rem; font-weight: 500;
            cursor: pointer; color: var(--text-secondary);
            background: transparent; border: 1px solid transparent;
            transition: all 0.13s;
        }
        .pact:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
        .pact.boost:hover { color: var(--gold); border-color: rgba(240,180,41,0.3); background: rgba(240,180,41,0.06); }
        .pact-num { font-family: var(--font-mono); font-size: 0.7rem; }

        /* Comment tray */
        .comment-tray { display: none; padding-top: 14px; border-top: 1px dashed rgba(255,255,255,0.05); margin-top: 12px; }
        .comment-list { max-height: 320px; overflow-y: auto; margin-bottom: 10px; }
        .cmt-row {
            padding: 10px 12px; border-radius: var(--radius-md);
            background: var(--bg-input); border: 1px solid var(--border);
            margin-bottom: 7px; font-size: 0.82rem; color: var(--text-primary);
            line-height: 1.5;
        }
        .cmt-row.nested {
            margin-left: 18px;
            border-left: 2px solid rgba(124,92,191,0.25);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            background: rgba(124,92,191,0.04);
        }
        .cmt-author { color: var(--gold); font-weight: 700; }
        .cmt-meta { display: flex; gap: 8px; margin-top: 8px; }
        .cbtn {
            font-size: 0.68rem; font-weight: 600; cursor: pointer;
            padding: 3px 9px; border-radius: 5px;
            border: 1px solid var(--border); color: var(--text-muted);
            background: transparent; transition: all 0.12s;
        }
        .cbtn:hover { color: var(--teal); border-color: rgba(45,212,191,0.3); }
        .cbtn.reply:hover { color: var(--purple-lt); border-color: rgba(124,92,191,0.3); }
        .reply-area { display: none; margin-top: 8px; }
        .reply-row  { display: flex; gap: 7px; }
        .reply-row .field { margin-top: 0; flex: 1; }
        .cmt-input-row { display: flex; gap: 8px; }
        .cmt-input-row .field { margin-top: 0; flex: 1; }

        /* Right panel */
        #right-panel {
            border-left: 1px solid var(--border);
            background: var(--bg-panel);
            overflow-y: auto;
            padding: 16px 14px;
            display: flex; flex-direction: column; gap: 14px;
        }
        #right-panel::-webkit-scrollbar { width: 3px; }
        #right-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .rp-heading {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; font-weight: 700; color: var(--text-white);
            margin-bottom: 10px;
        }
        .rp-card {
            background: var(--bg-card2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 14px;
        }
        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid var(--border);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-label span { display: block; font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
        .stat-val { font-family: var(--font-mono); font-size: 0.8rem; font-weight: 700; color: var(--text-white); }
        .stat-val.gold   { color: var(--gold); }
        .stat-val.teal   { color: var(--teal); }
        .stat-val.purple { color: var(--purple-lt); }
        .stat-val.green  { color: var(--green); }

        /* Ledger */
        .ledger-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); gap: 8px;
        }
        .ledger-row:last-child { border-bottom: none; }
        .ledger-desc { font-size: 0.75rem; color: var(--text-secondary); flex: 1; line-height: 1.4; }
        .ledger-desc small { display: block; font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }
        .ledger-badge {
            font-family: var(--font-mono); font-size: 0.52rem; font-weight: 700;
            padding: 2px 7px; border-radius: 4px; text-transform: uppercase;
            width: 58px; text-align: center; flex-shrink: 0;
        }
        .ledger-badge.earn    { background: rgba(62,207,142,0.12); color: var(--green); }
        .ledger-badge.spend   { background: rgba(248,113,113,0.12); color: var(--red); }
        .ledger-badge.deposit { background: var(--teal-dim); color: var(--teal); }
        .ledger-badge.settle  { background: var(--purple-dim); color: var(--purple-lt); }
        .ledger-amount { font-family: var(--font-mono); font-size: 0.76rem; font-weight: 700; width: 58px; text-align: right; flex-shrink: 0; }
        .ledger-amount.earn    { color: var(--green); }
        .ledger-amount.spend   { color: var(--red); }
        .ledger-amount.neutral { color: var(--text-muted); }
        .ledger-empty { font-size: 0.72rem; color: var(--text-muted); padding: 14px 0; text-align: center; }

        /* Admin panel â€” hidden by default, shown for admin wallet only */
        #admin-revenue-panel { display: none; }

        /* Tokenomics */
        .tok-section {
            font-family: var(--font-mono); font-size: 0.56rem;
            color: var(--gold); letter-spacing: 2.5px;
            text-transform: uppercase; margin: 18px 0 8px; font-weight: 700;
        }
        .tok-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 0.84rem;
        }
        .tok-row:last-of-type { border-bottom: none; }
        .tok-label { color: var(--text-secondary); }
        .tok-value { font-family: var(--font-mono); font-weight: 700; color: var(--purple-lt); font-size: 0.8rem; }

        /* Page system */
        .page { display: none; }
        .page.active { display: contents; }
        #page-home { display: contents; }

        /* Misc */
        .hidden-post { display: none !important; }
        #load-more-btn { display: none; background: transparent; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; width: 100%; margin-top: 4px; }
        #load-more-btn:hover { border-color: var(--purple-lt); color: var(--purple-lt); }
        #media-preview-container { display: none; margin-top: 10px; border-radius: var(--radius-md); overflow: hidden; background: #000; border: 1px solid var(--border); }
        #preview-img { max-width: 100%; max-height: 200px; display: block; margin: 0 auto; }

        /* Toast */
        #toast {
            position: fixed; bottom: 22px; right: 22px; z-index: 9999;
            background: var(--bg-card);
            border: 1px solid rgba(124,92,191,0.35);
            color: var(--purple-lt);
            font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600;
            padding: 10px 20px; border-radius: var(--radius-md);
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            transform: translateY(8px); letter-spacing: 0.4px;
        }
        #toast.show { opacity: 1; transform: translateY(0); }

        .page-heading { font-size: 1.1rem; font-weight: 700; color: var(--text-white); margin-bottom: 14px; }
        .page-heading span { color: var(--purple-lt); }

        .info-box {
            padding: 12px 14px; background: var(--purple-dim);
            border: 1px solid rgba(124,92,191,0.2);
            border-radius: var(--radius-md);
            font-size: 0.78rem; color: var(--text-secondary);
            line-height: 1.6; margin-bottom: 14px;
        }
        .info-box strong { color: var(--purple-lt); }
        .balance-note { font-size: 0.62rem; color: var(--text-muted); margin-top: 2px; }

        /* Sparkline */
        .sparkline {
            height: 50px; border-radius: var(--radius-sm);
            background: var(--bg-input);
            margin: 10px 0 4px;
            position: relative; overflow: hidden;
        }
        .sparkline::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--purple-lt), var(--teal), transparent);
            opacity: 0.4;
        }
        .sparkline-line {
            position: absolute; bottom: 10px; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, var(--purple-lt), var(--teal));
            clip-path: polygon(0 60%, 15% 30%, 30% 55%, 45% 20%, 60% 40%, 75% 15%, 90% 35%, 100% 25%, 100% 100%, 0 100%);
        }
    </style>
</head>
<body>

<div id="app-shell">

    <!-- TOP NAV -->
    <div id="topnav">
        <div class="brand">
            <div class="brand-icon">â—ˆ</div>
            SOCIALHUB
        </div>
        <div class="topnav-mid"></div>
        <div class="topnav-right">
            <div class="user-pill">
                <img id="nav-avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                <div>
                    <div class="user-pill-name" id="nav-handle">Anonymous</div>
                    <div class="user-pill-sub">Creator</div>
                </div>
            </div>
            <button id="wallet-btn" onclick="connectWallet()">
                <span class="wallet-dot"></span>
                <span id="wallet-status">Connect Wallet</span>
            </button>
        </div>
    </div>

    <!-- BODY LAYOUT -->
    <div id="body-layout">

        <!-- LEFT SIDEBAR -->
        <div id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-section-label">Navigation</div>
                <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">âŠ</span> Home Feed</div>
                <div class="nav-item" onclick="switchPage('earnings', this)">
                    <span class="nav-icon">â—†</span> Creator Studio
                    <span class="nav-badge" id="sidebar-stars-badge">0 â˜…</span>
                </div>
                <div class="nav-item" onclick="switchPage('profile', this)"><span class="nav-icon">â—‰</span> My Profile</div>
                <div class="nav-item" onclick="switchPage('info', this)"><span class="nav-icon">â—</span> Tokenomics</div>
            </div>

            <div class="sidebar-vault">
                <div class="vault-label">Active Stars</div>
                <div class="vault-stars" id="user-stars">0 â˜…</div>
                <div class="vault-label" style="margin-top:8px;">APTM Vault</div>
                <div class="vault-aptm" id="sidebar-aptm-value">0.0000 $APTM</div>
                <div class="vault-rate" id="live-price-display">$0.3391 / APTM</div>
                <button class="btn btn-purple btn-sm" style="margin-top:12px; width:100%; font-size:0.72rem;" onclick="convertAPTM()">DEPOSIT $APTM</button>
            </div>

            <div style="padding: 10px 0 4px; border-top: 1px solid var(--border); margin-top: 12px;">
                <div class="vault-label" style="padding:0 2px; margin-bottom:4px;">Total Anchors</div>
                <div style="font-family:var(--font-mono); font-size:0.9rem; font-weight:700; color:var(--text-white);" id="total-anchors-display">0</div>
            </div>
        </div>

        <!-- FEED COLUMN -->
        <div id="feed-col">

            <!-- HOME PAGE -->
            <div id="page-home" style="display:contents;">
                <div class="feed-heading">Signal Feed</div>

                <!-- Compose -->
                <div class="card" style="border-color: rgba(124,92,191,0.25);">
                    <div class="composer-row">
                        <img id="pb-avatar" class="av" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                        <div>
                            <div class="composer-name" id="pb-handle">Anonymous_Creator</div>
                            <div class="composer-sub">Broadcasting to the network</div>
                        </div>
                    </div>

                    <textarea id="post-text" class="field" style="min-height:64px;" placeholder="What's your signal?"></textarea>

                    <div class="media-tabs">
                        <div class="mtab active" id="tab-url"  onclick="setMediaTab('url')">ğŸ”— URL</div>
                        <div class="mtab"        id="tab-file" onclick="setMediaTab('file')">ğŸ“ File â†’ Arweave</div>
                    </div>

                    <!-- URL input panel -->
                    <div id="url-input-wrap">
                        <input type="text" id="post-media" class="field" placeholder="Image URL (3.0â˜…) Â· Video URL (10.0â˜…)" oninput="updatePreview(this.value)">
                        <div id="media-preview-container">
                            <img id="preview-img" src="">
                        </div>
                    </div>

                    <!-- File upload panel (Irys) -->
                    <div id="file-input-wrap" style="display:none;">
                        <div class="upload-zone">
                            <input type="file" id="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                            <div class="upload-zone-text">
                                <strong>â†‘ Click or drop to upload</strong>
                                Stored permanently via Irys on Arweave.<br>
                                <span style="color:var(--purple-lt); font-size:0.68rem;">Tiny fee paid via MetaMask (MATIC).</span>
                            </div>
                        </div>
                        <div id="file-preview-wrap" style="display:none; margin-top:10px;">
                            <img   id="file-preview-img" style="max-width:100%; border-radius:10px; display:none;">
                            <video id="file-preview-vid" controls style="max-width:100%; border-radius:10px; display:none;"></video>
                            <div id="file-info" style="font-size:0.7rem; color:var(--text-muted); margin-top:5px;"></div>
                        </div>
                    </div>

                    <div id="irys-status"></div>
                    <div class="fee-display" id="post-fee-display"></div>
                    <button class="btn btn-purple" onclick="handleBroadcast()">â—ˆ Broadcast Signal</button>
                </div>

                <div id="feed-items"></div>
                <button id="load-more-btn" class="btn" onclick="showNextPage()">Load More Signals</button>
            </div>

            <!-- CREATOR STUDIO PAGE -->
            <div id="page-earnings" class="page">
                <div class="page-heading">Creator <span>Studio</span></div>

                <div class="card">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">Active Stars</div>
                            <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold);" id="creator-revenue-display">0 â˜…</div>
                            <div class="balance-note">âš¡ Live ledger</div>
                        </div>
                        <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px;">
                            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:4px;">APTM Vault</div>
                            <div style="font-family:var(--font-mono); font-size:0.95rem; font-weight:700; color:var(--teal); margin-top:6px;" id="earnings-aptm-value">0.0000 $APTM</div>
                            <div class="balance-note">ğŸ”’ On-chain</div>
                        </div>
                    </div>
                    <div class="info-box">
                        <strong>How it works:</strong> Stars power instant interactions on the internal ledger. Click <strong>Settle to Wallet</strong> to convert to $APTM on-chain.
                    </div>
                    <button class="btn btn-teal" style="width:auto; padding:10px 24px;" onclick="settleToWallet()">Settle to Wallet â†’</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--text-white);">Recent Activity</div>
                        <div style="font-size:0.62rem; color:var(--text-muted);">Last 10 transactions</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding-bottom:7px; border-bottom:1px solid var(--border); margin-bottom:4px;">
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; flex:1;">Description</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:center;">Type</span>
                        <span style="font-family:var(--font-mono); font-size:0.55rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; width:58px; text-align:right;">Amount</span>
                    </div>
                    <div id="ledger-list"><div class="ledger-empty">Connect wallet to view history.</div></div>
                </div>

                <!-- Admin Revenue Panel â€” only shown to CONFIG.ADMIN_ADDRESS -->
                <div class="card" id="admin-revenue-panel" style="border-color:rgba(240,180,41,0.2);">
                    <div style="font-family:var(--font-mono); font-size:0.58rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; font-weight:700; margin-bottom:4px;">ğŸ” Platform Revenue â€” Admin</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-bottom:12px;">Cumulative 20% platform fee from all interactions</div>
                    <div style="font-family:var(--font-mono); font-size:1.8rem; font-weight:700; color:var(--teal);" id="admin-revenue-display">0 â˜…</div>
                    <div style="font-size:0.62rem; color:var(--text-muted); margin-top:4px;" id="admin-revenue-count">0 fee events</div>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="page-profile" class="page">
                <div class="page-heading">My <span>Identity</span></div>
                <div class="card">
                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:14px;">Set your display name and avatar URL. Saved locally, shown on all broadcasts.</div>
                    <input type="text" id="handle-input" class="field" placeholder="@Username" style="margin-top:0;">
                    <input type="text" id="avatar-input" class="field" placeholder="Avatar Image URL">
                    <button class="btn btn-purple" onclick="saveProfile()">Sync Identity</button>
                </div>
            </div>

            <!-- TOKENOMICS PAGE -->
            <div id="page-info" class="page">
                <div class="page-heading">Token<span>omics</span></div>
                <div class="card">
                    <div class="tok-section">Broadcast Costs</div>
                    <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 â˜… + Irys fee</span></div>
                    <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 â˜… + Irys fee</span></div>
                    <div class="tok-row"><span class="tok-label">Boost to Top</span><span class="tok-value">10.0 â˜…</span></div>
                    <div class="tok-section">Interaction Costs</div>
                    <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Comment / Reply</span><span class="tok-value">1.0 â˜…</span></div>
                    <div class="tok-section">Creator Rewards (80%)</div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Post</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Comment on Post</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Hype on Comment</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-row"><span class="tok-label">Receive Reply</span><span class="tok-value">+0.8 â˜…</span></div>
                    <div class="tok-section">Decentralized Storage</div>
                    <div class="tok-row"><span class="tok-label">Provider</span><span class="tok-value" style="color:var(--teal);">Irys / Arweave</span></div>
                    <div class="tok-row"><span class="tok-label">Developer API Key</span><span class="tok-value" style="color:var(--green);">None Required</span></div>
                    <div class="tok-row"><span class="tok-label">Fee Payer</span><span class="tok-value" style="color:var(--text-white);">User via MetaMask (MATIC)</span></div>
                </div>
            </div>

        </div><!-- /feed-col -->

        <!-- RIGHT PANEL -->
        <div id="right-panel">

            <div class="rp-card">
                <div class="rp-heading">Star Balance</div>
                <div style="font-family:var(--font-mono); font-size:1.5rem; font-weight:700; color:var(--gold); margin-bottom:2px;" id="rp-stars">0 â˜…</div>
                <div style="font-size:0.7rem; color:var(--text-muted);">Spending power</div>
                <div class="sparkline"><div class="sparkline-line"></div></div>
                <div style="font-size:0.62rem; color:var(--text-muted);">Earnings this session</div>
            </div>

            <div class="rp-card">
                <div class="rp-heading">Platform Stats</div>
                <div class="stat-row">
                    <div class="stat-label">Creator Earnings<span>80% payout rate</span></div>
                    <div class="stat-val green">0.8 â˜…</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Platform Fee<span>Per interaction</span></div>
                    <div class="stat-val purple">0.2 â˜…</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">APTM Vault<span>On-chain balance</span></div>
                    <div class="stat-val teal" id="rp-aptm">0.0000</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Live APTM Rate<span>USD peg</span></div>
                    <div class="stat-val gold" id="rp-rate">$0.3391</div>
                </div>
                <div class="stat-row" style="border:none;">
                    <div class="stat-label">Total Anchors<span>All time</span></div>
                    <div class="stat-val" id="rp-anchors">0</div>
                </div>
            </div>

            <div class="rp-card">
                <div class="rp-heading">Storage</div>
                <div style="font-size:0.72rem; color:var(--text-secondary); line-height:1.6; margin-bottom:10px;">
                    Media is stored permanently on <span style="color:var(--teal); font-weight:600;">Arweave</span> via <span style="color:var(--purple-lt); font-weight:600;">Irys</span> using <strong style="color:var(--text-white);">MATIC</strong> token. No dev API key needed â€” users pay their own tiny fee via MetaMask.
                </div>
                <div style="display:flex; align-items:center; gap:6px; margin-top:8px;">
                    <span class="a-dot" style="background:var(--teal);"></span>
                    <span style="font-family:var(--font-mono); font-size:0.6rem; color:var(--teal);">PERMANENT STORAGE ACTIVE</span>
                </div>
            </div>

        </div><!-- /right-panel -->

    </div><!-- /body-layout -->
</div><!-- /app-shell -->

<div id="toast"></div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš™ï¸  GLOBAL CONFIG
    //     Fix #2: Both addresses hardcoded lowercase to prevent checksum
    //     Fix #3: Fees confirmed TEXT=1.2, PHOTO=3.0, VIDEO=10.0
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CONFIG = {
        ADMIN_ADDRESS:    "0xe348fedea1850a0c2d4ac0fed3f903774de1e16a",
        CONTRACT_ADDRESS: "0x42e0a97844ac6623207f2a363aa318e83268910f",
        STARS_PER_5_APTM: 169,
        STAR_USD:         0.01,
        PLATFORM_CUT:     0.2,
        CREATOR_CUT:      0.8,
        FEES: {
            TEXT:  1.2,   // â˜… Fix #3
            PHOTO: 3.0,   // â˜… Fix #3
            VIDEO: 10.0,  // â˜… Fix #3
            BOOST: 10,
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentAptmBalance = "0.0000";
    let starBalance = "0";
    let creatorEarnings = 0;
    let currentAptmPriceUsd = 0.3391;
    let totalAnchors = 0;
    let provider, signer, hubContract;
    let userAddress = "";
    let userHandle = localStorage.getItem('hub_userName') || "Anonymous_Creator";
    let userAvatar  = localStorage.getItem('hub_userPic')  || "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";
    let visibleCount = 10;
    const pageSize = 10;

    const abi = [
        "function depositAPTM() public payable",
        "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
        "function boostPost(uint256 _oneStarWei) public",
        "function interact(address _recipient, uint256 _oneStarWei) public",
        "function starBalances(address _user) view returns (uint256)",
        "function aptmBalances(address) view returns (uint256)",
        "function totalAnchors() view returns (uint256)",
        "function userWithdraw(uint256 _amountWei) public",
        "function adminWithdraw() public",
        "function PLATFORM_ADMIN() view returns (address)"
    ];

    // Media tab state
    let mediaTabMode = 'url';
    let selectedFile = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MEDIA TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setMediaTab(mode) {
        mediaTabMode = mode;
        document.getElementById('tab-url').classList.toggle('active', mode === 'url');
        document.getElementById('tab-file').classList.toggle('active', mode === 'file');
        document.getElementById('url-input-wrap').style.display  = mode === 'url'  ? '' : 'none';
        document.getElementById('file-input-wrap').style.display = mode === 'file' ? '' : 'none';
        updatePostFeeDisplay();
    }

    function updatePostFeeDisplay() {
        const el = document.getElementById('post-fee-display');
        if (!el) return;
        const url = document.getElementById('post-media')?.value || '';
        let cost = CONFIG.FEES.TEXT.toFixed(1) + ' â˜…';
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' â˜…  +  Irys fee (MATIC via MetaMask)';
        } else if (url) {
            const isVid = url.includes('mp4') || getYoutubeId(url);
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + ' â˜…';
        }
        el.textContent = 'Est. cost: ' + cost;
    }

    function handleFileSelect(input) {
        selectedFile = input.files[0];
        if (!selectedFile) return;
        const wrap = document.getElementById('file-preview-wrap');
        const img  = document.getElementById('file-preview-img');
        const vid  = document.getElementById('file-preview-vid');
        const info = document.getElementById('file-info');
        wrap.style.display = 'block';
        img.style.display  = 'none';
        vid.style.display  = 'none';
        const objUrl = URL.createObjectURL(selectedFile);
        if (selectedFile.type.startsWith('image/')) {
            img.src = objUrl; img.style.display = 'block';
        } else {
            vid.src = objUrl; vid.style.display = 'block';
        }
        const kb = (selectedFile.size / 1024).toFixed(1);
        info.innerHTML = `<span style="color:var(--purple-lt);">â—ˆ ${selectedFile.name}</span> Â· ${kb} KB Â· Will upload to Arweave via Irys (MATIC)`;
        updatePostFeeDisplay();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIX #1 â€” IRYS UPLOAD  (WebIrys, node1.irys.xyz, token: matic)
    //
    // The SDK is loaded via the <script> tag in <head>.
    // WebIrys is available at window.WebIrys after that script executes.
    // The user's MetaMask is used to sign the fund + upload transactions.
    // The Arweave URL is returned and stored BEFORE Firebase write.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function uploadToIrys(file) {
        if (!window.ethereum) throw new Error("MetaMask not found");

        const statusEl = document.getElementById('irys-status');
        const show = (msg, color) => {
            statusEl.style.display = 'block';
            statusEl.style.color   = color || 'var(--purple-lt)';
            statusEl.textContent   = 'â—ˆ Irys: ' + msg;
        };

        show('Initialising Irys WebIrysâ€¦');

        // Build the WebIrys instance using the injected MetaMask provider
        // token: "matic" â€” user pays storage fee in MATIC (Polygon)
        const webIrys = new WebIrys({
            url:    "https://node1.irys.xyz",
            token:  "matic",
            wallet: { rpcUrl: "https://polygon-rpc.com", name: "ethersv5", provider: new ethers.providers.Web3Provider(window.ethereum) }
        });

        await webIrys.ready();
        show('Connected to Irys node1. Estimating feeâ€¦');

        // Get the cost in atomic MATIC for this file size
        const price = await webIrys.getPrice(file.size);
        const humanPrice = webIrys.utils.fromAtomic(price);
        show(`Storage fee: ${parseFloat(humanPrice).toFixed(6)} MATIC â€” opening MetaMaskâ€¦`, 'var(--teal)');

        // Check loaded balance; fund if needed â€” this triggers MetaMask
        const balance = await webIrys.getLoadedBalance();
        if (balance.lt(price)) {
            show('Funding Irys node (MetaMask will open)â€¦', 'var(--teal)');
            // Fund with 1.2x to cover any minor variance
            await webIrys.fund(price.multipliedBy(1.2).integerValue());
            show('Funded! Uploading file to Arweaveâ€¦');
        } else {
            show('Balance sufficient. Uploading file to Arweaveâ€¦');
        }

        // Read the file as a Buffer and upload with its MIME type as a tag
        const arrayBuffer = await file.arrayBuffer();
        const dataBuffer  = Buffer.from(arrayBuffer);

        const receipt = await webIrys.uploadData(dataBuffer, {
            tags: [
                { name: "Content-Type",   value: file.type },
                { name: "App-Name",       value: "SocialHub-Signal-Protocol" },
                { name: "App-Version",    value: "9.0" }
            ]
        });

        const arweaveUrl = `https://gateway.irys.xyz/${receipt.id}`;
        show(`âœ“ Permanent! TX: ${receipt.id.slice(0, 14)}â€¦  â†’  gateway.irys.xyz`, 'var(--green)');
        console.log("Irys receipt:", receipt);
        return arweaveUrl;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRICE ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function getLiveAptmPrice() {
        const poolAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57";
        try {
            if (!provider) return 0.3391;
            const poolContract = new ethers.Contract(
                poolAddress,
                ["function getReserves() external view returns (uint112, uint112, uint32)"],
                provider
            );
            const reserves   = await poolContract.getReserves();
            const humanAptm  = parseFloat(ethers.utils.formatUnits(reserves[0], 18));
            const humanUsdt  = parseFloat(ethers.utils.formatUnits(reserves[1], 18));
            const price      = humanUsdt / humanAptm;
            return price > 0 ? price : 0.3391;
        } catch (e) { return 0.3391; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function connectWallet() {
        if (!window.ethereum) return alert("MetaMask not found");
        try {
            provider    = new ethers.providers.Web3Provider(window.ethereum);
            const accts = await provider.send("eth_requestAccounts", []);
            userAddress = accts[0];
            signer      = provider.getSigner();
            // Fix #2: CONTRACT_ADDRESS already lowercase, ethers accepts it fine
            hubContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, abi, signer);

            const statusEl = document.getElementById('wallet-status');
            if (statusEl) statusEl.textContent = userAddress.slice(0, 6) + 'â€¦' + userAddress.slice(-4);

            await syncData();
            updateUI();
            subscribeToEarnings(userAddress);
            subscribeLedger(userAddress);
            subscribeAdminRevenue(userAddress);
            if (typeof loadGlobalFeed === "function") loadGlobalFeed();
            showToast("Connected & Synced âœ“");
        } catch (err) {
            console.error(err);
            showToast("Connection Failed");
        }
    }

    async function syncData() {
        if (!hubContract || !signer) return;
        try {
            const addr              = await signer.getAddress();
            const [balRaw, anchors] = await Promise.all([
                hubContract.aptmBalances(addr),
                hubContract.totalAnchors()
            ]);
            const humanBalance  = ethers.utils.formatEther(balRaw);
            currentAptmBalance  = humanBalance;
            currentAptmPriceUsd = await getLiveAptmPrice();
            const usdValue      = parseFloat(humanBalance) * parseFloat(currentAptmPriceUsd);
            starBalance         = Math.floor(usdValue / CONFIG.STAR_USD).toString();
            totalAnchors        = anchors.toNumber();

            if (window.db) {
                const userRef = window.fs.doc(window.db, "user_balances", addr.toLowerCase());
                const snap    = await window.fs.getDoc(userRef);
                if (!snap.exists()) {
                    await window.fs.setDoc(userRef, { stars: 0, lastSync: Date.now(), address: addr.toLowerCase() });
                } else {
                    await window.fs.updateDoc(userRef, { lastSync: Date.now() });
                }
            }
            updateUI();
        } catch (e) { console.error("Sync Failed:", e); }
    }

    function updateUI() {
        try {
            const s = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            s('user-stars',              (starBalance || "0") + " â˜…");
            s('sidebar-stars-badge',     (starBalance || "0") + " â˜…");
            s('rp-stars',                (starBalance || "0") + " â˜…");
            s('sidebar-aptm-value',      (currentAptmBalance || "0.0000") + " $APTM");
            s('earnings-aptm-value',     (currentAptmBalance || "0.0000") + " $APTM");
            s('rp-aptm',                 parseFloat(currentAptmBalance || 0).toFixed(4));
            s('creator-revenue-display', creatorEarnings.toFixed(1) + " â˜…");
            s('live-price-display',      `$${parseFloat(currentAptmPriceUsd).toFixed(4)} / APTM`);
            s('rp-rate',                 `$${parseFloat(currentAptmPriceUsd).toFixed(4)}`);
            s('total-anchors-display',   totalAnchors);
            s('rp-anchors',              totalAnchors);

            const pbAv = document.getElementById('pb-avatar');   if (pbAv) pbAv.src = userAvatar;
            const nvAv = document.getElementById('nav-avatar');   if (nvAv) nvAv.src = userAvatar;
            const pbH  = document.getElementById('pb-handle');    if (pbH)  pbH.textContent  = userHandle;
            const nvH  = document.getElementById('nav-handle');   if (nvH)  nvH.textContent  = userHandle;
        } catch (e) { console.error("UI Update Error:", e); }
    }

    function saveProfile() {
        const nameVal = document.getElementById('handle-input').value;
        const picVal  = document.getElementById('avatar-input').value;
        if (nameVal && picVal) {
            localStorage.setItem('hub_userName', nameVal);
            localStorage.setItem('hub_userPic',  picVal);
            userHandle = nameVal; userAvatar = picVal;
            updateUI(); showToast("Identity Saved âœ“"); loadGlobalFeed();
        } else {
            alert("Please enter both a name and an image URL");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STAR ECONOMY â€” Firebase balance helpers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function adjustFirebaseBalance(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref  = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap    = await txn.get(ref);
                const current = snap.exists() ? (snap.data().stars || 0) : 0;
                txn.set(ref, { stars: Math.max(0, current + amount), lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) { console.error("Balance adjustment failed:", e); }
    }

    function subscribeToEarnings(walletAddr) {
        if (!walletAddr || !window.db) return;
        const ref = window.fs.doc(window.db, "user_balances", walletAddr.toLowerCase());
        window.fs.onSnapshot(ref, (snap) => {
            creatorEarnings = snap.exists() ? (snap.data().stars || 0) : 0;
            const el = document.getElementById('creator-revenue-display');
            if (el) el.textContent = creatorEarnings.toFixed(1) + " â˜…";
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSACTION LEDGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function logTransaction(address, type, amount, description) {
        if (!address || !window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "user_transactions"), {
            address: address.toLowerCase(), type, amount, description, timestamp: Date.now()
        }).catch(e => console.warn("logTransaction:", e));
    }

    function logPlatformRevenue(sourceAddress, actionType, amount) {
        if (!window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
            sourceAddress: (sourceAddress || "unknown").toLowerCase(),
            actionType, amount, timestamp: Date.now()
        }).catch(e => console.warn("logPlatformRevenue:", e));
    }

    function subscribeLedger(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const q    = window.fs.query(
            window.fs.collection(window.db, "user_transactions"),
            window.fs.where("address", "==", addr),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (docs) => {
            const el = document.getElementById('ledger-list');
            if (!el) return;
            if (docs.length === 0) { el.innerHTML = `<div class="ledger-empty">No activity yet.</div>`; return; }
            el.innerHTML = "";
            docs.slice(0, 10).forEach(tx => {
                const isEarn   = tx.type === "earn" || tx.type === "deposit";
                const prefix   = isEarn ? "+" : "âˆ’";
                const amtStr   = prefix + parseFloat(tx.amount).toFixed(1) + " â˜…";
                const amtCls   = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                const badge    = { earn:"Earned", spend:"Spent", deposit:"Deposit", settle:"Settle" }[tx.type] || tx.type;
                const date     = new Date(tx.timestamp).toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
                const row      = document.createElement('div');
                row.className  = 'ledger-row';
                row.innerHTML  = `
                    <div class="ledger-desc">${tx.description}<small>${date}</small></div>
                    <div style="width:58px;text-align:center;flex-shrink:0;"><span class="ledger-badge ${tx.type}">${badge}</span></div>
                    <div class="ledger-amount ${amtCls}">${amtStr}</div>`;
                el.appendChild(row);
            });
        };
        window.fs.onSnapshot(q, (snap) => {
            const docs = []; snap.forEach(d => docs.push(d.data())); render(docs);
        }, (err) => {
            console.warn("Ledger fallback:", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "user_transactions"),
                window.fs.where("address", "==", addr)
            );
            window.fs.onSnapshot(fq, (snap) => {
                const docs = []; snap.forEach(d => docs.push(d.data()));
                docs.sort((a, b) => b.timestamp - a.timestamp); render(docs);
            });
        });
    }

    function subscribeAdminRevenue(walletAddr) {
        if (!walletAddr || !window.db) return;
        // Security gate â€” only show panel + data if wallet matches ADMIN_ADDRESS
        if (walletAddr.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) return;

        const panel = document.getElementById('admin-revenue-panel');
        if (panel) panel.style.display = 'block';

        const q = window.fs.query(
            window.fs.collection(window.db, "platform_revenue"),
            window.fs.orderBy("timestamp", "desc")
        );
        const render = (snap) => {
            let total = 0; snap.forEach(d => { total += (d.data().amount || 0); });
            const dEl = document.getElementById('admin-revenue-display'); if (dEl) dEl.textContent = total.toFixed(1) + " â˜…";
            const cEl = document.getElementById('admin-revenue-count');   if (cEl) cEl.textContent = snap.size + " fee events";
        };
        window.fs.onSnapshot(q, render, () => {
            window.fs.onSnapshot(window.fs.collection(window.db, "platform_revenue"), render);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function convertAPTM() {
        currentAptmPriceUsd = await getLiveAptmPrice();
        const amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
        if (amt && hubContract) {
            try {
                showToast(`Depositing ${amt} $APTMâ€¦`);
                const tx = await hubContract.depositAPTM({ value: ethers.utils.parseEther(amt), gasLimit: 150000 });
                await tx.wait();
                const starsReceived = Math.floor(parseFloat(amt) * currentAptmPriceUsd / CONFIG.STAR_USD);
                logTransaction(userAddress, "deposit", starsReceived, `Deposited ${parseFloat(amt).toFixed(2)} $APTM â†’ ${starsReceived} Stars`);
                setTimeout(() => { syncData(); }, 2000);
            } catch (e) { console.error(e); alert("Transaction failed."); }
        }
    }

    async function settleToWallet() {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const addr        = await signer.getAddress();
            const rawBalance  = await hubContract.aptmBalances(addr);
            const humanAmount = ethers.utils.formatEther(rawBalance);
            const amt         = prompt(`Withdraw\nBalance: ${humanAmount} APTM`, humanAmount);
            if (amt && hubContract) {
                showToast("Opening MetaMaskâ€¦");
                const withdrawWei = ethers.utils.parseUnits(parseFloat(amt).toFixed(18), 18);
                const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
                await tx.wait();
                logTransaction(addr, "settle", parseFloat(amt), `Settled ${parseFloat(amt).toFixed(4)} $APTM to wallet`);
                showToast("Success! âœ“");
                syncData();
            }
        } catch (e) { console.error(e); alert("Failed: " + (e.reason || e.message).slice(0, 100)); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FEED HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .card');
        posts.forEach((post, i) => {
            if (i < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const btn = document.getElementById('load-more-btn');
        if (btn) btn.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() { visibleCount += pageSize; refreshFeedVisibility(); }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img       = document.getElementById('preview-img');
        if (url && url.startsWith('http')) { img.src = url; container.style.display = 'block'; }
        else { container.style.display = 'none'; }
        updatePostFeeDisplay();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        if (t) { t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2800); }
    }

    function switchPage(p, el) {
        document.getElementById('page-home').style.display = 'none';
        ['earnings', 'profile', 'info'].forEach(id => {
            const pg = document.getElementById('page-' + id);
            if (pg) pg.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        if (p === 'home') {
            document.getElementById('page-home').style.display = 'contents';
        } else {
            const pg = document.getElementById('page-' + p);
            if (pg) pg.classList.add('active');
        }
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match  = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIX #4 â€” BROADCAST
    // Irys upload fully awaited BEFORE Firebase write.
    // mediaUrl is guaranteed to hold the Arweave URL (or empty) when
    // the post document is created.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleBroadcast() {
        const txt = document.getElementById('post-text').value.trim();
        if (!txt)         return alert("Write something first!");
        if (!hubContract) return alert("Connect your wallet first!");

        let mediaUrl  = "";
        let feeAmount = CONFIG.FEES.TEXT;
        let type      = 1;
        let isArweave = false;

        // â”€â”€ Step 1: Irys upload (if file mode) â”€â”€
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            feeAmount   = isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO;
            type        = isVid ? 3 : 2;

            showToast("Step 1/3: Uploading to Arweave via Irysâ€¦");
            try {
                mediaUrl  = await uploadToIrys(selectedFile);   // â† fully awaited
                isArweave = true;
                showToast("Step 1/3: âœ“ Stored on Arweave!");
            } catch (e) {
                console.error("Irys upload failed:", e);
                return alert("Irys upload failed: " + e.message + "\n\nCheck MetaMask and ensure you're on Polygon network.");
            }
        } else {
            // URL path
            const url = document.getElementById('post-media').value.trim();
            if (url) {
                if (url.includes('mp4') || getYoutubeId(url)) { feeAmount = CONFIG.FEES.VIDEO; type = 3; }
                else { feeAmount = CONFIG.FEES.PHOTO; type = 2; }
                mediaUrl = url;
            }
        }

        // â”€â”€ Step 2: On-chain contract call (stars deduction) â”€â”€
        const feeWei = ethers.utils.parseEther(feeAmount.toString());
        let onChainTx;
        try {
            const userAddr      = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);

            showToast(`Step 2/3: Paying ${feeAmount}â˜… on-chainâ€¦`);

            if (internalStars.gte(feeWei)) {
                onChainTx = await hubContract.postContent("", type, feeWei, { gasLimit: 500000 });
            } else {
                onChainTx = await hubContract.postContent("", type, feeWei, { value: feeWei, gasLimit: 500000 });
            }
            await onChainTx.wait();
        } catch (e) {
            console.error("On-chain tx failed:", e);
            return alert("On-chain transaction failed. Check your APTM / Stars balance.\n\n" + (e.reason || e.message).slice(0, 120));
        }

        // â”€â”€ Step 3: Write post to Firebase (mediaUrl guaranteed) â”€â”€
        try {
            const userAddr       = await signer.getAddress();
            const postAuthorName = localStorage.getItem('hub_userName') || userHandle;
            const postAuthorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            const postData = {
                text:      txt,
                media:     mediaUrl,      // â† Arweave URL or external URL, captured before this write
                arweave:   isArweave,
                author:    postAuthorName,
                authorAddr: userAddr,
                avatar:    postAuthorPic,
                timestamp: Date.now(),
                hypes:     0,
                type,
                feePaid:   feeAmount
            };

            showToast("Step 3/3: Writing to Firebaseâ€¦");
            await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

            // Clean up composer
            document.getElementById('post-text').value  = "";
            document.getElementById('post-media').value = "";
            document.getElementById('irys-status').style.display = 'none';
            selectedFile = null;
            const fPrev = document.getElementById('file-preview-wrap');
            if (fPrev) fPrev.style.display = 'none';

            showToast("Signal Live! â—ˆ");
            logTransaction(userAddr, "spend", parseFloat(feeAmount), `Paid ${feeAmount}â˜… for Content Broadcast`);
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) {
            console.error("Firebase write failed:", e);
            alert("Post anchored on-chain but Firebase write failed: " + e.message);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BOOST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function boostPost(postId) {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const userAddr      = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            const boostFee      = ethers.utils.parseEther(CONFIG.FEES.BOOST.toString());
            let tx;
            showToast("Preparing 10â˜… Boostâ€¦");
            if (internalStars.gte(boostFee)) {
                tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 });
            } else {
                tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 });
            }
            await tx.wait();
            const postRef = window.fs.doc(window.db, "posts", postId);
            await window.fs.updateDoc(postRef, { timestamp: Date.now(), isBoosted: true });
            showToast("Signal Boosted! ğŸš€");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { console.error(e); alert("Boost failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HYPE  (80/20 split preserved)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function hypeElement(recipientAddress, displayId) {
        if (parseInt(starBalance) < 1) return alert("Not enough Stars! Deposit APTM to continue.");
        try {
            const isComment = displayId.startsWith('hc-');
            const entityId  = displayId.replace(isComment ? 'hc-' : 'hp-', '');

            if (isComment) {
                await window.fs.updateDoc(window.fs.doc(window.db, "comments", entityId), { hypes: window.fs.increment(1) });
            } else {
                await window.fs.updateDoc(window.fs.doc(window.db, "posts", entityId),    { hypes: window.fs.increment(1) });
            }

            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(
                    recipientAddress, "earn", CONFIG.CREATOR_CUT,
                    isComment ? "Earned 0.8â˜… â€” someone hyped your comment" : "Earned 0.8â˜… â€” someone hyped your post"
                );
            }

            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            logTransaction(userAddress, "spend", 1, isComment ? "Spent 1â˜… on Comment Hype" : "Spent 1â˜… on Post Hype");
            logPlatformRevenue(userAddress, isComment ? "hype_comment" : "hype_post", CONFIG.PLATFORM_CUT);

            const counterEl = document.getElementById(displayId);
            if (counterEl) counterEl.textContent = (parseInt(counterEl.textContent || "0") + 1);
            showToast("Hyped! Creator +0.8â˜…");
        } catch (e) { console.error(e); showToast("Hype failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleTray(id) {
        const t = document.getElementById(`tray-${id}`);
        if (!t) return;
        t.style.display = t.style.display === 'block' ? 'none' : 'block';
    }

    async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
        if (parseInt(starBalance) < 1) return alert("Not enough Stars!");
        const inputId    = isReply ? `reply-in-${parentId}` : `input-${postId}`;
        const input      = document.getElementById(inputId);
        const commentText = input ? input.value.trim() : "";
        if (!commentText) return;
        try {
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;
            const commentData = {
                text: commentText, author: authorName,
                authorAddr: userAddress || "unknown", avatar: authorPic,
                postId: String(postId), parentId: parentId || null,
                isReply, timestamp: Date.now(), hypes: 0
            };
            await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);

            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8â˜… â€” someone commented on your content");
            }

            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            logTransaction(userAddress, "spend", 1, isReply ? "Spent 1â˜… on a Reply" : "Spent 1â˜… on a Comment");
            logPlatformRevenue(userAddress, isReply ? "reply" : "comment", CONFIG.PLATFORM_CUT);

            if (input) input.value = "";
            const tray = document.getElementById(`tray-${postId}`);
            if (tray) tray.style.display = 'block';
            showToast("Comment Live! Creator +0.8â˜…");
        } catch (e) { console.error(e); showToast("Failed."); }
    }

    const _commentListeners = {};

    async function loadComments(postId) {
        const list = document.getElementById(`list-${postId}`);
        if (!list || !window.db || _commentListeners[postId]) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "comments"),
            window.fs.where("postId", "==", String(postId)),
            window.fs.orderBy("timestamp", "asc")
        );

        const renderComments = (snapshot) => {
            list.innerHTML = "";
            const topLevel = [], repliesMap = {};
            snapshot.forEach(docRef => {
                const data = { ...docRef.data(), _id: docRef.id };
                if (data.parentId) {
                    if (!repliesMap[data.parentId]) repliesMap[data.parentId] = [];
                    repliesMap[data.parentId].push(data);
                } else { topLevel.push(data); }
            });
            const counterEl = document.getElementById(`cc-${postId}`);
            if (counterEl) counterEl.textContent = snapshot.size > 0 ? ` (${snapshot.size})` : '';
            if (topLevel.length === 0) {
                list.innerHTML = `<div style="font-size:0.72rem;color:var(--text-muted);padding:8px;">No comments yet. Be first!</div>`;
                return;
            }
            const renderRow = (comment, isNested) => {
                const cId        = comment._id;
                const authorAddr = comment.authorAddr || "unknown";
                const row        = document.createElement('div');
                row.className    = 'cmt-row' + (isNested ? ' nested' : '');
                row.innerHTML    = `
                    <span class="cmt-author">${comment.author || "Anonymous"}</span>: ${comment.text}
                    <div class="cmt-meta">
                        <span class="cbtn" onclick="hypeElement('${authorAddr}','hc-${cId}')">â¤ <span id="hc-${cId}">${comment.hypes || 0}</span></span>
                        ${!isNested ? `<span class="cbtn reply" onclick="toggleReplyInput('${cId}')">â†© Reply</span>` : ''}
                    </div>
                    ${!isNested ? `
                    <div class="reply-area" id="reply-area-${cId}">
                        <div class="reply-row">
                            <input type="text" class="field" id="reply-in-${cId}" placeholder="Replyâ€¦ (1â˜…)" style="font-size:0.8rem;">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${authorAddr}','${postId}',true,'${cId}')">Send</button>
                        </div>
                    </div>` : ''}`;
                return row;
            };
            topLevel.forEach(c => {
                list.appendChild(renderRow(c, false));
                (repliesMap[c._id] || []).forEach(r => list.appendChild(renderRow(r, true)));
            });
        };

        _commentListeners[postId] = window.fs.onSnapshot(q, renderComments, (err) => {
            console.error("Comment listener, trying fallback:", err.message);
            const fq = window.fs.query(
                window.fs.collection(window.db, "comments"),
                window.fs.where("postId", "==", String(postId))
            );
            _commentListeners[postId] = window.fs.onSnapshot(fq, (snap) => {
                const sorted = {
                    forEach: (fn) => {
                        const docs = [];
                        snap.forEach(d => docs.push({ ...d, data: () => d.data(), id: d.id }));
                        docs.sort((a, b) => (a.data().timestamp || 0) - (b.data().timestamp || 0));
                        docs.forEach(fn);
                    },
                    size: snap.size
                };
                renderComments(sorted);
            });
        });
    }

    function toggleReplyInput(commentId) {
        const area = document.getElementById(`reply-area-${commentId}`);
        if (!area) return;
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            const inp = document.getElementById(`reply-in-${commentId}`);
            if (inp) setTimeout(() => inp.focus(), 50);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL FEED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadGlobalFeed() {
        const feedContainer = document.getElementById('feed-items');
        if (!feedContainer || !window.db) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "posts"),
            window.fs.orderBy("timestamp", "desc")
        );

        window.fs.onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = "";
            Object.keys(_commentListeners).forEach(k => {
                if (typeof _commentListeners[k] === 'function') _commentListeners[k]();
                delete _commentListeners[k];
            });

            snapshot.forEach((docRef) => {
                const post      = docRef.data();
                const postId    = docRef.id;
                const isMe      = (post.authorAddr && userAddress && post.authorAddr.toLowerCase() === userAddress.toLowerCase());
                const localName = localStorage.getItem('hub_userName');
                const localPic  = localStorage.getItem('hub_userPic');
                const displayPic  = (isMe && localPic)  ? localPic  : (post.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${post.authorAddr || 'anon'}`);
                const displayName = (isMe && localName) ? localName : (post.author || "Anonymous");

                let mediaHtml  = '';
                const ytId     = getYoutubeId(post.media || "");
                const arwBadge = post.arweave
                    ? `<div style="margin-bottom:8px;"><span class="arweave-tag"><span class="a-dot"></span>PERMANENT Â· ARWEAVE</span></div>`
                    : '';

                if (ytId) {
                    mediaHtml = `${arwBadge}<div class="post-media"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
                } else if (post.media) {
                    mediaHtml = `${arwBadge}<div class="post-media"><img src="${post.media}" loading="lazy"></div>`;
                }

                const item = document.createElement('div');
                item.className = 'card post-card';
                item.setAttribute('data-id', postId);
                if (post.isBoosted) item.style.borderColor = 'rgba(240,180,41,0.3)';

                item.innerHTML = `
                    <div class="post-header">
                        <img src="${displayPic}" class="av">
                        <div class="post-meta">
                            <div class="post-author">${displayName} ${post.isBoosted ? '<span class="boosted-badge">ğŸš€ BOOSTED</span>' : ''}</div>
                            <div class="post-addr">${post.authorAddr ? post.authorAddr.slice(0,6)+'â€¦'+post.authorAddr.slice(-4) : 'anon'}</div>
                        </div>
                        <span class="post-more">Â·Â·Â·</span>
                    </div>
                    ${mediaHtml}
                    <div class="post-body">${post.text}</div>
                    <div class="post-actions">
                        <div class="pact" onclick="hypeElement('${post.authorAddr}','hp-${postId}')">â¤ <span class="pact-num" id="hp-${postId}">${post.hypes || 0}</span> Like</div>
                        <div class="pact" onclick="toggleTray('${postId}'); loadComments('${postId}')">ğŸ’¬ Comment<span class="pact-num" id="cc-${postId}" style="color:var(--teal);"></span></div>
                        <div class="pact boost" style="margin-left:auto;" onclick="boostPost('${postId}')">ğŸš€ Boost (10â˜…)</div>
                    </div>
                    <div class="comment-tray" id="tray-${postId}">
                        <div class="comment-list" id="list-${postId}"></div>
                        <div class="cmt-input-row">
                            <input type="text" class="field" style="font-size:0.8rem;" placeholder="Add a comment (1â˜…)â€¦" id="input-${postId}">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${post.authorAddr}','${postId}')">Send</button>
                        </div>
                    </div>`;
                feedContainer.appendChild(item);
            });
            if (typeof refreshFeedVisibility === "function") refreshFeedVisibility();
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STARTUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('load', async () => {
        try {
            updateUI();
            currentAptmPriceUsd = await getLiveAptmPrice();
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
            setTimeout(() => { loadGlobalFeed(); }, 1500);
        } catch (e) { console.error("Startup failed:", e); }
    });

    // Heartbeat â€” 30s sync
    setInterval(async () => {
        if (provider && hubContract) {
            try {
                currentAptmPriceUsd = await getLiveAptmPrice();
                await syncData();
            } catch (e) { console.error("Heartbeat failed:", e); }
        }
    }, 30000);

</script>
</body>
</html>
