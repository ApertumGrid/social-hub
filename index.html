
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIALHUB â€” SIGNAL PROTOCOL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@irys/sdk"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
            authDomain: "socialhub-33014.firebaseapp.com",
            projectId: "socialhub-33014",
            storageBucket: "socialhub-33014.firebasestorage.app",
            messagingSenderId: "864088350104",
            appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
            measurementId: "G-B2C1K1LVGQ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fs = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment, where, runTransaction, setDoc, getDoc };
        console.log("Firebase Linked âœ“");
    </script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep:    #030712;
            --bg-navy:    #0f172a;
            --bg-slate:   #1e293b;
            --cyan:       #22d3ee;
            --cyan-dim:   rgba(34,211,238,0.12);
            --cyan-glow:  rgba(34,211,238,0.25);
            --purple:     #a78bfa;
            --purple-dim: rgba(167,139,250,0.12);
            --gold:       #fbbf24;
            --green:      #4ade80;
            --red:        #f87171;
            --glass-bg:   rgba(15,23,42,0.65);
            --glass-bg2:  rgba(30,41,59,0.55);
            --border:     rgba(255,255,255,0.07);
            --border-lit: rgba(34,211,238,0.2);
            --text:       #e2e8f0;
            --muted:      #64748b;
            --mono:       'Space Mono', monospace;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { height: 100%; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* â”€â”€ Animated mesh background â”€â”€ */
        body::before {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            background:
                radial-gradient(ellipse 80% 60% at 10% 0%,   rgba(34,211,238,0.06) 0%, transparent 60%),
                radial-gradient(ellipse 60% 50% at 90% 100%, rgba(167,139,250,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 50% 50%,  rgba(15,23,42,0.9) 0%, transparent 100%);
        }

        /* â”€â”€ Noise texture overlay â”€â”€ */
        body::after {
            content: '';
            position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #sidebar {
            position: relative; z-index: 10;
            width: 270px; flex-shrink: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 32px 20px;
            gap: 0;
        }

        .logo-wrap { margin-bottom: 36px; padding: 0 8px; }
        .logo-mark {
            font-family: var(--mono);
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--cyan);
            letter-spacing: 4px;
            text-transform: uppercase;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        .logo-text {
            font-family: var(--mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -1px;
            line-height: 1;
        }
        .logo-text span { color: var(--cyan); }

        /* Nav */
        .nav-group { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 11px 14px; border-radius: 12px;
            cursor: pointer; color: var(--muted);
            font-weight: 500; font-size: 0.88rem;
            transition: all 0.2s ease;
            position: relative; overflow: hidden;
            border: 1px solid transparent;
        }
        .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
        .nav-item.active {
            color: var(--cyan);
            background: var(--cyan-dim);
            border-color: var(--border-lit);
        }
        .nav-item.active::before {
            content: '';
            position: absolute; left: 0; top: 20%; bottom: 20%;
            width: 2px; background: var(--cyan);
            border-radius: 2px;
        }
        .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }

        /* Sidebar bottom panel */
        .sidebar-foot {
            margin-top: auto;
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 18px;
        }
        .foot-label {
            font-family: var(--mono);
            font-size: 0.55rem;
            color: var(--muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .foot-stars {
            font-family: var(--mono);
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--gold);
            line-height: 1;
            margin-bottom: 2px;
        }
        .foot-aptm {
            font-size: 0.75rem;
            color: var(--cyan);
            font-weight: 600;
            margin-bottom: 2px;
        }
        .foot-rate {
            font-family: var(--mono);
            font-size: 0.55rem;
            color: var(--muted);
            margin-bottom: 16px;
        }
        .foot-note {
            font-size: 0.65rem;
            color: var(--muted);
            line-height: 1.5;
            margin-bottom: 14px;
        }
        .foot-anchors { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN VIEWPORT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #viewport {
            position: relative; z-index: 5;
            flex-grow: 1;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Top bar */
        .topbar {
            height: 64px; flex-shrink: 0;
            padding: 0 40px;
            display: flex; align-items: center; justify-content: flex-end; gap: 12px;
            background: rgba(3,7,18,0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        #wallet-status {
            font-family: var(--mono);
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--cyan);
            background: var(--cyan-dim);
            border: 1px solid var(--border-lit);
            padding: 8px 18px;
            border-radius: 50px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        #wallet-status:hover { background: var(--cyan-glow); }

        /* Scrollable content */
        #scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 32px 40px 60px;
        }
        #scroll-area::-webkit-scrollbar { width: 4px; }
        #scroll-area::-webkit-scrollbar-track { background: transparent; }
        #scroll-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }

        #main-content { max-width: 680px; margin: 0 auto; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GLASS PANELS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .glass:hover { border-color: rgba(255,255,255,0.1); }
        .glass.cyan-border { border-color: var(--border-lit); }
        .glass.gold-border { border-color: rgba(251,191,36,0.25); }
        .glass.purple-border { border-color: rgba(167,139,250,0.2); }

        /* Shimmer stripe on panels */
        .glass::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
        }

        /* â”€â”€ Page headings â”€â”€ */
        .page-heading {
            font-family: var(--mono);
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
            margin-bottom: 24px;
        }
        .page-heading span { color: var(--cyan); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMPOSE BOX
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .composer-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 16px;
        }
        .avatar {
            width: 42px; height: 42px; border-radius: 50%;
            border: 2px solid var(--border-lit);
            object-fit: cover; flex-shrink: 0;
        }
        .composer-name {
            font-weight: 600; font-size: 0.9rem; color: #fff;
        }

        /* Irys upload area */
        .upload-zone {
            border: 1.5px dashed rgba(34,211,238,0.25);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
            background: rgba(34,211,238,0.02);
            position: relative;
        }
        .upload-zone:hover { border-color: var(--cyan); background: var(--cyan-dim); }
        .upload-zone input[type=file] {
            position: absolute; inset: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }
        .upload-zone-label {
            font-size: 0.8rem; color: var(--muted); pointer-events: none;
        }
        .upload-zone-label strong { color: var(--cyan); display: block; font-size: 0.85rem; margin-bottom: 2px; }

        .media-tab-row {
            display: flex; gap: 8px; margin-top: 12px;
        }
        .media-tab {
            flex: 1; padding: 8px; border-radius: 10px; text-align: center;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border); color: var(--muted);
            transition: all 0.15s; background: transparent;
        }
        .media-tab.active { color: var(--cyan); border-color: var(--border-lit); background: var(--cyan-dim); }

        #irys-status {
            font-size: 0.72rem; padding: 8px 12px; border-radius: 8px;
            background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.15);
            color: var(--purple); margin-top: 10px; display: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INPUTS & BUTTONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .field {
            width: 100%; padding: 11px 14px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            outline: none;
            margin-top: 10px;
            resize: none;
            transition: border-color 0.2s;
        }
        .field:focus { border-color: rgba(34,211,238,0.3); }
        .field::placeholder { color: var(--muted); }

        .btn {
            padding: 11px 22px;
            border-radius: 12px;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.18s;
            letter-spacing: 0.3px;
        }
        .btn-primary {
            background: var(--cyan);
            color: #030712;
            width: 100%; margin-top: 12px;
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 6px 24px rgba(34,211,238,0.2); }
        .btn-gold {
            background: var(--gold);
            color: #030712;
            width: 100%; margin-top: 12px;
        }
        .btn-gold:hover { filter: brightness(1.05); transform: translateY(-1px); }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
        }
        .btn-outline:hover { border-color: var(--purple); color: var(--purple); }
        .btn-purple {
            background: var(--purple);
            color: #030712;
            padding: 8px 16px;
            font-size: 0.78rem;
            border-radius: 9px;
        }
        .btn-sm {
            padding: 7px 14px;
            font-size: 0.78rem;
            border-radius: 9px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FEED POSTS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .post-card {
            animation: fadeSlide 0.3s ease both;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .post-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 14px;
        }
        .post-author { font-weight: 600; color: #fff; font-size: 0.9rem; }
        .post-boosted-badge {
            font-family: var(--mono);
            font-size: 0.55rem; font-weight: 700;
            color: var(--gold); background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.25);
            padding: 2px 8px; border-radius: 20px;
            letter-spacing: 1px; text-transform: uppercase;
            margin-left: auto;
        }

        .post-text {
            font-size: 0.93rem; line-height: 1.6; color: var(--text);
            margin-bottom: 14px;
        }

        .post-media {
            width: 100%; border-radius: 16px; overflow: hidden;
            background: #000; margin-bottom: 14px;
            border: 1px solid var(--border);
            max-height: 380px;
            display: flex; justify-content: center; align-items: center;
        }
        .post-media img { width: 100%; max-height: 380px; object-fit: cover; display: block; }
        .post-media iframe { width: 100%; height: 280px; border: none; }

        /* Arweave badge on media */
        .arweave-badge {
            display: inline-flex; align-items: center; gap: 5px;
            font-family: var(--mono); font-size: 0.55rem;
            color: var(--cyan); background: var(--cyan-dim);
            border: 1px solid var(--border-lit);
            border-radius: 6px; padding: 2px 8px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .arweave-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--cyan); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* Post actions */
        .post-actions {
            display: flex; align-items: center; gap: 6px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .action-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 7px 14px; border-radius: 50px;
            font-size: 0.78rem; font-weight: 600;
            cursor: pointer; color: var(--muted);
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            transition: all 0.15s;
        }
        .action-pill:hover { color: var(--cyan); border-color: var(--border-lit); background: var(--cyan-dim); }
        .action-pill.boost:hover { color: var(--gold); border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.08); }
        .action-count { font-family: var(--mono); font-size: 0.72rem; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMMENT TRAY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .comment-tray {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed rgba(255,255,255,0.06);
        }
        .comment-list { max-height: 360px; overflow-y: auto; margin-bottom: 12px; }
        .comment-list::-webkit-scrollbar { width: 3px; }
        .comment-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 3px; }

        .comment-row {
            font-size: 0.85rem; color: #cbd5e1;
            padding: 12px 14px; border-radius: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .comment-row.nested {
            margin-left: 20px;
            border-left: 2px solid rgba(167,139,250,0.2);
            border-radius: 0 12px 12px 0;
            background: rgba(167,139,250,0.03);
        }
        .comment-author { color: var(--gold); font-weight: 700; }
        .comment-meta { font-size: 0.7rem; color: var(--muted); margin-top: 8px; display: flex; gap: 10px; align-items: center; }
        .c-btn {
            font-size: 0.7rem; font-weight: 700; cursor: pointer;
            padding: 3px 10px; border-radius: 6px;
            border: 1px solid var(--border);
            color: var(--muted); background: transparent;
            transition: all 0.12s;
        }
        .c-btn:hover { color: var(--cyan); border-color: var(--border-lit); }
        .c-btn.reply:hover { color: var(--purple); border-color: rgba(167,139,250,0.3); }

        .reply-input-area { display: none; margin-top: 10px; }
        .reply-row { display: flex; gap: 8px; margin-top: 0; }
        .reply-row .field { margin-top: 0; flex: 1; }

        .comment-input-row { display: flex; gap: 8px; }
        .comment-input-row .field { margin-top: 0; flex: 1; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DASHBOARD / CREATOR STUDIO
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
        .stat-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
        }
        .stat-label { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
        .stat-value { font-family: var(--mono); font-size: 1.4rem; font-weight: 700; color: #fff; }
        .stat-value.gold { color: var(--gold); }
        .stat-value.cyan { color: var(--cyan); }
        .stat-sub { font-size: 0.65rem; color: var(--muted); margin-top: 3px; }

        .info-box {
            padding: 14px 16px;
            background: var(--cyan-dim);
            border: 1px solid var(--border-lit);
            border-radius: 12px;
            font-size: 0.8rem; color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .info-box strong { color: var(--cyan); }

        /* Ledger */
        .ledger-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 14px;
        }
        .ledger-cols {
            display: flex; justify-content: space-between;
            padding-bottom: 8px; border-bottom: 1px solid var(--border);
            margin-bottom: 6px;
        }
        .col-label { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }

        .ledger-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); gap: 10px;
        }
        .ledger-row:last-child { border-bottom: none; }
        .ledger-desc { font-size: 0.8rem; color: #94a3b8; flex: 1; line-height: 1.4; }
        .ledger-desc small { display: block; font-size: 0.62rem; color: var(--muted); margin-top: 2px; }
        .ledger-badge {
            font-family: var(--mono); font-size: 0.55rem; font-weight: 700;
            padding: 3px 8px; border-radius: 5px; text-transform: uppercase; letter-spacing: 0.05em;
            width: 72px; text-align: center; display: inline-block; flex-shrink: 0;
        }
        .ledger-badge.earn    { background: rgba(74,222,128,0.12); color: var(--green); }
        .ledger-badge.spend   { background: rgba(248,113,113,0.12); color: var(--red); }
        .ledger-badge.deposit { background: var(--cyan-dim); color: var(--cyan); }
        .ledger-badge.settle  { background: var(--purple-dim); color: var(--purple); }
        .ledger-amount { font-family: var(--mono); font-size: 0.82rem; font-weight: 700; width: 68px; text-align: right; flex-shrink: 0; }
        .ledger-amount.earn    { color: var(--green); }
        .ledger-amount.spend   { color: var(--red); }
        .ledger-amount.neutral { color: var(--muted); }
        .ledger-empty { font-size: 0.75rem; color: var(--muted); padding: 20px 0; text-align: center; }

        /* Admin revenue panel */
        #admin-revenue-panel { display: none; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOKENOMICS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tok-section {
            font-family: var(--mono);
            font-size: 0.58rem; color: var(--gold);
            letter-spacing: 3px; text-transform: uppercase;
            margin: 22px 0 10px;
        }
        .tok-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 11px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 0.88rem;
        }
        .tok-row:last-of-type { border-bottom: none; }
        .tok-label { color: #94a3b8; }
        .tok-value { font-family: var(--mono); font-weight: 700; color: var(--cyan); }
        .tok-note { font-size: 0.75rem; color: var(--muted); line-height: 1.6; margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PAGE / ROUTING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .page { display: none; }
        .page.active { display: block; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #toast {
            position: fixed; bottom: 24px; right: 24px; z-index: 9999;
            background: rgba(15,23,42,0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-lit);
            color: var(--cyan);
            font-family: var(--mono);
            font-size: 0.78rem; font-weight: 700;
            padding: 12px 22px; border-radius: 12px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            letter-spacing: 0.5px;
        }
        #toast.show { opacity: 1; transform: translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MISC
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hidden-post { display: none !important; }
        #load-more-btn { display: none; width: 100%; background: transparent; border: 1px solid var(--border); color: var(--muted); font-size: 0.78rem; letter-spacing: 1px; margin-top: 8px; }
        #load-more-btn:hover { border-color: var(--border-lit); color: var(--cyan); }

        .hash-anchor {
            font-family: var(--mono); font-size: 0.58rem;
            color: rgba(100,116,139,0.5); display: block; margin-top: 10px; letter-spacing: 1px;
        }
        .aptm-indicator { font-family: var(--mono); font-size: 0.65rem; color: var(--cyan); font-weight: 700; text-transform: uppercase; }
        .price-ticker  { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); margin-top: 4px; }
        .balance-note  { font-size: 0.6rem; color: var(--muted); margin-top: 2px; }

        /* Divider */
        .divider { height: 1px; background: var(--border); margin: 16px 0; }

        /* Media preview */
        #media-preview-container {
            display: none; margin-top: 12px;
            border: 1px dashed var(--border-lit);
            border-radius: 14px; overflow: hidden;
            background: #000; text-align: center;
        }
        #media-preview-container .prev-label {
            font-family: var(--mono); font-size: 0.58rem; color: var(--cyan);
            padding: 8px 0 2px; letter-spacing: 1px;
        }
        #preview-img { max-width: 100%; max-height: 220px; display: block; margin: 0 auto; padding-bottom: 8px; }

        /* Scrollbar for comment area */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 4px; }

        /* Loading shimmer */
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.07) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sidebar">
    <div class="logo-wrap">
        <div class="logo-mark">Signal Protocol</div>
        <div class="logo-text">SOCIAL<span>HUB</span></div>
    </div>

    <div class="nav-group">
        <div class="nav-item active" onclick="switchPage('home', this)">
            <span class="nav-icon">â—ˆ</span> Global Feed
        </div>
        <div class="nav-item" onclick="switchPage('earnings', this)">
            <span class="nav-icon">â—†</span> Creator Studio
        </div>
        <div class="nav-item" onclick="switchPage('profile', this)">
            <span class="nav-icon">â—‰</span> My Identity
        </div>
        <div class="nav-item" onclick="switchPage('info', this)">
            <span class="nav-icon">â—</span> Tokenomics
        </div>
    </div>

    <div class="sidebar-foot">
        <div class="foot-label">Active Stars Â· Ledger</div>
        <div class="foot-stars" id="user-stars">0 â˜…</div>
        <div class="divider"></div>
        <div class="foot-label">APTM Vault Â· On-Chain</div>
        <div class="foot-aptm" id="sidebar-aptm-value">0.0000 $APTM</div>
        <div class="foot-rate" id="live-price-display">RATE: $0.3391 / APTM</div>
        <div class="foot-note">Stars power instant interactions. Settle them to move value to your Vault.</div>
        <button class="btn btn-gold" onclick="convertAPTM()" style="font-size:0.8rem; padding:9px 16px;">DEPOSIT $APTM</button>
        <div class="foot-anchors">
            <div class="foot-label">Total Ledger Anchors</div>
            <div style="font-family:var(--mono); font-size:1rem; font-weight:700; color:#fff;" id="total-anchors-display">0</div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN VIEWPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="viewport">
    <div class="topbar">
        <div id="wallet-status" onclick="connectWallet()">â¬¡ CONNECT WALLET</div>
    </div>

    <div id="scroll-area">
    <div id="main-content">

        <!-- â”€â”€ HOME / FEED â”€â”€ -->
        <div id="page-home" class="page active">
            <!-- Compose box -->
            <div class="glass cyan-border" style="margin-bottom:24px;">
                <div class="composer-header">
                    <img id="pb-avatar" class="avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                    <div>
                        <div class="composer-name" id="pb-handle">Anonymous_Creator</div>
                        <div style="font-size:0.7rem; color:var(--muted);">Broadcasting to the network</div>
                    </div>
                </div>

                <textarea id="post-text" class="field" style="min-height:72px; line-height:1.6;" placeholder="What's your signal?"></textarea>

                <!-- Media type tabs -->
                <div class="media-tab-row">
                    <div class="media-tab active" id="tab-url" onclick="setMediaTab('url')">ğŸ”— URL  <span style="font-size:0.65rem; opacity:0.6;">(free upload)</span></div>
                    <div class="media-tab" id="tab-file" onclick="setMediaTab('file')">ğŸ“ File Upload <span style="font-size:0.65rem; opacity:0.6;">(Irys / Arweave)</span></div>
                </div>

                <!-- URL input -->
                <div id="url-input-wrap">
                    <input type="text" id="post-media" class="field" placeholder="Image URL (3.0â˜… + Irys) | Video URL (10.0â˜… + Irys)" oninput="updatePreview(this.value)">
                    <div id="media-preview-container">
                        <div class="prev-label">PREVIEW</div>
                        <img id="preview-img" src="">
                    </div>
                </div>

                <!-- File upload (Irys) -->
                <div id="file-input-wrap" style="display:none;">
                    <div class="upload-zone" id="upload-zone">
                        <input type="file" id="media-file-input" accept="image/*,video/*" onchange="handleFileSelect(this)">
                        <div class="upload-zone-label">
                            <strong>â†‘ Drop or click to upload</strong>
                            Images &amp; Videos stored permanently on Arweave via Irys.<br>
                            <span style="font-size:0.68rem; color:var(--purple);">A tiny storage fee is paid via MetaMask.</span>
                        </div>
                    </div>
                    <div id="file-preview-wrap" style="display:none; margin-top:10px;">
                        <img id="file-preview-img" style="max-width:100%; max-height:200px; border-radius:12px; display:none;">
                        <video id="file-preview-vid" controls style="max-width:100%; border-radius:12px; display:none;"></video>
                        <div id="file-info" style="font-size:0.72rem; color:var(--muted); margin-top:6px;"></div>
                    </div>
                </div>

                <div id="irys-status"></div>
                <div id="post-fee-display" style="font-family:var(--mono); font-size:0.68rem; color:var(--muted); margin-top:10px; text-align:right;"></div>

                <button class="btn btn-primary" onclick="handleBroadcast()">â—ˆ BROADCAST SIGNAL</button>
            </div>

            <div id="feed-items"></div>
            <button id="load-more-btn" class="btn" onclick="showNextPage()">LOAD MORE SIGNALS</button>
        </div>

        <!-- â”€â”€ CREATOR STUDIO â”€â”€ -->
        <div id="page-earnings" class="page">
            <div class="page-heading">Creator <span>Studio</span></div>

            <div class="glass">
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Stars Â· Ledger</div>
                        <div class="stat-value gold" id="creator-revenue-display">0 â˜…</div>
                        <div class="stat-sub balance-note">âš¡ Live from interactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">APTM Vault Â· On-Chain</div>
                        <div class="stat-value cyan aptm-indicator" id="earnings-aptm-value" style="font-size:1rem;">0.0000 $APTM</div>
                        <div class="stat-sub balance-note">ğŸ”’ On-chain balance</div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>How it works:</strong> Stars are used for instant social interactions and are tracked on the internal ledger. Click <strong>Settle to Wallet</strong> to convert your Stars to $APTM on-chain and withdraw.
                </div>

                <button class="btn btn-primary" style="width:auto; padding:13px 28px;" onclick="settleToWallet()">SETTLE TO WALLET â†’</button>
            </div>

            <!-- Ledger -->
            <div class="glass">
                <div class="ledger-header">
                    <div style="font-family:var(--mono); font-size:0.65rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; font-weight:700;">ğŸ“‹ Recent Activity</div>
                    <div style="font-size:0.62rem; color:var(--muted);">Last 10 transactions</div>
                </div>
                <div class="ledger-cols">
                    <span class="col-label" style="flex:1;">Description</span>
                    <span class="col-label" style="width:72px; text-align:center;">Type</span>
                    <span class="col-label" style="width:68px; text-align:right;">Amount</span>
                </div>
                <div id="ledger-list">
                    <div class="ledger-empty">Connect wallet to view transaction history.</div>
                </div>
            </div>

            <!-- Admin Revenue Panel -->
            <div class="glass gold-border" id="admin-revenue-panel">
                <div style="font-family:var(--mono); font-size:0.6rem; color:var(--gold); letter-spacing:2px; text-transform:uppercase; font-weight:700; margin-bottom:4px;">ğŸ” Platform Revenue â€” Admin Only</div>
                <div style="font-size:0.62rem; color:var(--muted); margin-bottom:16px;">Cumulative 20% platform fee from all interactions</div>
                <div style="font-family:var(--mono); font-size:2rem; font-weight:700; color:var(--cyan);" id="admin-revenue-display">0 â˜…</div>
                <div style="font-size:0.62rem; color:var(--muted); margin-top:4px;" id="admin-revenue-count">0 fee events recorded</div>
            </div>
        </div>

        <!-- â”€â”€ PROFILE â”€â”€ -->
        <div id="page-profile" class="page">
            <div class="page-heading">My <span>Identity</span></div>
            <div class="glass">
                <div style="font-size:0.8rem; color:var(--muted); margin-bottom:16px;">Set your display name and avatar. Stored locally â€” shown on all your broadcasts.</div>
                <input type="text" id="handle-input" class="field" placeholder="@Username" style="margin-top:0;">
                <input type="text" id="avatar-input" class="field" placeholder="Avatar Image URL">
                <button class="btn btn-primary" onclick="saveProfile()">SYNC IDENTITY</button>
            </div>
        </div>

        <!-- â”€â”€ TOKENOMICS â”€â”€ -->
        <div id="page-info" class="page">
            <div class="page-heading">Token<span>omics</span></div>
            <div class="glass">
                <div class="tok-section">Broadcast Costs</div>
                <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 â˜…</span></div>
                <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 â˜… + Irys fee</span></div>
                <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 â˜… + Irys fee</span></div>
                <div class="tok-row"><span class="tok-label">Boost Signal to Top</span><span class="tok-value">10.0 â˜…</span></div>

                <div class="tok-section">Interaction Costs</div>
                <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 â˜…</span></div>
                <div class="tok-row"><span class="tok-label">Post a Comment / Reply</span><span class="tok-value">1.0 â˜…</span></div>

                <div class="tok-section">Creator Rewards (80% Payout)</div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Post</span><span class="tok-value">+0.8 â˜…</span></div>
                <div class="tok-row"><span class="tok-label">Receive Comment on your Post</span><span class="tok-value">+0.8 â˜…</span></div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Comment</span><span class="tok-value">+0.8 â˜…</span></div>
                <div class="tok-row"><span class="tok-label">Receive Reply to your Comment</span><span class="tok-value">+0.8 â˜…</span></div>

                <div class="tok-section">Decentralized Storage</div>
                <div class="tok-row"><span class="tok-label">Storage Provider</span><span class="tok-value" style="color:var(--purple);">Irys / Arweave</span></div>
                <div class="tok-row"><span class="tok-label">Developer API Key</span><span class="tok-value" style="color:var(--green);">None Required</span></div>
                <div class="tok-row"><span class="tok-label">Storage Fee Payer</span><span class="tok-value" style="color:#fff;">User via MetaMask</span></div>
                <div class="tok-row"><span class="tok-label">Data Permanence</span><span class="tok-value" style="color:var(--green);">Permanent</span></div>

                <div class="tok-note">
                    <b style="color:#94a3b8;">Protocol Note:</b> The 1.2â˜… base broadcast fee and the 20% interaction tax (0.2â˜… per action) fuel platform infrastructure. Image and Video uploads are stored permanently on Arweave via Irys â€” the tiny storage fee is paid directly by the user via MetaMask, requiring zero backend keys or subscriptions for the developer.
                </div>
            </div>
        </div>

    </div><!-- /main-content -->
    </div><!-- /scroll-area -->
</div><!-- /viewport -->

<div id="toast">SUCCESS</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ENGINE SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš™ï¸  GLOBAL CONFIG â€” single source of truth
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CONFIG = {
        ADMIN_ADDRESS:    "0xe348feDea1850a0c2d4aC0fed3f903774dE1e16A",
        CONTRACT_ADDRESS: "0x42E0A97844ac6623207F2a363aa318E83268910F",
        STARS_PER_5_APTM: 169,
        STAR_USD:         0.01,
        PLATFORM_CUT:     0.2,
        CREATOR_CUT:      0.8,
        FEES: {
            TEXT:  1.2,
            PHOTO: 3.0,
            VIDEO: 10.0,
            BOOST: 10,
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentAptmBalance = "0.0000";
    let starBalance = "0";
    let creatorEarnings = 0;
    let currentAptmPriceUsd = 0.3391;
    let totalAnchors = 0;
    let provider, signer, hubContract;
    let userAddress = "";

    let userHandle = localStorage.getItem('hub_userName') || "Anonymous_Creator";
    let userAvatar = localStorage.getItem('hub_userPic') || "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";

    let visibleCount = 10;
    const pageSize = 10;
    const abi = [
        "function depositAPTM() public payable",
        "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
        "function boostPost(uint256 _oneStarWei) public",
        "function interact(address _recipient, uint256 _oneStarWei) public",
        "function starBalances(address _user) view returns (uint256)",
        "function aptmBalances(address) view returns (uint256)",
        "function totalAnchors() view returns (uint256)",
        "function userWithdraw(uint256 _amountWei) public",
        "function adminWithdraw() public",
        "function PLATFORM_ADMIN() view returns (address)"
    ];

    // â”€â”€ Media tab state â”€â”€
    let mediaTabMode = 'url';   // 'url' | 'file'
    let selectedFile = null;    // File object for Irys upload
    let uploadedArweaveUrl = ""; // final URL after Irys upload

    function setMediaTab(mode) {
        mediaTabMode = mode;
        document.getElementById('tab-url').classList.toggle('active', mode === 'url');
        document.getElementById('tab-file').classList.toggle('active', mode === 'file');
        document.getElementById('url-input-wrap').style.display  = mode === 'url'  ? '' : 'none';
        document.getElementById('file-input-wrap').style.display = mode === 'file' ? '' : 'none';
        updatePostFeeDisplay();
    }

    function updatePostFeeDisplay() {
        const el = document.getElementById('post-fee-display');
        if (!el) return;
        const txt  = document.getElementById('post-text')?.value || '';
        const url  = document.getElementById('post-media')?.value || '';
        let cost = CONFIG.FEES.TEXT.toFixed(1) + 'â˜…';
        if (mediaTabMode === 'file' && selectedFile) {
            const isVid = selectedFile.type.startsWith('video/');
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + 'â˜…  +  Irys storage fee (MetaMask)';
        } else if (url) {
            const isVid = url.includes('mp4') || getYoutubeId(url);
            cost = (isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO).toFixed(1) + 'â˜…';
        }
        el.textContent = 'Est. cost: ' + cost;
    }

    function handleFileSelect(input) {
        selectedFile = input.files[0];
        if (!selectedFile) return;
        uploadedArweaveUrl = "";

        const wrap = document.getElementById('file-preview-wrap');
        const img  = document.getElementById('file-preview-img');
        const vid  = document.getElementById('file-preview-vid');
        const info = document.getElementById('file-info');
        wrap.style.display = 'block';
        img.style.display = 'none';
        vid.style.display = 'none';

        const url = URL.createObjectURL(selectedFile);
        if (selectedFile.type.startsWith('image/')) {
            img.src = url; img.style.display = 'block';
        } else {
            vid.src = url; vid.style.display = 'block';
        }
        const kb = (selectedFile.size / 1024).toFixed(1);
        info.innerHTML = `<span style="color:var(--purple);">â¬¡ ${selectedFile.name}</span>  Â·  ${kb} KB  Â·  Will upload to Arweave via Irys`;
        updatePostFeeDisplay();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // IRYS / ARWEAVE UPLOAD  (no API key required)
    // User pays the tiny fee directly via MetaMask
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function uploadToIrys(file) {
        if (!provider) throw new Error("No wallet connected");

        const irysStatus = document.getElementById('irys-status');
        const show = (msg, color = 'var(--purple)') => {
            irysStatus.style.display = 'block';
            irysStatus.style.color = color;
            irysStatus.textContent = 'â¬¡ Irys: ' + msg;
        };

        try {
            show('Estimating storage feeâ€¦');

            // Load Irys SDK from unpkg
            await loadScript('https://unpkg.com/@irys/sdk@latest/build/browser/index.js');

            const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
            const ethSigner = web3Provider.getSigner();

            // Irys uses "ethereum" provider key. Node URL = public Irys node
            const irys = new window.Irys({
                url: "https://node2.irys.xyz",
                token: "ethereum",
                wallet: { provider: web3Provider, name: "ethersv5" }
            });

            // Estimate cost
            const cost = await irys.getPrice(file.size);
            show(`Storage cost: ${irys.utils.fromAtomic(cost).toFixed(8)} ETH â€” confirm in MetaMaskâ€¦`);

            // Fund if needed (user signs MetaMask tx)
            const balance = await irys.getLoadedBalance();
            if (balance.lt(cost)) {
                show('Funding Irys node (MetaMask)â€¦', 'var(--cyan)');
                await irys.fund(cost.multipliedBy(1.2).integerValue());
                show('Funded! Uploading fileâ€¦');
            } else {
                show('Balance sufficient. Uploadingâ€¦');
            }

            // Upload
            const arrayBuffer = await file.arrayBuffer();
            const receipt = await irys.uploadData(Buffer.from(arrayBuffer), {
                tags: [{ name: "Content-Type", value: file.type }]
            });

            const arweaveUrl = `https://gateway.irys.xyz/${receipt.id}`;
            show(`âœ“ Stored on Arweave: ${receipt.id.slice(0, 12)}â€¦`, 'var(--green)');
            return arweaveUrl;

        } catch (e) {
            // Fallback: try direct Arweave bundler (no SDK)
            console.warn("Irys SDK failed, trying bundlr fallback:", e.message);
            show('SDK unavailable â€” trying bundler fallbackâ€¦');

            try {
                return await uploadViaFetch(file, show);
            } catch (e2) {
                show('Upload failed: ' + e2.message, 'var(--red)');
                throw e2;
            }
        }
    }

    // Fallback: upload via Irys REST API (user funds via MetaMask send)
    async function uploadViaFetch(file, show) {
        show('Requesting upload price from Irysâ€¦');
        const priceRes = await fetch(`https://node2.irys.xyz/price/ethereum/${file.size}`);
        const priceAtomic = await priceRes.text();
        const priceWei = ethers.BigNumber.from(priceAtomic.trim());

        show(`Fee: ${ethers.utils.formatEther(priceWei)} ETH â€” confirm in MetaMaskâ€¦`);

        // Send ETH directly to Irys node as fund tx
        const tx = await signer.sendTransaction({
            to: "0x635D0e5f2Fd7c8f0EA2e09a74d8DA9e84FbFD49C", // Irys node2 ethereum account
            value: priceWei,
        });
        await tx.wait();
        show('Funded! Uploadingâ€¦');

        // Upload the file data
        const arrayBuffer = await file.arrayBuffer();
        const response = await fetch("https://node2.irys.xyz/tx/ethereum", {
            method: "POST",
            headers: { "Content-Type": file.type },
            body: arrayBuffer
        });

        if (!response.ok) throw new Error("Upload response: " + response.status);
        const data = await response.json();
        const arweaveUrl = `https://gateway.irys.xyz/${data.id}`;
        show(`âœ“ Stored: ${data.id.slice(0, 12)}â€¦`, 'var(--green)');
        return arweaveUrl;
    }

    async function loadScript(src) {
        return new Promise((res, rej) => {
            if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
            const s = document.createElement('script');
            s.src = src; s.onload = res; s.onerror = rej;
            document.head.appendChild(s);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRICE ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function getLiveAptmPrice() {
        const poolAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57";
        try {
            if (!provider) return 0.3391;
            const poolContract = new ethers.Contract(poolAddress, [
                "function getReserves() external view returns (uint112, uint112, uint32)"
            ], provider);
            const reserves = await poolContract.getReserves();
            const humanAptm = parseFloat(ethers.utils.formatUnits(reserves[0], 18));
            const humanUsdt = parseFloat(ethers.utils.formatUnits(reserves[1], 18));
            const price = humanUsdt / humanAptm;
            return price > 0 ? price : 0.3391;
        } catch (e) { return 0.3391; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function connectWallet() {
        if (window.ethereum) {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = provider.getSigner();
                hubContract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, abi, signer);

                const statusEl = document.getElementById('wallet-status');
                if (statusEl) statusEl.textContent = 'â¬¡ ' + userAddress.slice(0,6) + 'â€¦' + userAddress.slice(-4);

                await syncData();
                updateUI();
                subscribeToEarnings(userAddress);
                subscribeLedger(userAddress);
                subscribeAdminRevenue(userAddress);
                if (typeof loadGlobalFeed === "function") loadGlobalFeed();
                showToast("Connected & Synced âœ“");
            } catch (err) {
                console.error(err);
                showToast("Connection Failed");
            }
        } else {
            alert("MetaMask not found");
        }
    }

    async function syncData() {
        if (!hubContract || !signer) return;
        try {
            const addr = await signer.getAddress();
            const [balRaw, anchors] = await Promise.all([
                hubContract.aptmBalances(addr),
                hubContract.totalAnchors()
            ]);
            const humanBalance = ethers.utils.formatEther(balRaw);
            currentAptmBalance = humanBalance;
            currentAptmPriceUsd = await getLiveAptmPrice();
            const usdValue = parseFloat(humanBalance) * parseFloat(currentAptmPriceUsd);
            starBalance = Math.floor(usdValue / CONFIG.STAR_USD).toString();
            totalAnchors = anchors.toNumber();

            if (window.db) {
                const userRef = window.fs.doc(window.db, "user_balances", addr.toLowerCase());
                const snap = await window.fs.getDoc(userRef);
                if (!snap.exists()) {
                    await window.fs.setDoc(userRef, { stars: 0, lastSync: Date.now(), address: addr.toLowerCase() });
                } else {
                    await window.fs.updateDoc(userRef, { lastSync: Date.now() });
                }
            }
            updateUI();
        } catch (e) { console.error("Sync Failed:", e); }
    }

    function updateUI() {
        try {
            const sDisp = document.getElementById('user-stars');
            if (sDisp) sDisp.textContent = (starBalance || "0") + " â˜…";

            const aDisp = document.getElementById('sidebar-aptm-value');
            if (aDisp) aDisp.textContent = (currentAptmBalance || "0.0000") + " $APTM";

            const cStars = document.getElementById('creator-revenue-display');
            if (cStars) cStars.textContent = creatorEarnings.toFixed(1) + " â˜…";

            const cAptm = document.getElementById('earnings-aptm-value');
            if (cAptm) cAptm.textContent = (currentAptmBalance || "0.0000") + " $APTM";

            const pDisp = document.getElementById('live-price-display');
            if (pDisp) pDisp.textContent = `RATE: $${parseFloat(currentAptmPriceUsd).toFixed(4)} / APTM`;

            const totDisp = document.getElementById('total-anchors-display');
            if (totDisp) totDisp.textContent = totalAnchors;

            const pbAvatar = document.getElementById('pb-avatar');
            if (pbAvatar) pbAvatar.src = userAvatar;

            const pbHandle = document.getElementById('pb-handle');
            if (pbHandle) pbHandle.textContent = userHandle;
        } catch (e) { console.error("UI Update Error:", e); }
    }

    function saveProfile() {
        const nameVal = document.getElementById('handle-input').value;
        const picVal  = document.getElementById('avatar-input').value;
        if (nameVal && picVal) {
            localStorage.setItem('hub_userName', nameVal);
            localStorage.setItem('hub_userPic', picVal);
            userHandle = nameVal; userAvatar = picVal;
            updateUI(); showToast("Identity Saved âœ“");
            loadGlobalFeed();
        } else {
            alert("Please enter both a name and an image URL");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STAR ECONOMY â€” Firebase balance helpers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function adjustFirebaseBalance(walletAddr, amount) {
        if (!walletAddr || walletAddr === "unknown" || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref = window.fs.doc(window.db, "user_balances", addr);
        try {
            await window.fs.runTransaction(window.db, async (txn) => {
                const snap = await txn.get(ref);
                const current = snap.exists() ? (snap.data().stars || 0) : 0;
                const next = Math.max(0, current + amount);
                txn.set(ref, { stars: next, lastUpdated: Date.now() }, { merge: true });
            });
        } catch (e) { console.error("Balance adjustment failed:", e); }
    }

    function subscribeToEarnings(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const ref = window.fs.doc(window.db, "user_balances", addr);
        window.fs.onSnapshot(ref, (snap) => {
            if (snap.exists()) { creatorEarnings = snap.data().stars || 0; }
            else { creatorEarnings = 0; }
            const cStars = document.getElementById('creator-revenue-display');
            if (cStars) cStars.textContent = creatorEarnings.toFixed(1) + " â˜…";
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSACTION LEDGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function logTransaction(address, type, amount, description) {
        if (!address || !window.db) return;
        const addr = address.toLowerCase();
        window.fs.addDoc(window.fs.collection(window.db, "user_transactions"), {
            address, type, amount, description, timestamp: Date.now()
        }).catch(e => console.warn("logTransaction failed:", e));
    }

    function logPlatformRevenue(sourceAddress, actionType, amount) {
        if (!window.db) return;
        window.fs.addDoc(window.fs.collection(window.db, "platform_revenue"), {
            sourceAddress: (sourceAddress || "unknown").toLowerCase(),
            actionType, amount, timestamp: Date.now()
        }).catch(e => console.warn("logPlatformRevenue failed:", e));
    }

    function subscribeLedger(walletAddr) {
        if (!walletAddr || !window.db) return;
        const addr = walletAddr.toLowerCase();
        const q = window.fs.query(
            window.fs.collection(window.db, "user_transactions"),
            window.fs.where("address", "==", addr),
            window.fs.orderBy("timestamp", "desc")
        );
        const renderLedger = (docs) => {
            const el = document.getElementById('ledger-list');
            if (!el) return;
            if (docs.length === 0) {
                el.innerHTML = `<div class="ledger-empty">No activity yet â€” start interacting!</div>`;
                return;
            }
            el.innerHTML = "";
            docs.slice(0, 10).forEach(tx => {
                const isEarn = tx.type === "earn" || tx.type === "deposit";
                const prefix = isEarn ? "+" : "âˆ’";
                const amountStr = prefix + parseFloat(tx.amount).toFixed(1) + " â˜…";
                const amountClass = isEarn ? "earn" : (tx.type === "settle" ? "neutral" : "spend");
                const badgeLabel = { earn: "Earned", spend: "Spent", deposit: "Deposit", settle: "Settle" }[tx.type] || tx.type;
                const date = new Date(tx.timestamp).toLocaleString([], { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
                const row = document.createElement('div');
                row.className = 'ledger-row';
                row.innerHTML = `
                    <div class="ledger-desc">${tx.description}<small>${date}</small></div>
                    <div style="width:72px; text-align:center; flex-shrink:0;"><span class="ledger-badge ${tx.type}">${badgeLabel}</span></div>
                    <div class="ledger-amount ${amountClass}">${amountStr}</div>`;
                el.appendChild(row);
            });
        };
        window.fs.onSnapshot(q, (snapshot) => {
            const docs = []; snapshot.forEach(d => docs.push(d.data())); renderLedger(docs);
        }, (err) => {
            console.warn("Ledger fallback:", err.message);
            const fallQ = window.fs.query(window.fs.collection(window.db, "user_transactions"), window.fs.where("address", "==", addr));
            window.fs.onSnapshot(fallQ, (snap) => {
                const docs = []; snap.forEach(d => docs.push(d.data())); docs.sort((a,b)=>b.timestamp-a.timestamp); renderLedger(docs);
            });
        });
    }

    function subscribeAdminRevenue(walletAddr) {
        if (!walletAddr || !window.db) return;
        if (walletAddr.toLowerCase() !== CONFIG.ADMIN_ADDRESS.toLowerCase()) return;
        const panel = document.getElementById('admin-revenue-panel');
        if (panel) panel.style.display = 'block';
        const q = window.fs.query(window.fs.collection(window.db, "platform_revenue"), window.fs.orderBy("timestamp", "desc"));
        window.fs.onSnapshot(q, (snapshot) => {
            let total = 0; snapshot.forEach(d => { total += (d.data().amount || 0); });
            const dispEl = document.getElementById('admin-revenue-display');
            const countEl = document.getElementById('admin-revenue-count');
            if (dispEl) dispEl.textContent = total.toFixed(1) + " â˜…";
            if (countEl) countEl.textContent = snapshot.size + " fee events recorded";
        }, (err) => {
            const fallQ = window.fs.collection(window.db, "platform_revenue");
            window.fs.onSnapshot(fallQ, (snap) => {
                let total = 0; snap.forEach(d => { total += (d.data().amount || 0); });
                const dispEl = document.getElementById('admin-revenue-display');
                const countEl = document.getElementById('admin-revenue-count');
                if (dispEl) dispEl.textContent = total.toFixed(1) + " â˜…";
                if (countEl) countEl.textContent = snap.size + " fee events recorded";
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function convertAPTM() {
        currentAptmPriceUsd = await getLiveAptmPrice();
        let amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
        if (amt && hubContract) {
            try {
                showToast(`Depositing ${amt} $APTMâ€¦`);
                const tx = await hubContract.depositAPTM({ value: ethers.utils.parseEther(amt), gasLimit: 150000 });
                await tx.wait();
                const starsReceived = Math.floor(parseFloat(amt) * currentAptmPriceUsd / CONFIG.STAR_USD);
                logTransaction(userAddress, "deposit", starsReceived, `Deposited ${parseFloat(amt).toFixed(2)} $APTM â†’ ${starsReceived} Stars`);
                setTimeout(() => { syncData(); }, 2000);
            } catch (e) { console.error(e); alert("Transaction failed."); }
        }
    }

    async function settleToWallet() {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const addr = await signer.getAddress();
            const rawBalance = await hubContract.aptmBalances(addr);
            const humanAmount = ethers.utils.formatEther(rawBalance);
            let amt = prompt(`Withdraw\nBalance: ${humanAmount} APTM`, humanAmount);
            if (amt && hubContract) {
                showToast("Opening MetaMaskâ€¦");
                const withdrawWei = ethers.utils.parseUnits(parseFloat(amt).toFixed(18), 18);
                const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
                await tx.wait();
                logTransaction(addr, "settle", parseFloat(amt), `Settled ${parseFloat(amt).toFixed(4)} $APTM to wallet`);
                showToast("Success! âœ“");
                syncData();
            }
        } catch (e) { console.error(e); alert("Failed: " + (e.reason || e.message).slice(0, 100)); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FEED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .glass');
        posts.forEach((post, index) => {
            if (index < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const loadMore = document.getElementById('load-more-btn');
        if (loadMore) loadMore.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() { visibleCount += pageSize; refreshFeedVisibility(); }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img = document.getElementById('preview-img');
        if (url && url.startsWith('http')) {
            img.src = url; container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
        updatePostFeeDisplay();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        if (t) {
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    }

    function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        el.classList.add('active');
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BROADCAST (with Irys integration for media)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleBroadcast() {
        const txt = document.getElementById('post-text').value;
        if (!txt || !hubContract) return alert("Write something or connect wallet!");

        let mediaUrl = "";
        let feeAmount = CONFIG.FEES.TEXT;
        let type = 1;

        if (mediaTabMode === 'file' && selectedFile) {
            // File upload path â€” upload to Irys first
            const isVid = selectedFile.type.startsWith('video/');
            feeAmount = isVid ? CONFIG.FEES.VIDEO : CONFIG.FEES.PHOTO;
            type = isVid ? 3 : 2;
            showToast("Uploading to Arweave via Irysâ€¦");
            try {
                mediaUrl = await uploadToIrys(selectedFile);
                showToast("âœ“ Stored on Arweave!");
            } catch (e) {
                return alert("Irys upload failed: " + e.message);
            }
        } else {
            // URL path
            const url = document.getElementById('post-media').value;
            if (url) {
                if (url.includes('mp4') || getYoutubeId(url)) {
                    feeAmount = CONFIG.FEES.VIDEO; type = 3;
                } else {
                    feeAmount = CONFIG.FEES.PHOTO; type = 2;
                }
                mediaUrl = url;
            }
        }

        const feeWei = ethers.utils.parseEther(feeAmount.toString());

        try {
            const userAddr = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            showToast(`Broadcasting ${feeAmount}â˜… Signalâ€¦`);

            let tx;
            if (internalStars.gte(feeWei)) {
                tx = await hubContract.postContent("", type, feeWei, { gasLimit: 500000 });
            } else {
                tx = await hubContract.postContent("", type, feeWei, { value: feeWei, gasLimit: 500000 });
            }
            await tx.wait();
            showToast("Anchored! Syncingâ€¦");

            const postAuthorName = localStorage.getItem('hub_userName') || userHandle;
            const postAuthorPic  = localStorage.getItem('hub_userPic')  || userAvatar;

            const postData = {
                text: txt,
                media: mediaUrl,
                arweave: mediaTabMode === 'file',   // flag to show Arweave badge
                author: postAuthorName,
                authorAddr: userAddr,
                avatar: postAuthorPic,
                timestamp: Date.now(),
                hypes: 0,
                type, feePaid: feeAmount
            };

            await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

            document.getElementById('post-text').value = "";
            document.getElementById('post-media').value = "";
            document.getElementById('irys-status').style.display = 'none';
            selectedFile = null; uploadedArweaveUrl = "";
            showToast("Signal Live! ğŸš€");
            logTransaction(userAddr, "spend", parseFloat(feeAmount), `Paid ${feeAmount}â˜… for Content Broadcast`);
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) {
            console.error(e);
            alert("Broadcast failed. Check your APTM or Stars balance.");
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BOOST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function boostPost(postId) {
        if (!hubContract) return alert("Connect Wallet First");
        try {
            const userAddr = await signer.getAddress();
            const internalStars = await hubContract.aptmBalances(userAddr);
            const boostFee = ethers.utils.parseEther(CONFIG.FEES.BOOST.toString());
            let tx;
            showToast("Preparing 10â˜… Boostâ€¦");
            if (internalStars.gte(boostFee)) {
                tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 });
            } else {
                tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 });
            }
            await tx.wait();
            const postRef = window.fs.doc(window.db, "posts", postId);
            await window.fs.updateDoc(postRef, { timestamp: Date.now(), isBoosted: true });
            showToast("ğŸš€ SIGNAL BOOSTED!");
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { console.error(e); alert("Boost failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HYPE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function hypeElement(recipientAddress, displayId) {
        if (parseInt(starBalance) < 1) return alert("Not enough Stars! Deposit APTM to continue.");
        try {
            const isComment = displayId.startsWith('hc-');
            const entityId  = displayId.replace(isComment ? 'hc-' : 'hp-', '');
            if (isComment) {
                const commentRef = window.fs.doc(window.db, "comments", entityId);
                await window.fs.updateDoc(commentRef, { hypes: window.fs.increment(1) });
            } else {
                const postRef = window.fs.doc(window.db, "posts", entityId);
                await window.fs.updateDoc(postRef, { hypes: window.fs.increment(1) });
            }
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                const earnDesc = isComment ? "Earned 0.8â˜… â€” someone hyped your comment" : "Earned 0.8â˜… â€” someone hyped your post";
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT, earnDesc);
            }
            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            const spendDesc = isComment ? "Spent 1â˜… on a Comment Hype" : "Spent 1â˜… on a Post Hype";
            logTransaction(userAddress, "spend", 1, spendDesc);
            logPlatformRevenue(userAddress, isComment ? "hype_comment" : "hype_post", CONFIG.PLATFORM_CUT);
            const counterEl = document.getElementById(displayId);
            if (counterEl) counterEl.textContent = (parseInt(counterEl.textContent || "0") + 1);
            showToast("Hype Recorded! âœ¨ Creator +0.8â˜…");
        } catch (e) { console.error("Hype Error:", e); showToast("Hype failed."); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleTray(id) {
        const t = document.getElementById(`tray-${id}`);
        if (!t) return;
        t.style.display = t.style.display === 'block' ? 'none' : 'block';
    }

    async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
        if (parseInt(starBalance) < 1) return alert("Not enough Stars! Deposit APTM to continue.");
        const inputId = isReply ? `reply-in-${parentId}` : `input-${postId}`;
        const input = document.getElementById(inputId);
        const commentText = input ? input.value.trim() : "";
        if (!commentText) return;
        try {
            const authorName = localStorage.getItem('hub_userName') || userHandle;
            const authorPic  = localStorage.getItem('hub_userPic')  || userAvatar;
            const commentData = {
                text: commentText, author: authorName,
                authorAddr: userAddress || "unknown", avatar: authorPic,
                postId: String(postId), parentId: parentId || null,
                isReply, timestamp: Date.now(), hypes: 0
            };
            await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);
            if (recipientAddress && recipientAddress !== "unknown") {
                await adjustFirebaseBalance(recipientAddress, CONFIG.CREATOR_CUT);
                logTransaction(recipientAddress, "earn", CONFIG.CREATOR_CUT, "Earned 0.8â˜… â€” someone commented on your content");
            }
            starBalance = Math.max(0, parseInt(starBalance) - 1).toString();
            updateUI();
            logTransaction(userAddress, "spend", 1, isReply ? "Spent 1â˜… on a Reply" : "Spent 1â˜… on a Comment");
            logPlatformRevenue(userAddress, isReply ? "reply" : "comment", CONFIG.PLATFORM_CUT);
            if (input) input.value = "";
            const tray = document.getElementById(`tray-${postId}`);
            if (tray) tray.style.display = 'block';
            showToast("Comment Live! Creator +0.8â˜…");
        } catch (e) { console.error("Comment Error:", e); showToast("Failed."); }
    }

    const _commentListeners = {};

    async function loadComments(postId) {
        const list = document.getElementById(`list-${postId}`);
        if (!list || !window.db) return;
        if (_commentListeners[postId]) return;

        const q = window.fs.query(
            window.fs.collection(window.db, "comments"),
            window.fs.where("postId", "==", String(postId)),
            window.fs.orderBy("timestamp", "asc")
        );

        const renderComments = (snapshot) => {
            list.innerHTML = "";
            const topLevel = []; const repliesMap = {};
            snapshot.forEach((docRef) => {
                const data = { ...docRef.data(), _id: docRef.id };
                if (data.parentId) {
                    if (!repliesMap[data.parentId]) repliesMap[data.parentId] = [];
                    repliesMap[data.parentId].push(data);
                } else { topLevel.push(data); }
            });
            const totalCount = snapshot.size;
            const counterEl = document.getElementById(`cc-${postId}`);
            if (counterEl) counterEl.textContent = totalCount > 0 ? `(${totalCount})` : '';
            if (topLevel.length === 0 && Object.keys(repliesMap).length === 0) {
                list.innerHTML = `<div style="font-size:0.75rem; color:var(--muted); padding:8px;">No comments yet. Be first!</div>`;
                return;
            }
            const renderRow = (comment, isNested = false) => {
                const cId = comment._id;
                const authorAddr = comment.authorAddr || "unknown";
                const hypeCount  = comment.hypes || 0;
                const row = document.createElement('div');
                row.className = 'comment-row' + (isNested ? ' nested' : '');
                row.innerHTML = `
                    <div><span class="comment-author">${comment.author || "Anonymous"}</span>: ${comment.text}</div>
                    <div class="comment-meta">
                        <span class="c-btn" onclick="hypeElement('${authorAddr}', 'hc-${cId}')">â¤ï¸ <span id="hc-${cId}">${hypeCount}</span></span>
                        ${!isNested ? `<span class="c-btn reply" onclick="toggleReplyInput('${cId}')">â†© Reply</span>` : ''}
                    </div>
                    ${!isNested ? `
                    <div class="reply-input-area" id="reply-area-${cId}">
                        <div class="reply-row">
                            <input type="text" class="field" id="reply-in-${cId}" placeholder="Replyâ€¦ (1â˜…)" style="font-size:0.82rem;">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${authorAddr}', '${postId}', true, '${cId}')">SEND</button>
                        </div>
                    </div>` : ''}
                `;
                return row;
            };
            topLevel.forEach(comment => {
                list.appendChild(renderRow(comment, false));
                (repliesMap[comment._id] || []).forEach(reply => list.appendChild(renderRow(reply, true)));
            });
        };

        _commentListeners[postId] = window.fs.onSnapshot(q, renderComments, (err) => {
            console.error("Comment listener error:", err.message);
            const fallbackQ = window.fs.query(
                window.fs.collection(window.db, "comments"),
                window.fs.where("postId", "==", String(postId))
            );
            _commentListeners[postId] = window.fs.onSnapshot(fallbackQ, (snapshot) => {
                const sorted = {
                    forEach: (fn) => {
                        const docs = [];
                        snapshot.forEach(d => docs.push({ ...d, data: () => d.data(), id: d.id }));
                        docs.sort((a, b) => (a.data().timestamp || 0) - (b.data().timestamp || 0));
                        docs.forEach(fn);
                    }, size: snapshot.size
                };
                renderComments(sorted);
            });
        });
    }

    function toggleReplyInput(commentId) {
        const area = document.getElementById(`reply-area-${commentId}`);
        if (!area) return;
        const isOpen = area.style.display === 'block';
        area.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            const inp = document.getElementById(`reply-in-${commentId}`);
            if (inp) setTimeout(() => inp.focus(), 50);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GLOBAL FEED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadGlobalFeed() {
        const feedContainer = document.getElementById('feed-items');
        if (!feedContainer || !window.db) return;

        const q = window.fs.query(window.fs.collection(window.db, "posts"), window.fs.orderBy("timestamp", "desc"));

        window.fs.onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = "";
            Object.keys(_commentListeners).forEach(k => {
                if (typeof _commentListeners[k] === 'function') _commentListeners[k]();
                delete _commentListeners[k];
            });
            snapshot.forEach((docRef) => {
                const post = docRef.data();
                const postId = docRef.id;
                const isMe = (post.authorAddr && userAddress && post.authorAddr.toLowerCase() === userAddress.toLowerCase());
                const localName = localStorage.getItem('hub_userName');
                const localPic  = localStorage.getItem('hub_userPic');
                const displayPic  = (isMe && localPic)  ? localPic  : (post.avatar || "https://api.dicebear.com/7.x/identicon/svg?seed=" + (post.authorAddr || 'anon'));
                const displayName = (isMe && localName) ? localName : (post.author || "Anonymous");

                let mediaHtml = '';
                const ytId = getYoutubeId(post.media || "");
                const arweaveBadge = post.arweave
                    ? `<div style="margin-bottom:8px;"><span class="arweave-badge"><span class="arweave-dot"></span>PERMANENT Â· ARWEAVE</span></div>`
                    : '';

                if (ytId) {
                    mediaHtml = `${arweaveBadge}<div class="post-media"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
                } else if (post.media) {
                    mediaHtml = `${arweaveBadge}<div class="post-media"><img src="${post.media}" loading="lazy"></div>`;
                }

                const item = document.createElement('div');
                item.className = 'glass post-card';
                item.setAttribute('data-id', postId);
                if (post.isBoosted) { item.classList.add('gold-border'); }

                item.innerHTML = `
                    <div class="post-header">
                        <img src="${displayPic}" class="avatar">
                        <div>
                            <div class="post-author">${displayName}</div>
                            <div style="font-size:0.65rem; color:var(--muted); font-family:var(--mono);">${post.authorAddr ? post.authorAddr.slice(0,6)+'â€¦'+post.authorAddr.slice(-4) : 'anon'}</div>
                        </div>
                        ${post.isBoosted ? '<span class="post-boosted-badge">ğŸš€ BOOSTED</span>' : ''}
                    </div>
                    ${mediaHtml}
                    <p class="post-text">${post.text}</p>
                    <div class="post-actions">
                        <div class="action-pill" onclick="hypeElement('${post.authorAddr}', 'hp-${postId}')">â¤ï¸ <span class="action-count" id="hp-${postId}">${post.hypes || 0}</span></div>
                        <div class="action-pill" onclick="toggleTray('${postId}'); loadComments('${postId}')">ğŸ’¬ <span class="action-count">Comments</span> <span id="cc-${postId}" style="color:var(--cyan); font-size:0.7rem;"></span></div>
                        <div class="action-pill boost" style="margin-left:auto;" onclick="boostPost('${postId}')">ğŸš€ <span class="action-count">Boost 10â˜…</span></div>
                    </div>
                    <div class="comment-tray" id="tray-${postId}">
                        <div class="comment-list" id="list-${postId}"></div>
                        <div class="comment-input-row">
                            <input type="text" class="field" style="font-size:0.82rem;" placeholder="Add a comment (1â˜…)â€¦" id="input-${postId}">
                            <button class="btn btn-purple btn-sm" onclick="addComment('${post.authorAddr}', '${postId}')">SEND</button>
                        </div>
                    </div>`;
                feedContainer.appendChild(item);
            });
            if (typeof refreshFeedVisibility === "function") refreshFeedVisibility();
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STARTUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('load', async () => {
        try {
            updateUI();
            const p = await getLiveAptmPrice();
            currentAptmPriceUsd = p;
            if (window.ethereum && window.ethereum.selectedAddress) { await connectWallet(); }
            setTimeout(() => { loadGlobalFeed(); }, 1500);
        } catch (e) { console.error("Startup failed", e); }
    });

    // HEARTBEAT
    setInterval(async () => {
        if (provider && hubContract) {
            try {
                currentAptmPriceUsd = await getLiveAptmPrice();
                await syncData();
            } catch (e) { console.error("Heartbeat failed:", e); }
        }
    }, 30000);
</script>
</body>
</html>
