<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCIAL HUB | DISRUPTOR ALPHA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyANZhaAodV4TvfLk84dzwscI7cSSiwyyv4",
    authDomain: "socialhub-33014.firebaseapp.com",
    projectId: "socialhub-33014",
    storageBucket: "socialhub-33014.firebasestorage.app",
    messagingSenderId: "864088350104",
    appId: "1:864088350104:web:9a5044bd40c6621fa7dfed",
    measurementId: "G-B2C1K1LVGQ"
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Expose db to your other functions
  window.db = db;
  window.fs = { collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, updateDoc, increment };
  
  console.log("Firebase Database Linked!");
</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a;
            --accent-cyan: #00f2ff;
            --accent-purple: #bc00ff;
            --gold: #ffcc00;
            --glass: rgba(15, 15, 25, 0.7);
            --border: rgba(255, 255, 255, 0.12);
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, #1a1033 0%, #05070a 100%);
            color: white; display: flex; height: 100vh; overflow: hidden;
        }

        #sidebar {
            width: 280px; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border); display: flex;
            flex-direction: column; padding: 40px 25px; z-index: 100;
        }

        .logo { font-size: 1.6rem; font-weight: 900; margin-bottom: 40px; letter-spacing: -1px; }
        .logo span { color: var(--accent-cyan); }

        .nav-item {
            padding: 14px 18px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; color: #777; font-weight: 700; transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item.active { background: linear-gradient(90deg, rgba(0,242,255,0.1), transparent); color: var(--accent-cyan); border-left: 3px solid var(--accent-cyan); }

        #viewport { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .top-bar { padding: 20px 50px; display: flex; justify-content: flex-end; align-items: center; position: sticky; top: 0; z-index: 90; background: rgba(5,7,10,0.8); backdrop-filter: blur(10px); }
        #main-content { flex-grow: 1; padding: 0 50px 50px 50px; max-width: 750px; margin: 0 auto; width: 100%; }

        .glass-panel { 
            background: var(--glass); border: 1px solid var(--border); 
            border-radius: 24px; padding: 25px; margin-bottom: 25px; backdrop-filter: blur(10px);
        }
        
        .creator-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .avatar-circle { width: 44px; height: 44px; border-radius: 50%; background: #111; border: 2px solid var(--accent-cyan); object-fit: cover; }

        .wallet-pill { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--accent-cyan); padding: 8px 16px; border-radius: 50px; font-size: 0.7rem; font-weight: 900; color: var(--accent-cyan); cursor: pointer; }

        .action-btn { width: 100%; background: var(--gold); border: none; padding: 12px; border-radius: 12px; font-weight: 900; color: #000; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .input-field { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: white; margin-top: 8px; outline: none; box-sizing: border-box; }

        #media-preview-container { margin-top: 10px; display: none; text-align: center; background: #000; border-radius: 12px; padding: 10px; border: 1px dashed var(--accent-cyan); }
        #preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; }

        .post-media-container { width: 100%; max-height: 400px; border-radius: 18px; overflow: hidden; margin: 15px 0; border: 1px solid #222; background: #000; display: flex; justify-content: center; }
        .post-media-container img, .post-media-container iframe { width: 100%; height: 100%; border: none; }

        .feed-actions { display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; }
        .feed-btn { cursor: pointer; font-size: 0.8rem; font-weight: 800; color: #666; display: flex; align-items: center; gap: 6px; }
        
        .comment-area { margin-top: 15px; padding-top: 15px; display: none; border-top: 1px dashed #222; }
        .comment-list { max-height: 400px; overflow-y: auto; margin-bottom: 10px; padding-right: 10px; }
        
        .comment-row { font-size: 0.85rem; margin-bottom: 15px; color: #bbb; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; position: relative; }
        .comment-meta { font-size: 0.65rem; color: #555; margin-top: 8px; display: flex; gap: 15px; }
        .meta-link { cursor: pointer; color: var(--accent-purple); font-weight: 800; }

        .reply-box { display: none; margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .nested-container { margin-left: 20px; border-left: 1px solid #333; padding-left: 15px; margin-top: 10px; }

        .hash-anchor { font-family: monospace; font-size: 0.6rem; color: #3a3d42; display: block; margin-top: 10px; letter-spacing: 1px; }
        .aptm-indicator { font-size: 0.65rem; color: var(--accent-cyan); font-weight: 800; display: block; margin-top: 2px; text-transform: uppercase; }
        .price-ticker { font-size: 0.55rem; color: #444; margin-top: 5px; font-weight: 800; }

        .tok-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tok-label { color: #888; font-size: 0.9rem; }
        .tok-value { font-weight: 900; color: var(--accent-cyan); }
        .tok-section-title { font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; margin: 25px 0 10px 0; font-weight: 900; text-transform: uppercase; }

        .page { display: none; }
        .page.active { display: block; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--accent-cyan); color: black; padding: 12px 24px; border-radius: 8px; font-weight: 900; opacity: 0; transition: 0.3s; z-index: 1000; pointer-events: none; }

        #load-more-btn { display: none; margin: 20px auto; width: 200px; background: transparent; border: 1px solid #333; color: #666; font-size: 0.7rem; }
        .hidden-post { display: none !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="logo">SOCIAL<span>HUB</span></div>
    <div class="nav-item active" onclick="switchPage('home', this)">üè† Global Feed</div>
    <div class="nav-item" onclick="switchPage('earnings', this)">üíé Creator Studio</div>
    <div class="nav-item" onclick="switchPage('profile', this)">üë§ My Profile</div>
    <div class="nav-item" onclick="switchPage('info', this)">‚ÑπÔ∏è Tokenomics</div>
    <div style="margin-top: auto;">
        <div style="font-size: 0.6rem; color: #444; font-weight: 800; margin-bottom: 5px;">HUB BALANCE</div>
        <div style="font-size: 1.4rem; font-weight: 900; color: var(--gold);" id="user-stars">0 ‚òÖ</div>
        <div class="aptm-indicator" id="sidebar-aptm-value">0.00 $APTM</div>
        <div class="price-ticker" id="live-price-display">RATE: $0.34 / APTM</div>
        <button class="action-btn" onclick="convertAPTM()" id="deposit-btn">DEPOSIT $APTM</button>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <div style="font-size: 0.55rem; color: #444; font-weight: 800;">TOTAL LEDGER ANCHORS</div>
            <div style="font-size: 0.9rem; font-weight: 900; color: #fff;" id="total-anchors-display">0</div>
        </div>
    </div>
</div>

<div id="viewport">
    <div class="top-bar">
        <div id="wallet-status" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</div>
    </div>
    <div id="main-content">
        <div id="page-home" class="page active">
            <div class="glass-panel" style="border: 1px solid var(--accent-cyan);">
                <div class="creator-header">
                    <img id="pb-avatar" class="avatar-circle" src="https://api.dicebear.com/7.x/identicon/svg?seed=Hub">
                    <b id="pb-handle">Anonymous_Creator</b>
                </div>
                <textarea id="post-text" class="input-field" style="min-height: 60px;" placeholder="What's the signal?"></textarea>
                <input type="text" id="post-media" class="input-field" placeholder="Media URL (Image: 3‚òÖ | Video: 10‚òÖ)" oninput="updatePreview(this.value)">
                <div id="media-preview-container">
                    <div style="font-size:0.6rem; color:var(--accent-cyan); margin-bottom:5px;">MEDIA PREVIEW</div>
                    <img id="preview-img" src="">
                </div>
                <button class="action-btn" style="background: var(--accent-cyan);" onclick="handleBroadcast()">BROADCAST SIGNAL</button>
            </div>
            <div id="feed-items"></div>
            <button id="load-more-btn" class="action-btn" onclick="showNextPage()">LOAD MORE SIGNALS</button>
        </div>

        <div id="page-profile" class="page">
            <h1 style="font-weight:900;">Identity Management</h1>
            <div class="glass-panel">
                <input type="text" id="handle-input" class="input-field" placeholder="@Username">
                <input type="text" id="avatar-input" class="input-field" placeholder="Avatar URL">
                <button class="action-btn" onclick="saveProfile()">SYNC IDENTITY</button>
            </div>
        </div>

        <div id="page-earnings" class="page">
            <h1 style="font-weight:900;">Creator Studio</h1>
            <div class="glass-panel">
                <div style="font-size: 0.7rem; color: #888;">NETWORK EARNINGS</div>
                <div style="font-size: 2.5rem; font-weight: 900; color: var(--gold);" id="creator-revenue-display">0 ‚òÖ</div>
                <div class="aptm-indicator" id="earnings-aptm-value" style="font-size: 1rem; margin-bottom: 20px;">EQUIVALENT: 0.00 $APTM</div>
                <button class="action-btn" style="width:auto; padding:15px 30px;" onclick="settleToWallet()">SETTLE TO WALLET</button>
            </div>
        </div>

        <div id="page-info" class="page">
            <h1 style="font-weight:900;">Tokenomics</h1>
            <div class="glass-panel">
                <div class="tok-section-title">Broadcast Costs (Platform Fees)</div>
                <div class="tok-row"><span class="tok-label">Text Signal</span><span class="tok-value">1.2 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Image Signal</span><span class="tok-value">3.0 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Video Signal</span><span class="tok-value">10.0 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label" style="color:var(--accent-cyan)">Boost Signal to Top (Global Placement)</span><span class="tok-value">10.0 ‚òÖ</span></div>

                <div class="tok-section-title">Interaction Mechanics (Costs)</div>
                <div class="tok-row"><span class="tok-label">Hype a Signal</span><span class="tok-value">1.0 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label">Post a Comment / Reply</span><span class="tok-value">1.0 ‚òÖ</span></div>

                <div class="tok-section-title">Creator Rewards (80% Payout)</div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Receive Comment on your Post</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row"><span class="tok-label">Receive Hype on your Comment</span><span class="tok-value">+0.8 ‚òÖ</span></div>
                <div class="tok-row" style="border:none;"><span class="tok-label">Receive Reply to your Comment</span><span class="tok-value">+0.8 ‚òÖ</span></div>

                <div style="margin-top:25px; padding-top:15px; border-top: 1px solid #333; font-size: 0.75rem; color: #666; line-height: 1.5;">
                    <b style="color:#888;">Protocol Note:</b> The 1.2‚òÖ base broadcast fee and the 20% interaction tax (0.2‚òÖ per action) fuel the platform infrastructure and storage on the permanent ledger.
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast">SUCCESS</div>

<script>
    // PART 1: SETUP AND DATA SYNC
const contractAddress = "0x42E0A97844ac6623207F2a363aa318E83268910F";
const abi = [
    "function depositAPTM() public payable",
    "function postContent(string memory _ipfsHash, uint256 _type, uint256 _oneStarWei) public",
    "function boostPost(uint256 _oneStarWei) public",
    "function interact(address _recipient, uint256 _oneStarWei) public",
    "function starBalances(address _user) view returns (uint256)",
    "function aptmBalances(address) view returns (uint256)",
    "function totalAnchors() view returns (uint256)",
    "function userWithdraw(uint256 _amountWei) public",
    "function adminWithdraw() public",
    "function PLATFORM_ADMIN() view returns (address)"
];

let provider, signer, hubContract;
let starBalance = "0";
let totalAnchors = 0; 
let userHandle = "Anonymous_Creator";
let userAvatar = "https://api.dicebear.com/7.x/identicon/svg?seed=Hub";
let visibleCount = 10;
const pageSize = 10;

let currentAptmPriceUsd = 0.3391; 
const STAR_FIXED_USD = 0.01;

function getOneStarWei() {
    const aptmAmount = STAR_FIXED_USD / currentAptmPriceUsd;
    return ethers.utils.parseUnits(aptmAmount.toFixed(18), 18);
}

async function getLiveAptmPrice() {
    const poolAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57";
    const aptmTokenAddress = "0x38AcBfA5108D3c76d6cEa4D380182E832A289b57"; 

    try {
        const poolContract = new ethers.Contract(poolAddress, [
            "function getReserves() external view returns (uint112, uint112, uint32)",
            "function token0() external view returns (address)"
        ], provider);

        const reserves = await poolContract.getReserves();
        const t0 = await poolContract.token0();
        
        let resAptm, resUsdt;

        // DIVIDING BY 1e18 and 1e6 is what kills the 'Trillions' error
        if (t0.toLowerCase() === aptmTokenAddress.toLowerCase()) {
            resAptm = Number(reserves[0]) / 1e18; // Corrects 18 decimals
            resUsdt = Number(reserves[1]) / 1e6;  // Corrects 6 decimals (USDT)
        } else {
            resUsdt = Number(reserves[0]) / 1e6;  
            resAptm = Number(reserves[1]) / 1e18; 
        }

        const priceInUsd = resUsdt / resAptm; // This will be ~0.329
        return priceInUsd; 

    } catch (e) {
        console.error("DEX Error:", e);
        return 0.329; 
    }
}
async function connectWallet() {
    if (window.ethereum) {
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            hubContract = new ethers.Contract(contractAddress, abi, signer);
            const addr = accounts[0];
            document.getElementById('wallet-status').innerText = addr.slice(0,6)+"..."+addr.slice(-4);
            currentAptmPriceUsd = await getLiveAptmPrice();
            syncData();
            showToast("Connected");
        } catch (err) { console.error(err); showToast("Connection Failed"); }
    } else { alert("MetaMask not found"); }
}

// Ensure this is at the top of your script
const STAR_FIXED_USD = 0.01; 

async function syncData() {
    if(!hubContract) return;
    try {
        const addr = await signer.getAddress();
        const balRaw = await hubContract.aptmBalances(addr); 
        const anchors = await hubContract.totalAnchors();
        
        // This will now return ~0.32 (not a trillion)
        currentAptmPriceUsd = await getLiveAptmPrice();

        const aptmInEth = ethers.utils.formatEther(balRaw); // Returns "5.0"
        const totalUsdValue = parseFloat(aptmInEth) * currentAptmPriceUsd; // 5 * 0.32 = 1.60
        
        // 1.60 / 0.01 = 160 Stars
        starBalance = Math.floor(totalUsdValue / STAR_FIXED_USD).toString();
        totalAnchors = anchors.toNumber();
        
        updateUI();
        
        // IMPORTANT: Trigger the comment load AFTER the UI updates
        // This ensures the comments actually show up!
        const allPosts = document.querySelectorAll('.post-card');
        allPosts.forEach(post => {
            const id = post.getAttribute('data-id');
            if(id) loadComments(id);
        });

    } catch (e) { console.error("Sync Error:", e); }
}
function updateUI() {
    let stars = parseFloat(starBalance);
    document.getElementById('user-stars').innerText = stars.toFixed(0) + " ‚òÖ";
    document.getElementById('creator-revenue-display').innerText = stars.toFixed(0) + " ‚òÖ";
    document.getElementById('pb-handle').innerText = userHandle;
    document.getElementById('pb-avatar').src = userAvatar;
    document.getElementById('total-anchors-display').innerText = totalAnchors.toLocaleString();
    document.getElementById('live-price-display').innerText = `RATE: $${currentAptmPriceUsd.toFixed(4)} / APTM`;
    let userAptmValue = (stars * STAR_FIXED_USD) / currentAptmPriceUsd;
    document.getElementById('sidebar-aptm-value').innerText = userAptmValue.toFixed(4) + " $APTM";
    document.getElementById('earnings-aptm-value').innerText = "EQUIVALENT: " + userAptmValue.toFixed(4) + " $APTM";
    refreshFeedVisibility();
}

    async function convertAPTM() {
        currentAptmPriceUsd = await getLiveAptmPrice();
        let amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
        if(amt && hubContract) { 
            try {
                showToast(`Depositing ${amt} $APTM...`);
                const tx = await hubContract.depositAPTM({ 
                    value: ethers.utils.parseEther(amt),
                    gasLimit: 150000 
                });
                await tx.wait();
                setTimeout(() => { syncData(); }, 2000);
            } catch (e) {
                console.error(e);
                alert("Transaction failed. Check console for details.");
            }
        }
    }

    function refreshFeedVisibility() {
        const posts = document.querySelectorAll('#feed-items > .glass-panel');
        posts.forEach((post, index) => {
            if (index < visibleCount) post.classList.remove('hidden-post');
            else post.classList.add('hidden-post');
        });
        const loadMore = document.getElementById('load-more-btn');
        if(loadMore) loadMore.style.display = (posts.length > visibleCount) ? 'block' : 'none';
    }

    function showNextPage() {
        visibleCount += pageSize;
        updateUI();
    }

    function updatePreview(url) {
        const container = document.getElementById('media-preview-container');
        const img = document.getElementById('preview-img');
        if(url && (url.startsWith('http'))) {
            img.src = url;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        el.classList.add('active');
    }

    function saveProfile() {
        userHandle = document.getElementById('handle-input').value || userHandle;
        userAvatar = document.getElementById('avatar-input').value || userAvatar;
        updateUI();
        showToast("Identity Updated");
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // PART 2: ACTIONS & INTERACTIONS
// --- UPDATED ACTIONS & INTERACTIONS ---

async function handleBroadcast() {
    const txt = document.getElementById('post-text').value;
    const media = document.getElementById('post-media').value;
    if(!txt || !hubContract) return alert("Write something or connect wallet!");

    // NEW PRICING LOGIC (100% to Platform)
    let feeAmount = "1.2"; // Default for Text
    let type = 1;

    if (media) {
        // Check if it's a video (mp4 or Youtube)
        if (media.includes('mp4') || getYoutubeId(media)) {
            feeAmount = "10"; 
            type = 3;
        } else {
            // It's an image
            feeAmount = "3"; 
            type = 2;
        }
    }

    // Convert the string amount to Wei for the blockchain
    const feeWei = ethers.utils.parseEther(feeAmount);

    try {
        const userAddr = await signer.getAddress();
        const internalStars = await hubContract.aptmBalances(userAddr);
        
        showToast(`Preparing ${feeAmount} Star Broadcast...`);
        
        let tx;
        // Check internal bank (Stars) first
        if (internalStars.gte(feeWei)) {
            showToast("Using internal Stars fund...");
            tx = await hubContract.postContent("", type, feeWei, { gasLimit: 500000 });
        } else {
            showToast(`Paying ${feeAmount} APTM from Wallet...`);
            tx = await hubContract.postContent("", type, feeWei, { 
                value: feeWei, 
                gasLimit: 500000 
            });
        }

        await tx.wait();
        showToast("Anchored! Syncing to Cloud...");

        // 2. Firebase Save
        const postData = {
            text: txt,
            media: media,
            author: userHandle,
            authorAddr: userAddr,
            avatar: userAvatar,
            timestamp: Date.now(),
            hypes: 0,
            type: type,
            feePaid: feeAmount // Optional: track how much they paid in the cloud
        };

        await window.fs.addDoc(window.fs.collection(window.db, "posts"), postData);

        // 3. Cleanup UI
        document.getElementById('post-text').value = "";
        document.getElementById('post-media').value = "";
        showToast("Post Live!");
        
        setTimeout(() => { syncData(); }, 2000);
    } catch (e) { 
        console.error(e);
        alert("Broadcast failed. Check your APTM or Stars balance."); 
    }
}

// --- CLOUD FEED LISTENER ---

async function addComment(recipientAddress, postId, isReply = false, parentId = null) {
    if (!hubContract) return alert("Connect Wallet First");
    
    const inputId = isReply ? `reply-in-${parentId}` : `input-${postId}`;
    const input = document.getElementById(inputId);
    const commentText = input.value; // Save the text immediately
    if(!commentText) return;

    try {
        const userAddr = await signer.getAddress();
        const internalStars = await hubContract.aptmBalances(userAddr);
        const fee = ethers.utils.parseEther("1"); 
        
        showToast("Authenticating Comment...");
        let tx;

        // 1. Blockchain Part
        if (internalStars.gte(fee)) {
            tx = await hubContract.interact(recipientAddress, fee, { gasLimit: 250000 });
        } else {
            tx = await hubContract.interact(recipientAddress, fee, { value: fee, gasLimit: 250000 });
        }

        // 2. Firebase Part - WE DO THIS AS SOON AS THE TX IS SENT
        // This ensures even if the page refreshes, the data is moving to the cloud
        const commentData = {
            text: commentText,
            author: userHandle,
            authorAddr: userAddr,
            postId: postId,
            parentId: parentId || null,
            isReply: isReply,
            timestamp: Date.now(),
            hypes: 0
        };

        // Don't wait for the tx.wait() to start the cloud save
        await window.fs.addDoc(window.fs.collection(window.db, "comments"), commentData);
        
        await tx.wait(); // Now wait for the blockchain to confirm

        input.value = "";
        showToast("Comment Live!");
        setTimeout(() => { syncData(); }, 1000);
    } catch (e) { 
        console.error("Comment Error:", e);
        showToast("Failed to post. Check connection."); 
    }
}

// --- GLOBAL UTILITIES (Keep your existing ones) ---

async function convertAPTM() {
    currentAptmPriceUsd = await getLiveAptmPrice();
    let amt = prompt(`Deposit $APTM\nPrice: $${currentAptmPriceUsd.toFixed(4)}`, "5");
    if(amt && hubContract) { 
        try {
            showToast(`Depositing ${amt} $APTM...`);
            const tx = await hubContract.depositAPTM({ value: ethers.utils.parseEther(amt), gasLimit: 150000 });
            await tx.wait();
            setTimeout(() => { syncData(); }, 2000);
        } catch (e) { alert("Transaction failed."); }
    }
}

async function settleToWallet() {
    if (!hubContract) return alert("Connect Wallet First");
    try {
        const addr = await signer.getAddress();
        const rawBalance = await hubContract.aptmBalances(addr);
        const humanAmount = ethers.utils.formatEther(rawBalance);
        let amt = prompt(`Withdraw Stars\nBalance: ${humanAmount} APTM`, humanAmount);
        if (amt && hubContract) {
            showToast("Opening MetaMask...");
            const withdrawWei = ethers.utils.parseUnits(parseFloat(amt).toFixed(18), 18);
            const tx = await hubContract.userWithdraw(withdrawWei, { gasLimit: 500000 });
            await tx.wait();
            showToast("Success!");
            syncData();
        }
    } catch (e) { console.error(e); alert("Failed: " + (e.reason || e.message).slice(0, 100)); }
}

function refreshFeedVisibility() {
    const posts = document.querySelectorAll('#feed-items > .glass-panel');
    posts.forEach((post, index) => {
        if (index < visibleCount) post.classList.remove('hidden-post');
        else post.classList.add('hidden-post');
    });
    const loadMore = document.getElementById('load-more-btn');
    if(loadMore) loadMore.style.display = (posts.length > visibleCount) ? 'block' : 'none';
}

function showNextPage() { visibleCount += pageSize; updateUI(); }
function updatePreview(url) {
    const container = document.getElementById('media-preview-container');
    const img = document.getElementById('preview-img');
    if(url && url.startsWith('http')) { img.src = url; container.style.display = 'block'; }
    else { container.style.display = 'none'; }
}
function showToast(m) {
    const t = document.getElementById('toast');
    if(t) { t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }
}
function switchPage(p, el) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    document.getElementById('page-'+p).classList.add('active');
    el.classList.add('active');
}
function saveProfile() {
    userHandle = document.getElementById('handle-input').value || userHandle;
    userAvatar = document.getElementById('avatar-input').value || userAvatar;
    updateUI(); showToast("Identity Updated");
}
function getYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

async function boostPost(postId) {
    if (!hubContract) return alert("Connect Wallet First");
    
    try {
        const userAddr = await signer.getAddress();
        const internalStars = await hubContract.aptmBalances(userAddr);
        
        // SETTING BOOST FEE TO 10 STARS
        const boostFee = ethers.utils.parseEther("10"); 
        
        let tx;
        showToast("Preparing 10-Star Boost...");

        if (internalStars.gte(boostFee)) {
            showToast("Boosting (10 Stars to Platform)...");
            // Uses internal Stars balance
            tx = await hubContract.boostPost(boostFee, { gasLimit: 400000 }); 
        } else {
            showToast("Paying 10 APTM from Wallet...");
            // Triggers MetaMask payment popup for 10 APTM
            tx = await hubContract.boostPost(boostFee, { value: boostFee, gasLimit: 400000 }); 
        }

        await tx.wait();

        // Update Firebase to "Bump" the post to the top
        const postRef = window.fs.doc(window.db, "posts", postId);
        await window.fs.updateDoc(postRef, {
            timestamp: Date.now(),
            isBoosted: true
        });

        showToast("üöÄ POST BOOSTED TO TOP!");
        
        // Refresh balance UI
        setTimeout(() => { syncData(); }, 2000);
    } catch (e) { 
        console.error(e);
        alert("Boost failed. Ensure you have 10 Stars/APTM."); 
    }
}

async function hypeElement(recipientAddress, displayId) {
    if (!hubContract) return alert("Connect Wallet First");
    try {
        const userAddr = await signer.getAddress();
        const internalStars = await hubContract.aptmBalances(userAddr);
        const fee = getOneStarWei();
        
        showToast("Processing Hype...");
        let tx;

        if (internalStars.gte(fee)) {
            // 80% to Creator, 20% to Platform
            tx = await hubContract.interact(recipientAddress, fee, { gasLimit: 400000 });
        } else {
            tx = await hubContract.interact(recipientAddress, fee, { value: fee, gasLimit: 400000 });
        }

        await tx.wait();
        
        // --- NEW: SAVE TO FIREBASE ---
        // We need to find the post in Firebase and increment the 'hypes' count
        // The displayId is usually something like "hp-POST_ID"
        const postId = displayId.replace('hp-', '');
        const postRef = window.fs.doc(window.db, "posts", postId);
        
        await window.fs.updateDoc(postRef, {
            hypes: window.fs.increment(1)
        });
        
        showToast("Hype Recorded on Cloud! ‚ú®");
        setTimeout(() => { syncData(); }, 2000);
    } catch (e) { 
        console.error(e);
        alert("Hype failed. Check Stars balance."); 
    }
}

function toggleTray(id) {
    const t = document.getElementById(`tray-${id}`);
    if(t) t.style.display = t.style.display === 'block' ? 'none' : 'block';
}

function toggleReply(id) {
    const b = document.getElementById(`reply-box-${id}`);
    if(b) b.style.display = b.style.display === 'block' ? 'none' : 'block';
}
    async function loadGlobalFeed() {
    const feedContainer = document.getElementById('feed-items');
    if (!feedContainer || !window.db) return;

    const q = window.fs.query(window.fs.collection(window.db, "posts"), window.fs.orderBy("timestamp", "desc"));

    window.fs.onSnapshot(q, (snapshot) => {
        feedContainer.innerHTML = ""; 
        snapshot.forEach((docRef) => {
            const post = docRef.data();
            const postId = docRef.id;
            
            let mediaHtml = '';
            const ytId = getYoutubeId(post.media || "");
            if(ytId) {
                mediaHtml = `<div class="post-media-container"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>`;
            } else if(post.media) {
                mediaHtml = `<div class="post-media-container"><img src="${post.media}"></div>`;
            }

            const item = document.createElement('div');
            item.className = post.isBoosted ? 'glass-panel boosted-post' : 'glass-panel';
            if(post.isBoosted) item.style.border = "2px solid #FFD700"; 
            
            item.innerHTML = `
                <div class='creator-header'>
                    <img src="${post.avatar || userAvatar}" class="avatar-circle">
                    <b>${post.author}</b>
                </div>
                ${mediaHtml}
                <p>${post.text}</p>
                <div class="feed-actions">
                    <div class="feed-btn" onclick="hypeElement('${post.authorAddr}', 'hp-${postId}')">‚ù§Ô∏è Hype <span id="hp-${postId}">${post.hypes || 0}</span></div>
                    <div class="feed-btn" onclick="toggleTray('${postId}'); loadComments('${postId}')">üí¨ Comments</div>
                    <div class="feed-btn" style="color:#FFD700" onclick="boostPost('${postId}')">üöÄ Boost (10‚òÖ)</div>
                </div>
                <div class="comment-area" id="tray-${postId}">
                    <div class="comment-list" id="list-${postId}"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="input-field" style="margin-top:0;" placeholder="Add (1‚òÖ)" id="input-${postId}">
                        <button class="action-btn" style="margin-top:0; width:80px;" onclick="addComment('${post.authorAddr}', '${postId}')">SEND</button>
                    </div>
                </div>`;
            feedContainer.appendChild(item);
        });
        refreshFeedVisibility();
    });
}


// Function to load the comments inside each post
async function loadComments(postId) {
    const list = document.getElementById(`list-${postId}`);
    if (!list) return;

    console.log("Fetching comments for Post ID:", postId);

    // Using the exact collection name 'comments' from your screenshot
    const q = window.fs.query(
        window.fs.collection(window.db, "comments"),
        window.fs.where("postId", "==", postId)
    );

    window.fs.onSnapshot(q, (snapshot) => {
        list.innerHTML = "";
        if (snapshot.empty) {
            console.log("No comments found in Firebase for this ID.");
            return;
        }

        snapshot.forEach((docRef) => {
            const comment = docRef.data();
            const commentId = docRef.id;
            const row = document.createElement('div');
            row.className = 'comment-row';
            row.style.padding = "10px 0";
            row.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            
            row.innerHTML = `
                <div style="font-size: 0.9em;">
                    <b style="color: #FFD700;">${comment.author}</b>: ${comment.text}
                </div>
                <div class="comment-meta" style="font-size: 0.8em; opacity: 0.6; margin-top:4px;">
                    <span class="meta-link" onclick="hypeElement('${comment.authorAddr}', 'hp-${commentId}')">‚ù§Ô∏è Hype</span>
                    <span class="meta-link" onclick="toggleReply('${commentId}')"> ¬∑ Reply</span>
                </div>`;
            list.appendChild(row);
        });
    });
}

// --- STARTUP ---

window.addEventListener('load', () => {
    if (typeof getLiveAptmPrice === 'function') {
        getLiveAptmPrice().then(p => { currentAptmPriceUsd = p; });
    }
    
    // Connect Wallet if already authorized
    if (window.ethereum && window.ethereum.selectedAddress) connectWallet();
    
    // Wait a second for Firebase to initialize then load feed
    setTimeout(() => { loadGlobalFeed(); }, 1500);
});
</script>
</body>
</html>
